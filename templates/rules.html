<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rules Management - {{ collection_config.name }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-gradient:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
        .rule-card {
            transition: transform 0.2s;
        }
        .rule-card:hover {
            transform: translateY(-2px);
        }
        .rule-type-badge {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }
        .editable-cell {
            cursor: pointer;
            min-height: 30px;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .editable-cell:hover {
            background-color: #f8f9fa;
        }
        .editing {
            background-color: #fff3cd !important;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-dark navbar-custom">
        <div class="container">
            <div class="d-flex align-items-center">
                <a href="/sinks" class="btn btn-outline-light btn-sm me-3">
                    <i class="fas fa-arrow-left"></i> Back to Sinks
                </a>
                <a class="navbar-brand" href="#">
                    <i class="fas fa-cogs me-2"></i>
                    Rules Management - {{ collection_config.name }}
                </a>
            </div>
            <div class="d-flex align-items-center">
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-home"></i> Dashboard
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2>
                    <i class="fas fa-cogs me-2"></i>Standardization Rules
                </h2>
                <p class="text-muted">
                    Configure rules to automatically standardize product data. Rules work by searching for terms in product titles and current field values, then replacing them with standard values.
                </p>
            </div>
        </div>

        <!-- How It Works -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>How Rules Work</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Search Term + Standard Value:</strong><br>
                            Replaces matched terms with the standard value
                        </div>
                        <div class="col-md-4">
                            <strong>Search Term + Blank Standard:</strong><br>
                            Deletes the matched terms from data
                        </div>
                        <div class="col-md-4">
                            <strong>No Search Term Match:</strong><br>
                            Highlights the field for manual review
                        </div>
                    </div>
                    <hr>
                    <p class="mb-0">
                        <strong>Processing Order:</strong> Current field value → Product title → Rules matching
                    </p>
                </div>
            </div>
        </div>

        <!-- Rule Management Cards -->
        <div class="row">
            {% for rule_type in collection_config.rule_types %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card rule-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            {{ rule_type.title() }} Rules
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <span class="rule-type-badge">{{ all_rules[rule_type]|length }} rules configured</span>
                        </div>
                        
                        <!-- Rules Table -->
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Search Term</th>
                                        <th>Standard Value</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="rules-{{ rule_type }}">
                                    {% for search_term, standard_value in all_rules[rule_type].items() %}
                                    <tr>
                                        <td>{{ search_term }}</td>
                                        <td class="editable-cell" onclick="editCell(this, '{{ rule_type }}', '{{ search_term }}')">
                                            {% if standard_value %}
                                                {{ standard_value }}
                                            {% else %}
                                                <em class="text-muted">DELETE</em>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRule('{{ rule_type }}', '{{ search_term }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Add New Rule -->
                        <div class="mt-3">
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" class="form-control" placeholder="Search term" id="new-search-{{ rule_type }}">
                            </div>
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" class="form-control" placeholder="Standard value (blank to delete)" id="new-standard-{{ rule_type }}">
                            </div>
                            <button class="btn btn-sm btn-gradient w-100" onclick="addRule('{{ rule_type }}')">
                                <i class="fas fa-plus me-1"></i> Add Rule
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Rule Examples -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb me-2"></i>Rule Examples
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Installation Type Rules</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr><th>Search Term</th><th>Standard Value</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>UNDERMOUNT</td><td>Undermount</td></tr>
                                            <tr><td>UNDER MOUNT</td><td>Undermount</td></tr>
                                            <tr><td>TOP MOUNT</td><td>Topmount</td></tr>
                                            <tr><td>DROP IN</td><td>Topmount</td></tr>
                                            <tr><td>FARMHOUSE</td><td>Farmhouse</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Material Rules</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr><th>Search Term</th><th>Standard Value</th></tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>304 GRADE</td><td>Stainless Steel</td></tr>
                                            <tr><td>18/10</td><td>Stainless Steel</td></tr>
                                            <tr><td>GRANITE</td><td>Granite</td></tr>
                                            <tr><td>CERAMIC</td><td>Ceramic</td></tr>
                                            <tr><td>CHEAP STEEL</td><td><em>(blank to delete)</em></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Instructions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>Next Steps
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card bg-light h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-edit fa-2x text-primary mb-3"></i>
                                        <h6>1. Configure Rules</h6>
                                        <p class="small">Add search terms and their standard values using the forms above.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-play fa-2x text-success mb-3"></i>
                                        <h6>2. Run Processing</h6>
                                        <p class="small">Go back to the Sinks page and start AI processing to apply rules.</p>
                                        <a href="/sinks" class="btn btn-sm btn-success">
                                            <i class="fas fa-play me-1"></i> Process Data
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-line fa-2x text-info mb-3"></i>
                                        <h6>3. Review Results</h6>
                                        <p class="small">Check your Google Sheet for standardized data and quality scores.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Search Term:</label>
                        <input type="text" class="form-control" id="editSearchTerm" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Standard Value:</label>
                        <input type="text" class="form-control" id="editStandardValue" placeholder="Leave blank to DELETE matched values">
                        <small class="form-text text-muted">This value will replace any matches found. Leave blank to delete matches from data.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-gradient" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentEditRule = null;

        // Add new rule
        function addRule(ruleType) {
            const searchTerm = document.getElementById(`new-search-${ruleType}`).value.trim();
            const standardValue = document.getElementById(`new-standard-${ruleType}`).value.trim();
            
            if (!searchTerm) {
                alert('Please enter a search term.');
                return;
            }
            
            // Save rule via API
            fetch(`/api/rules/sinks/${ruleType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    search_term: searchTerm,
                    standard_value: standardValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add to table
                    const tbody = document.getElementById(`rules-${ruleType}`);
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${searchTerm}</td>
                        <td class="editable-cell" onclick="editCell(this, '${ruleType}', '${searchTerm}')">
                            ${standardValue ? standardValue : '<em class="text-muted">DELETE</em>'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRule('${ruleType}', '${searchTerm}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(newRow);
                    
                    // Clear inputs
                    document.getElementById(`new-search-${ruleType}`).value = '';
                    document.getElementById(`new-standard-${ruleType}`).value = '';
                    
                    // Update badge count
                    updateRuleCount(ruleType);
                    
                    showAlert('Rule added successfully!', 'success');
                } else {
                    showAlert('Error adding rule: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error adding rule', 'danger');
            });
        }

        // Edit cell inline
        function editCell(cell, ruleType, searchTerm) {
            currentEditRule = { ruleType, searchTerm };
            
            const currentValue = cell.textContent.trim();
            const actualValue = currentValue === 'DELETE' ? '' : currentValue;
            
            document.getElementById('editSearchTerm').value = searchTerm;
            document.getElementById('editStandardValue').value = actualValue;
            
            $('#editModal').modal('show');
        }

        // Save edit
        function saveEdit() {
            if (!currentEditRule) return;
            
            const standardValue = document.getElementById('editStandardValue').value.trim();
            
            // Save via API
            fetch(`/api/rules/sinks/${currentEditRule.ruleType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    search_term: currentEditRule.searchTerm,
                    standard_value: standardValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the cell
                    const cells = document.querySelectorAll(`#rules-${currentEditRule.ruleType} td.editable-cell`);
                    cells.forEach(cell => {
                        const row = cell.parentElement;
                        const searchTermCell = row.cells[0];
                        if (searchTermCell.textContent === currentEditRule.searchTerm) {
                            cell.innerHTML = standardValue ? standardValue : '<em class="text-muted">DELETE</em>';
                        }
                    });
                    
                    $('#editModal').modal('hide');
                    showAlert('Rule updated successfully!', 'success');
                } else {
                    showAlert('Error updating rule: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error updating rule', 'danger');
            });
        }

        // Delete rule
        function deleteRule(ruleType, searchTerm) {
            if (!confirm(`Are you sure you want to delete the rule for "${searchTerm}"?`)) {
                return;
            }
            
            // For now, just remove from display (implement API deletion if needed)
            const rows = document.querySelectorAll(`#rules-${ruleType} tr`);
            rows.forEach(row => {
                if (row.cells[0] && row.cells[0].textContent === searchTerm) {
                    row.remove();
                }
            });
            
            updateRuleCount(ruleType);
            showAlert('Rule deleted', 'info');
        }

        // Update rule count badge
        function updateRuleCount(ruleType) {
            const rows = document.querySelectorAll(`#rules-${ruleType} tr`);
            const badges = document.querySelectorAll('.rule-type-badge');
            
            // This is a simple update - in production you'd want to be more specific
            setTimeout(() => {
                location.reload(); // Simple refresh to update counts
            }, 1000);
        }

        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at top of container
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Rules management page loaded');
            
            // Add enter key support for new rule inputs
            document.querySelectorAll('input[id^="new-"]').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const ruleType = this.id.split('-')[2]; // Extract rule type from ID
                        if (this.id.includes('standard')) {
                            addRule(ruleType);
                        } else {
                            // Move to next input
                            const standardInput = document.getElementById(`new-standard-${ruleType}`);
                            standardInput.focus();
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>