<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ collection.name }} - Product Management Dashboard</title>

  <!-- CSS Dependencies -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <style>
    /* Base Styles - Collection Agnostic */
    .navbar-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .btn-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
    }
    .btn-gradient:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      color: white;
    }
    .btn-add-product {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border: none;
      color: white;
    }
    .btn-add-product:hover {
      background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
      color: white;
    }
    .btn-ai-extract {
      background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
      border: none;
      color: white;
    }
    .btn-ai-extract:hover {
      background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
      color: white;
    }
    .btn-ai-description {
      background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
      border: none;
      color: white;
    }
    .btn-ai-description:hover {
      background: linear-gradient(135deg, #e83e8c 0%, #6f42c1 100%);
      color: white;
    }

    /* Statistics Cards */
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      transition: transform 0.2s;
    }
    .stats-card:hover {
      transform: translateY(-2px);
    }
    .missing-info-card {
      background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
      color: white;
      border-radius: 12px;
    }
    .complete-info-card {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border-radius: 12px;
    }

    /* Filter System */
    .filter-tabs {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 20px;
    }
    .filter-btn {
      margin: 2px;
      border-radius: 20px;
      padding: 8px 16px;
      border: none;
      background: white;
      color: #6c757d;
      transition: all 0.3s;
    }
    .filter-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* Product Card Styles - Generic */
    .product-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      overflow: hidden;
      height: 420px;
      position: relative;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .product-card.missing-critical {
      border-left: 4px solid #dc3545;
    }
    .product-card.missing-some {
      border-left: 4px solid #ffc107;
    }
    .product-card.complete {
      border-left: 4px solid #28a745;
    }

    .product-image {
      width: 100%;
      height: 180px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      font-size: 3rem;
      overflow: hidden;
      position: relative;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0;
    }

    .product-details {
      padding: 15px;
      height: 240px;
      display: flex;
      flex-direction: column;
    }

    .product-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      line-height: 1;
      height: 50px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .product-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .product-sku {
      background: #e9ecef;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      color: #495057;
    }

    .product-vendor {
      color: #6c757d;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .product-specs {
      margin-bottom: 12px;
      flex-grow: 1;
    }

    .spec-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 0.85rem;
    }

    .spec-label {
      color: #6c757d;
      font-weight: 500;
    }

    .spec-value {
      color: #495057;
      font-weight: 600;
    }

    .missing-specs {
      color: #dc3545;
      font-style: italic;
    }

    .quality-section {
      margin-bottom: 12px;
    }

    .quality-bar {
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      background-color: #e9ecef;
      margin-bottom: 5px;
    }

    .quality-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    .quality-excellent { background: linear-gradient(90deg, #28a745, #20c997); }
    .quality-good { background: linear-gradient(90deg, #20c997, #17a2b8); }
    .quality-fair { background: linear-gradient(90deg, #ffc107, #fd7e14); }
    .quality-poor { background: linear-gradient(90deg, #fd7e14, #dc3545); }

    .quality-text {
      font-size: 0.8rem;
      color: #6c757d;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .missing-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    .missing-badge {
      background: #dc3545;
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .complete-badge {
      background: #28a745;
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .product-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      opacity: 0.7;
      transition: opacity 0.3s ease;
      z-index: 3;
    }

    .product-card:hover .product-actions {
      opacity: 1;
    }

    .action-btn {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 6px;
      width: 28px;
      height: 28px;
      margin-left: 3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: #495057;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .action-btn:hover {
      background: white;
      color: #007bff;
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .product-checkbox {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 2;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    /* Collection Error Styles */
    .collection-error {
      text-align: center;
      padding: 40px;
      background: #f8f9fa;
      border-radius: 12px;
      margin: 20px;
    }

    .collection-error i {
      font-size: 4rem;
      color: #dc3545;
      margin-bottom: 20px;
    }

    /* Loading Spinner */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    /* Modal Styles */
    .modal-lg {
      max-width: 900px;
    }

    /* Field Group Styles */
    .field-group {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      position: relative;
    }

    .field-group h6 {
      color: #495057;
      margin-bottom: 10px;
      font-weight: 600;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    /* Enhanced Image Gallery Styles */
.image-gallery-container {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
  border: 2px solid #dee2e6;
  position: relative;
  overflow: hidden;
}

.image-gallery-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.image-gallery-title {
  font-weight: 600;
  color: #495057;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.image-count-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

/* Main Image Display */
.main-image-container {
  position: relative;
  width: 100%;
  height: 450px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  margin-bottom: 15px;
  border: 1px solid #dee2e6;
}

.main-image {
  width: 50%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.main-image:hover {
  transform: scale(1.02);
}

.image-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #6c757d;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.image-placeholder i {
  font-size: 3rem;
  margin-bottom: 10px;
  opacity: 0.5;
}

/* Image Navigation Controls */
.image-nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255,255,255,0.9);
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  color: #495057;
  transition: all 0.3s ease;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  z-index: 5;
}

.image-nav-btn:hover {
  background: white;
  color: #667eea;
  transform: translateY(-50%) scale(1.1);
}

.image-nav-btn.prev {
  left: 10px;
}

.image-nav-btn.next {
  right: 10px;
}

.image-nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

/* Image Counter */
.image-counter {
  position: absolute;
  bottom: 10px;
  right: 15px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

/* Thumbnail Gallery */
.thumbnail-gallery {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  padding: 10px 0;
  border-radius: 8px;
  background: rgba(255,255,255,0.5);
}

.thumbnail-gallery::-webkit-scrollbar {
  height: 6px;
}

.thumbnail-gallery::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.thumbnail-gallery::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 3px;
}

.thumbnail-item {
  position: relative;
  flex-shrink: 0;
  width: 80px;
  height: 60px;
  border-radius: 6px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.3s ease;
  background: white;
}

.thumbnail-item:hover {
  border-color: #667eea;
  transform: scale(1.05);
}

.thumbnail-item.active {
  border-color: #667eea;
  box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
}

.thumbnail-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.thumbnail-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  color: #6c757d;
  font-size: 1.2rem;
}

.thumbnail-remove {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 0.7rem;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 10;
}

.thumbnail-item:hover .thumbnail-remove {
  opacity: 1;
}

/* Multiple Image URL Input Section */
.image-url-section {
  background: white;
  border-radius: 8px;
  padding: 15px;
  border: 1px solid #dee2e6;
}

.image-url-item {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  align-items: center;
}

.image-url-item .form-control {
  flex: 1;
}

.image-url-actions {
  display: flex;
  gap: 5px;
}

.btn-add-image {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn-add-image:hover {
  background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
  color: white;
  transform: translateY(-1px);
}

.btn-remove-image {
  background: #dc3545;
  border: none;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.8rem;
  transition: all 0.3s ease;
}

.btn-remove-image:hover {
  background: #c82333;
  transform: translateY(-1px);
}

.btn-test-image {
  background: #17a2b8;
  border: none;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 0.8rem;
  transition: all 0.3s ease;
}

.btn-test-image:hover {
  background: #138496;
  transform: translateY(-1px);
}

/* Error/Success States */
.image-error {
  background: #f8d7da;
  color: #721c24;
  padding: 8px;
  border-radius: 4px;
  margin-top: 5px;
  font-size: 0.8rem;
  display: none;
}

.image-success {
  background: #d4edda;
  color: #155724;
  padding: 8px;
  border-radius: 4px;
  margin-top: 5px;
  font-size: 0.8rem;
  display: none;
}

/* Loading States */
.image-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(248, 249, 250, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.image-loading i {
  font-size: 2rem;
  color: #667eea;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
  .main-image-container {
    height: 200px;
  }

  .thumbnail-item {
    width: 60px;
    height: 45px;
  }

  .image-url-item {
    flex-direction: column;
    align-items: stretch;
  }

  .image-url-actions {
    margin-top: 10px;
  }
}

/* ===============================
   PRICING COMPARISON STYLES (CAPRICE SECTION)
   =============================== */

.pricing-comparison-container {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
  border: 2px solid #dee2e6;
  position: relative;
  overflow: hidden;
}

.pricing-comparison-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.pricing-comparison-title {
  font-weight: 600;
  color: #495057;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.pricing-last-updated {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
}

.pricing-cards-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.pricing-card {
  background: white;
  border-radius: 8px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;
  border: 1px solid #e3e6f0;
}

.pricing-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.pricing-card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.pricing-label {
  font-size: 0.9rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.pricing-amount {
  font-size: 1.5rem;
  font-weight: 700;
  color: #2c3e50;
  margin-bottom: 8px;
}

.competitor-info {
  margin-bottom: 8px;
}

.competitor-name {
  font-size: 0.9rem;
  font-weight: 600;
  color: #495057;
  margin-bottom: 4px;
}

.pricing-difference {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 8px;
}

.pricing-status {
  font-size: 0.8rem;
  color: #6c757d;
  font-weight: 500;
}

/* Card Type Specific Styling */
.our-price-card {
  border-left: 4px solid #28a745;
}

.our-price-card .pricing-amount {
  color: #28a745;
}

.competitor-price-card {
  border-left: 4px solid #17a2b8;
}

.competitor-price-card .pricing-amount {
  color: #17a2b8;
}

.difference-card {
  border-left: 4px solid #6f42c1;
}

/* Price Difference Status Colors */
.price-advantage {
  color: #28a745 !important;
}

.price-disadvantage {
  color: #dc3545 !important;
}

.price-neutral {
  color: #6c757d !important;
}

/* Responsive Design */
@media (max-width: 768px) {
  .pricing-cards-row {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .pricing-comparison-container {
    padding: 16px;
  }

  .pricing-amount {
    font-size: 1.3rem;
  }
}

    /* ===============================
       DIMENSION GROUPS CSS - FIXED
       =============================== */

    /* Dimension Groups */
    .dimension-group {
        background: #ffffff;
        border: 1px solid #e3e6f0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .dimension-group:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    }

    /* Dimension Group Headers */
    .dimension-group-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #f8f9fa;
    }

    .dimension-group-title {
        font-weight: 600;
        font-size: 14px;
        color: #495057;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 8px;
    }

    /* Dimension Grid Layout */
    .dimension-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        align-items: start;
    }

    /* Individual Dimension Items */
    .dimension-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .dimension-label {
        display: flex;
        align-items: center;
        font-size: 12px;
        font-weight: 500;
        color: #6c757d;
        margin-bottom: 0;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    /* Input Groups for Dimensions */
    .dimension-item .input-group {
        border-radius: 6px;
        overflow: hidden;
    }

    .dimension-item .input-group .form-control {
        border-right: none;
        font-weight: 500;
        text-align: center;
    }

    .dimension-item .input-group .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        z-index: 3;
    }

    .dimension-item .input-group-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-size: 11px;
        font-weight: 600;
        min-width: 40px;
        justify-content: center;
    }

/* Spec Sheet Validation Styles */
.spec-valid {
    border: 2px solid #28a745 !important;
    background: rgba(40, 167, 69, 0.1) !important;
    border-radius: 8px !important;
}

.spec-invalid {
    border: 2px solid #dc3545 !important;
    background: rgba(220, 53, 69, 0.1) !important;
    border-radius: 8px !important;
}

.spec-loading {
    border: 2px solid #17a2b8 !important;
    background: rgba(23, 162, 184, 0.1) !important;
    border-radius: 8px !important;
}

.spec-error {
    border: 2px solid #ffc107 !important;
    background: rgba(255, 193, 7, 0.1) !important;
    border-radius: 8px !important;
}

.spec-status-message {
    font-size: 0.8rem;
    margin-top: 8px;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 500;
    animation: fadeIn 0.3s ease-in;
}

.spec-valid .spec-status-message {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.spec-invalid .spec-status-message {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.spec-loading .spec-status-message {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.spec-error .spec-status-message {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

    /* ===============================
       AI ANIMATION STYLES - CRITICAL
       =============================== */

    /* Field Group Processing State */
    .field-group.ai-processing {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)) !important;
      border: 2px solid rgba(102, 126, 234, 0.5) !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3) !important;
      overflow: hidden;
    }

    /* Group Header Animation */
    .ai-label-processing {
      background: linear-gradient(-45deg, #667eea, #764ba2, #667eea, #764ba2) !important;
      background-size: 400% 400% !important;
      animation: gradientShift 2s ease infinite !important;
      color: white !important;
      padding: 6px 12px !important;
      border-radius: 6px !important;
      font-weight: bold !important;
      transition: all 0.3s ease !important;
    }

    /* Individual Field Processing */
    .ai-field-processing {
      position: relative !important;
      border: 2px solid #667eea !important;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.6) !important;
      background: linear-gradient(
        45deg,
        #f8f9fa 25%,
        rgba(102, 126, 234, 0.2) 25%,
        rgba(102, 126, 234, 0.2) 50%,
        #f8f9fa 50%,
        #f8f9fa 75%,
        rgba(102, 126, 234, 0.2) 75%
      ) !important;
      background-size: 30px 30px !important;
      animation: aiBackgroundMove 2s linear infinite !important;
      transition: all 0.3s ease !important;
    }

    /* Field Shimmer Effect */
    .field-shimmer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      z-index: 5;
      pointer-events: none;
      border-radius: 6px;
    }

    .shimmer-line {
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(102, 126, 234, 0.8),
        rgba(118, 75, 162, 0.8),
        transparent
      );
      animation: shimmerSweep 1.5s ease-in-out infinite;
    }

    /* Success States */
    .extraction-success {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.15), rgba(32, 201, 151, 0.15)) !important;
      border: 2px solid #28a745 !important;
      transform: scale(1.02) !important;
      box-shadow: 0 4px 25px rgba(40, 167, 69, 0.4) !important;
      animation: successPulse 1s ease-in-out !important;
    }

    .field-extracted {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1)) !important;
      border: 2px solid #28a745 !important;
      box-shadow: 0 0 15px rgba(40, 167, 69, 0.4) !important;
    }

    .field-cleaned {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)) !important;
      border: 2px solid #667eea !important;
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.4) !important;
    }

    .field-cleaning {
      border: 2px solid #ffc107 !important;
      box-shadow: 0 0 15px rgba(255, 193, 7, 0.5) !important;
      transition: all 0.3s ease !important;
    }

    /* Progress Indicator */
    .ai-progress-indicator {
      position: absolute;
      top: -2px;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      animation: progressFill 3s ease-in-out infinite;
      border-radius: 2px;
      z-index: 10;
    }

    /* Modal Status Badge Animations */
    .badge.bg-warning {
      animation: warningPulse 2s ease-in-out infinite !important;
    }

    .badge.bg-success {
      animation: successGlow 1s ease-in-out !important;
    }

    .badge.bg-info {
      animation: infoPulse 1.5s ease-in-out infinite !important;
    }
    /* ===============================
   TAG DISPLAY STYLES - ADD THIS
   =============================== */

/* Tag Display Styles */
.tags-display {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 8px;
  max-height: 120px;
  overflow-y: auto;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 6px;
  border: 1px solid #dee2e6;
  min-height: 40px;
}

.tags-display:empty::before {
  content: 'Tags will appear here as badges...';
  color: #6c757d;
  font-style: italic;
  font-size: 0.85rem;
}

.tag-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 500;
  white-space: nowrap;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;
  cursor: default;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tag-badge:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* Category-specific colors */
.tag-badge.category-collection {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}
.tag-badge.category-type {
  background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
}
.tag-badge.category-material {
  background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
}
.tag-badge.category-brand {
  background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
}
.tag-badge.category-dimension {
  background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
}
.tag-badge.category-mount {
  background: linear-gradient(135deg, #6610f2 0%, #6f42c1 100%);
}

/* Conditional field hiding */
.conditional-field {
    display: none;
}
.conditional-field.show {
    display: block;
}

    /* ===============================
       KEYFRAME ANIMATIONS
       =============================== */

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes aiBackgroundMove {
      0% { background-position: 0 0; }
      100% { background-position: 30px 30px; }
    }

    @keyframes shimmerSweep {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    @keyframes successPulse {
      0% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
      }
      50% {
        transform: scale(1.02);
        box-shadow: 0 8px 30px rgba(40, 167, 69, 0.5);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
      }
    }

    @keyframes progressFill {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    @keyframes warningPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 5px rgba(255, 193, 7, 0.3);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(255, 193, 7, 0.6);
      }
    }

    @keyframes successGlow {
      0% {
        transform: scale(1);
        box-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.8);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
      }
    }

    @keyframes infoPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 5px rgba(23, 162, 184, 0.3);
      }
      50% {
        transform: scale(1.03);
        box-shadow: 0 0 12px rgba(23, 162, 184, 0.6);
      }
    }

    @keyframes successPop {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.3) rotate(180deg);
        opacity: 1;
      }
      100% {
        transform: scale(1) rotate(360deg);
        opacity: 1;
      }
    }

    @keyframes cleanedPop {
      0% {
        transform: scale(0) rotate(-45deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.2) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    @keyframes cleaningSweep {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
      }

      .product-card {
        height: 380px;
      }

      .product-details {
        height: 200px;
        padding: 12px;
      }

      .filter-tabs {
        overflow-x: auto;
        white-space: nowrap;
      }

      .filter-btn {
        display: inline-block;
        white-space: nowrap;
      }

      .field-shimmer,
      .ai-field-processing {
        animation-duration: 1s;
      }

      .extraction-success {
        transform: scale(1.01);
      }
    }

    /* Content tabs styling */
    .content-tab-container {
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 0.375rem;
      border: 1px solid #dee2e6;
    }

    #contentTabs .nav-link {
      color: #6c757d;
      border: none;
      border-bottom: 2px solid transparent;
      background: none;
      font-weight: 500;
    }

    #contentTabs .nav-link:hover {
      color: #495057;
      border-bottom-color: #dee2e6;
    }

    #contentTabs .nav-link.active {
      color: #0d6efd;
      border-bottom-color: #0d6efd;
      background: none;
    }

    .content-tab-container .btn-primary {
      background: linear-gradient(135deg, #0d6efd, #6610f2);
      border: none;
      box-shadow: 0 2px 4px rgba(13, 110, 253, 0.2);
      transition: all 0.2s ease;
      min-width: 100px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .content-tab-container .btn-primary:hover {
      background: linear-gradient(135deg, #0b5ed7, #520dc2);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
    }

    .content-tab-container textarea {
      border: 1px solid #ced4da;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .content-tab-container textarea:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* Tab content visibility */
    .tab-pane {
      min-height: 200px;
    }

    .tab-pane.active {
      display: block !important;
    }

    .tab-content .tab-pane {
      display: block;
      margin-bottom: 2rem;
    }

    .tab-content .tab-pane:not(.show) {
      display: none;
    }

    .tab-content .tab-pane.show.active {
      display: block !important;
    }

  </style>
</head>
<body class="bg-light">
  <!-- Navigation -->
  <nav class="navbar navbar-dark navbar-custom">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <a href="/" class="btn btn-outline-light btn-sm me-3">
          <i class="fas fa-arrow-left"></i> Dashboard
        </a>
        <a class="navbar-brand d-none d-md-inline" href="#">
          <i class="fas fa-box-open me-2"></i>
          {{ collection.name }}
        </a>
      </div>
      <div class="mx-auto">
        <a class="navbar-brand p-0" href="/">
          <img
            src="https://www.cassbrothers.com.au/cdn/shop/files/Cass_Logo_Black_EPS_ebc641d4-87c9-4619-81f5-8b14d8de1a7b_200x48.svg?v=1724721341"
            alt="Cass Brothers Logo"
            style="height: 48px; max-height: 48px;"
          >
        </a>
      </div>
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-light btn-sm me-2" onclick="refreshData()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <div class="dropdown me-2">
          <button class="btn btn-add-product btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-plus"></i> Add Products
          </button>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus me-2"></i>Add Single Product
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkUploadModal">
                <i class="fas fa-upload me-2"></i>Upload in Bulk
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid mt-4">
    <!-- Collection Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-info-circle me-2"></i>{{ collection.name }}
            </h5>
          </div>
          <div class="card-body">
            <p class="mb-0">{{ collection.description }}</p>
            <div class="mt-2">
              <small class="text-muted">
                AI extracts {{ collection.ai_extraction_fields|length }} fields |
                Total {{ collection.column_mapping|length }} fields in spreadsheet |
                {{ total_urls }} products loaded
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Quality Overview -->
    <div class="row mb-4">
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-boxes fa-2x mb-2"></i>
            <h5 class="card-title">Total Products</h5>
            <h2 class="mb-0" id="totalProducts">{{ total_urls }}</h2>
            <small>in your catalog</small>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card complete-info-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-check-circle fa-2x mb-2"></i>
            <h5 class="card-title">Complete Products</h5>
            <h2 class="mb-0" id="completeProducts">0</h2>
            <small>all fields filled</small>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card missing-info-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <h5 class="card-title">Missing Info</h5>
            <h2 class="mb-0" id="missingInfoProducts">0</h2>
            <small>need attention</small>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-percentage fa-2x mb-2"></i>
            <h5 class="card-title">Data Quality</h5>
            <h2 class="mb-0" id="dataQualityPercent">0%</h2>
            <small>average completeness</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions & Filters -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-filter me-2"></i>Quick Filters & Actions
            </h5>
          </div>
          <div class="card-body">
            <div class="filter-tabs">
              <button class="filter-btn active" onclick="filterProducts('all')" id="filter-all">
                <i class="fas fa-list me-1"></i> All Products
              </button>
              <button class="filter-btn" onclick="filterProducts('missing-critical')" id="filter-missing-critical">
                <i class="fas fa-exclamation-triangle me-1"></i> Missing Critical Info
              </button>
              <button class="filter-btn" onclick="filterProducts('no-sku')" id="filter-no-sku">
                <i class="fas fa-barcode me-1"></i> No SKU
              </button>
              <button class="filter-btn" onclick="filterProducts('complete')" id="filter-complete">
                <i class="fas fa-check-circle me-1"></i> Complete Products
              </button>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-3">
              <button class="btn btn-ai-extract btn-sm" onclick="showAIExtractionModal()">
                <i class="fas fa-robot me-1"></i> AI Extract from URLs
              </button>

              <button class="btn btn-outline-secondary btn-sm" onclick="showImageExtractionModal()">
               <i class="fas fa-images me-1"></i> Extract Images
              </button>

              <button class="btn btn-outline-warning btn-sm" onclick="startDataCleaning()">
                <i class="fas fa-broom me-1"></i> Clean Product Data
              </button>
              <button class="btn btn-ai-description btn-sm" onclick="generateBulkDescriptions()">
                <i class="fas fa-file-alt me-1"></i> Generate Descriptions
              </button>
              <button class="btn btn-outline-primary btn-sm" onclick="exportToCSV()">
                <i class="fas fa-download me-1"></i> Export CSV
              </button>
              <button class="btn btn-outline-success btn-sm" onclick="showBulkEditModal()">
                <i class="fas fa-edit me-1"></i> Bulk Edit
              </button>
              <button class="btn btn-outline-info btn-sm" onclick="generateMissingReport()">
                <i class="fas fa-chart-bar me-1"></i> Quality Report
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Collection -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-th-large me-2"></i>{{ collection.name }} Collection
              <span class="badge bg-secondary ms-2" id="filteredCount">{{ total_urls }} products</span>
            </h5>
            <div class="d-flex gap-2">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="selectAllProducts">
                <label class="form-check-label" for="selectAllProducts">Select All</label>
              </div>
              <div class="input-group" style="width: 300px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" placeholder="Search products..." id="searchInput">
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Loading State -->
            <div class="loading-spinner" id="loadingSpinner">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading products...</span>
              </div>
            </div>

            <!-- Products Grid -->
            <div class="products-grid" id="productsGrid" style="display: none;">
              {% for row_num, url in urls %}
              <div class="product-card" data-row="{{ row_num }}" id="product-card-{{ row_num }}" onclick="editProduct({{ row_num }})">
                <!-- Checkbox -->
                <input type="checkbox" class="form-check-input product-checkbox" data-row="{{ row_num }}" onclick="event.stopPropagation()">

                <!-- Quick Actions -->
                <div class="product-actions">
                  <button class="action-btn" onclick="event.stopPropagation(); extractFromURL({{ row_num }})" title="AI Extract">
                    <i class="fas fa-robot"></i>
                  </button>
                  <button class="action-btn" onclick="event.stopPropagation(); cleanProductData({{ row_num }})" title="Clean Data">
                    <i class="fas fa-broom"></i>
                  </button>
                  <button class="action-btn" onclick="event.stopPropagation(); generateDescription({{ row_num }})" title="Generate Description">
                    <i class="fas fa-file-alt"></i>
                  </button>
                </div>

                <!-- Product Image -->
                <div class="product-image" id="product-image-{{ row_num }}">
                  <i class="fas fa-image"></i>
                </div>

                <!-- Product Details -->
                <div class="product-details">
                  <!-- Title and Meta -->
                  <div class="product-title" id="product-title-{{ row_num }}">Loading...</div>

                  <div class="product-meta">
                    <div class="product-sku" id="product-sku-{{ row_num }}">No SKU</div>
                    <div class="product-vendor" id="product-vendor-{{ row_num }}">-</div>
                  </div>

                  <!-- Dynamic Specifications -->
                  <div class="product-specs" id="product-specs-{{ row_num }}">
                    <div class="spec-row">
                      <span class="spec-label">Loading...</span>
                      <span class="spec-value">-</span>
                    </div>
                  </div>

                  <!-- Quality Section -->
                  <div class="quality-section">
                    <div class="quality-bar">
                      <div class="quality-fill quality-poor" style="width: 0%" id="quality-bar-{{ row_num }}"></div>
                    </div>
                    <div class="quality-text">
                      <span id="quality-text-{{ row_num }}">0% complete</span>
                      <i class="fas fa-edit text-muted"></i>
                    </div>
                  </div>

                  <!-- Missing Info Badges -->
                  <div class="missing-badges" id="missing-badges-{{ row_num }}">
                    <span class="missing-badge">Loading...</span>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <!-- Error State -->
            <div class="collection-error" id="errorState" style="display: none;">
              <i class="fas fa-exclamation-triangle"></i>
              <h4>Unable to Load Products</h4>
              <p id="errorMessage">An error occurred while loading products from this collection.</p>
              <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt me-1"></i> Try Again
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Edit Product Modal - Collection Agnostic -->
  <div class="modal fade edit-modal" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center">
            <i class="fas fa-edit me-2"></i>Edit Product - <span id="editProductTitle">Product</span>
            <span id="modalStatusBadge" class="badge bg-secondary ms-3" style="display: none;">Ready</span>
          </h5>
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-outline-info btn-sm" onclick="openCompareWindow()" id="compareBtn" title="Compare with supplier website">
              <i class="fas fa-external-link-alt me-1"></i> Compare
            </button>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">

  <!-- CAPRICE SECTION - PRICING COMPARISON -->
<div class="pricing-comparison-container" id="pricingComparisonSection" style="display: none;">
  <div class="pricing-comparison-header">
    <h6 class="pricing-comparison-title">
      <i class="fas fa-tags"></i>
      Pricing Intelligence
    </h6>
    <span class="pricing-last-updated" id="pricingLastUpdated">Updated today</span>
  </div>

  <div class="pricing-cards-row">
    <!-- Our Price Card -->
    <div class="pricing-card our-price-card">
      <div class="pricing-card-header">
        <i class="fas fa-store"></i>
        <span class="pricing-label">Our Price</span>
      </div>
      <div class="pricing-amount" id="ourCurrentPrice">$0.00</div>
      <div class="pricing-status" id="ourPriceStatus">Current pricing</div>
    </div>

    <!-- Competitor Price Card -->
    <div class="pricing-card competitor-price-card">
      <div class="pricing-card-header">
        <i class="fas fa-eye"></i>
        <span class="pricing-label">Following</span>
      </div>
      <div class="competitor-info">
        <div class="competitor-name" id="competitorName">Competitor</div>
        <div class="pricing-amount" id="competitorPrice">$0.00</div>
      </div>
      <div class="pricing-status" id="competitorStatus">Competitor pricing</div>
    </div>

    <!-- Price Difference Card -->
    <div class="pricing-card difference-card">
      <div class="pricing-card-header">
        <i class="fas fa-balance-scale"></i>
        <span class="pricing-label">Position</span>
      </div>
      <div class="pricing-difference" id="priceDifference">$0.00</div>
      <div class="pricing-status" id="differenceStatus">vs competitor</div>
    </div>
  </div>
</div>


          <!-- Product Image Display -->
          <div class="image-gallery-container mb-4">
            <div class="image-gallery-header">
                <h6 class="image-gallery-title">
                    <i class="fas fa-images"></i>
            Product Images
                </h6>
                <span class="image-count-badge" id="modalImageCountBadge">0 images</span>
            </div>

  <!-- Main Image Display -->
            <div class="main-image-container" id="modalMainImageContainer">
                <div class="image-placeholder" id="modalImagePlaceholder">
                <i class="fas fa-image"></i>
                <span>No images uploaded</span>
                </div>

    <!-- Navigation buttons -->
                <button class="image-nav-btn prev" id="modalPrevImageBtn" onclick="navigateModalImage(-1)" style="display: none;">
                <i class="fas fa-chevron-left"></i>
                </button>
                <button class="image-nav-btn next" id="modalNextImageBtn" onclick="navigateModalImage(1)" style="display: none;">
                  <i class="fas fa-chevron-right"></i>
                </button>

    <!-- Image counter -->
                <div class="image-counter" id="modalImageCounter" style="display: none;">
                  1 / 1
                </div>
              </div>

  <!-- Thumbnail Gallery -->
  <div class="thumbnail-gallery" id="modalThumbnailGallery" style="display: none;">
    <!-- Thumbnails will be dynamically added here -->
  </div>
</div>

          <form id="editProductForm">
            <!-- Basic Information -->
            <div class="field-group" id="basicInfoGroup">
              <h6><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label">SKU *</label>
                  <div class="position-relative">
                    <input type="text" class="form-control" id="editSku" placeholder="Product SKU">
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Title *</label>
                  <div class="position-relative">
                    <input type="text" class="form-control" id="editTitle" placeholder="Product Title">
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Vendor</label>
                  <div class="position-relative">
                    <input type="text" class="form-control" id="editVendor" placeholder="Vendor Name">
                  </div>
                </div>
                <div class="col-12">
                    <label class="form-label fw-bold">
                        <i class="fas fa-images me-2"></i>
                        Product Images
                    </label>

                    <div class="image-url-section">
                        <div id="modalImageUrlContainer">
                        <!-- First URL input (always present) -->
                        <div class="image-url-item" data-index="0">
                            <input type="url" class="form-control" placeholder="https://example.com/image.jpg" onchange="handleModalImageUrlChange(0)">
                            <div class="image-url-actions">
                            <button type="button" class="btn-test-image" onclick="testModalImageUrl(0)">
                                <i class="fas fa-eye"></i> Test
                             </button>
                            </div>
                            <div class="image-error" id="modalImageError0"></div>
                            <div class="image-success" id="modalImageSuccess0"></div>
                        </div>
                        </div>

                        <!-- Add New Image Button -->
                        <button type="button" class="btn-add-image mt-2" onclick="addNewModalImageUrl()">
                        <i class="fas fa-plus me-1"></i> Add New Image URL
                        </button>


                        </div>
                    </div>
                    </div>

            <!-- Dynamic Product Details Section -->
            <div class="field-group" id="productDetailsGroup">
              <h6>
                <i class="fas fa-tag me-2"></i>Product Details
                <button type="button" class="btn btn-ai-extract btn-sm" onclick="extractSingleProductWithStatus(event)" style="font-size: 0.75rem; padding: 4px 8px;">
                  <i class="fas fa-robot me-1"></i> AI Extract This Product
                </button>
              </h6>
              <div class="clearfix"></div>
              <div id="dynamicProductFields">
                <!-- Fields will be dynamically populated based on collection type -->
              </div>
            </div>

            <!-- Dimensions Section -->
            <div class="field-group" id="dimensionsGroup">
              <h6><i class="fas fa-ruler me-2"></i>Dimensions</h6>
              <div id="dynamicDimensionFields">
                <!-- Dimension fields will be dynamically populated -->
              </div>
            </div>

            <!-- E-commerce Information -->
            <div class="field-group" id="ecommerceGroup">
              <h6><i class="fas fa-shopping-cart me-2"></i>E-commerce Information</h6>
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label">RRP Price ($)</label>
                  <div class="position-relative">
                    <input type="number" step="0.01" class="form-control" id="editRrpPrice" placeholder="Recommended Retail Price">
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Sale Price ($)</label>
                  <div class="position-relative">
                    <input type="number" step="0.01" class="form-control" id="editSalePrice" placeholder="Current Sale Price">
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Weight (kg)</label>
                  <div class="position-relative">
                    <input type="number" step="0.1" class="form-control" id="editWeight" placeholder="Product Weight">
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">Tags</label>
                  <div class="position-relative">
                    <input type="text" class="form-control" id="editTags" placeholder="Comma separated tags">
                    <div class="tags-display" id="tagsDisplay"></div>
                  </div>
                  <div class="form-text">Separate tags with commas - they will appear as badges below</div>
                </div>
                <div class="col-12">
                  <label class="form-label">SEO Title</label>
                  <div class="position-relative">
                    <input type="text" class="form-control" id="editSeoTitle" placeholder="SEO optimized title">
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">SEO Description</label>
                  <div class="position-relative">
                    <textarea class="form-control" id="editSeoDescription" rows="2" placeholder="SEO meta description"></textarea>
                  </div>
                </div>
              </div>
            </div>

            <!-- Content Section -->
            <!-- Content Section -->
        <!-- Product Content Tabs -->
        <div class="field-group" id="contentGroup">
          <h6><i class="fas fa-file-text me-2"></i>Product Content</h6>

          <!-- Content Tabs Navigation -->
          <ul class="nav nav-tabs mb-3" id="contentTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description-content" type="button" role="tab" aria-controls="description-content" aria-selected="true">
                <i class="fas fa-file-text me-1"></i>Description
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="features-tab" data-bs-toggle="tab" data-bs-target="#features-content" type="button" role="tab" aria-controls="features-content" aria-selected="false">
                <i class="fas fa-star me-1"></i>Key Features
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="care-tab" data-bs-toggle="tab" data-bs-target="#care-content" type="button" role="tab" aria-controls="care-content" aria-selected="false">
                <i class="fas fa-hand-sparkles me-1"></i>Care Instructions
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="faqs-tab" data-bs-toggle="tab" data-bs-target="#faqs-content" type="button" role="tab" aria-controls="faqs-content" aria-selected="false">
                <i class="fas fa-question-circle me-1"></i>FAQs
              </button>
            </li>
          </ul>

          <!-- Content Tabs Content -->
          <div class="tab-content" id="contentTabsContent">

            <!-- Product Description Tab -->
            <div class="tab-pane fade show active" id="description-content" role="tabpanel" aria-labelledby="description-tab">
              <div class="content-tab-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <label class="form-label mb-0">
                    <i class="fas fa-file-text me-2"></i>Product Description (HTML)
                  </label>
                  <button type="button" class="btn btn-primary btn-sm" onclick="generateTabContent('description')">
                    <i class="fas fa-magic me-1"></i>Generate
                  </button>
                </div>
                <textarea class="form-control" id="editBodyHtml" rows="8" placeholder="HTML product description will be generated based on product specifications and features"></textarea>
                <small class="form-text text-muted mt-2">
                  <i class="fas fa-info-circle me-1"></i>
                  Generates compelling HTML product description using product data, specifications, and features.
                </small>
              </div>
            </div>

            <!-- Key Features Tab -->
            <div class="tab-pane fade" id="features-content" role="tabpanel" aria-labelledby="features-tab">
              <div class="content-tab-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <label class="form-label mb-0">
                    <i class="fas fa-star me-2"></i>Key Features & Benefits
                  </label>
                  <button type="button" class="btn btn-primary btn-sm" onclick="generateTabContent('features')">
                    <i class="fas fa-magic me-1"></i>Generate
                  </button>
                </div>
                <textarea class="form-control" id="editFeatures" rows="8" placeholder="Key product features and benefits will be generated from product specifications"></textarea>
                <small class="form-text text-muted mt-2">
                  <i class="fas fa-info-circle me-1"></i>
                  Generates 5-7 compelling product features highlighting benefits and unique selling points.
                </small>
              </div>
            </div>

            <!-- Care Instructions Tab -->
            <div class="tab-pane fade" id="care-content" role="tabpanel" aria-labelledby="care-tab">
              <div class="content-tab-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <label class="form-label mb-0">
                    <i class="fas fa-hand-sparkles me-2"></i>Care & Maintenance Instructions
                  </label>
                  <button type="button" class="btn btn-primary btn-sm" onclick="generateTabContent('care')">
                    <i class="fas fa-magic me-1"></i>Generate
                  </button>
                </div>
                <textarea class="form-control" id="editCareInstructions" rows="8" placeholder="Product care and maintenance instructions will be generated based on material and product type"></textarea>
                <small class="form-text text-muted mt-2">
                  <i class="fas fa-info-circle me-1"></i>
                  Generates specific care instructions based on product materials and usage requirements.
                </small>
              </div>
            </div>

            <!-- FAQs Tab -->
            <div class="tab-pane fade" id="faqs-content" role="tabpanel" aria-labelledby="faqs-tab">
              <div class="content-tab-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <label class="form-label mb-0">
                    <i class="fas fa-question-circle me-2"></i>Frequently Asked Questions
                  </label>
                  <button type="button" class="btn btn-primary btn-sm" onclick="generateTabContent('faqs')">
                    <i class="fas fa-magic me-1"></i>Generate
                  </button>
                </div>
                <textarea class="form-control" id="editFaqs" rows="8" placeholder="Product-specific FAQs will be generated based on specifications, features, and installation details"></textarea>
                <small class="form-text text-muted mt-2">
                  <i class="fas fa-info-circle me-1"></i>
                  Generates relevant Q&As covering installation, compatibility, dimensions, and maintenance.
                </small>
              </div>
            </div>

          </div>
        </div>

            <input type="hidden" id="editRowNum" value="">
            <input type="hidden" id="editCollectionName" value="">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning" onclick="cleanCurrentProductDataWithStatus()" id="cleanCurrentDataBtn">
            <i class="fas fa-broom me-1"></i> Clean Data
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveProductChanges()">
            <i class="fas fa-save me-1"></i> Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-plus me-2"></i>Add New Product
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addProductForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Product URL</label>
                <input type="url" class="form-control" id="newProductUrl" placeholder="https://...">
                <div class="form-text">Add URL to auto-extract product data with AI</div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">SKU *</label>
                <input type="text" class="form-control" id="newProductSku" required>
              </div>
              <div class="col-md-8 mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" id="newProductTitle" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">Vendor</label>
                <input type="text" class="form-control" id="newProductVendor">
              </div>
              <div id="dynamicNewProductFields"></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-ai-extract" onclick="addProductWithAI()">
            <i class="fas fa-robot me-1"></i> Add & Extract with AI
          </button>
          <button type="button" class="btn btn-add-product" onclick="addProductManually()">
            <i class="fas fa-save me-1"></i> Add Product
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Upload Modal -->
  <div class="modal fade" id="bulkUploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-upload me-2"></i>Bulk Upload Product SKUs
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-12 mb-4">
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Instructions:</strong> Enter product SKUs below, one per line.
              </div>
            </div>

            <div class="col-12 mb-4">
              <label for="bulkSkuInput" class="form-label">
                <strong>Product SKUs</strong>
                <span class="text-muted">(one per line)</span>
              </label>
              <textarea
                class="form-control"
                id="bulkSkuInput"
                rows="10"
                placeholder="SKU-001&#10;SKU-002&#10;SKU-003&#10;...or paste from spreadsheet"
                style="font-family: 'Courier New', monospace;"
              ></textarea>
              <div class="form-text">
                <span id="skuCount">0</span> SKUs entered
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="startBulkUpload()">
            <i class="fas fa-upload me-1"></i> Upload SKUs
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Image Extraction Modal -->
<div class="modal fade" id="imageExtractionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-images me-2"></i>AI Image Extraction
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>AI Image Extraction:</strong> This will take screenshots of product pages and use ChatGPT Vision to analyze and extract image data. Results will be saved to an "Extracted Images" sheet.
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Extraction Method</label>
            <select class="form-select" id="imageExtractionMethod">
              <option value="selected">Selected Products Only</option>
              <option value="single_url">Single URL</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Selected Products</label>
            <input type="text" class="form-control" id="selectedProductCount" readonly>
          </div>
        </div>

        <!-- Single URL Input (hidden by default) -->
        <div id="singleUrlSection" style="display: none;">
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Product URL</label>
              <input type="url" class="form-control" id="singleImageUrl" placeholder="https://example.com/product-page">
            </div>
          </div>
        </div>

        <!-- Progress Section -->
        <div id="imageExtractionProgress" style="display: none;">
          <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%" id="imageProgressBar">
              0%
            </div>
          </div>
          <div id="imageExtractionStatus">Preparing extraction...</div>
        </div>

        <!-- Results Section -->
        <div id="imageExtractionResults" style="display: none;">
          <h6>Extraction Results</h6>
          <div id="imageResultsContent"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="startImageExtraction()" id="startImageExtractionBtn">
          <i class="fas fa-play me-1"></i> Start Extraction
        </button>
      </div>
    </div>
  </div>
</div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===============================
    // GLOBAL VARIABLES
    // ===============================
    const COLLECTION_NAME = '{{ collection_name }}';
    const COLLECTION_CONFIG = {{ collection|tojson }};
    let productsData = {};
    let currentFilter = 'all';
    let selectedProducts = [];
    const totalProducts = {{ total_urls }};

    console.log('🚀 Collection Page Loaded:', COLLECTION_NAME);
    console.log('📊 Collection Config:', COLLECTION_CONFIG);

// ===============================
// CAPRICE (PRICING COMPARISON) CONFIGURATION
// ===============================
const PRICING_FIELD_MAPPINGS = {
  ourPrice: 'our_current_price',        // Adjust to match your Google Sheet column name
  competitorName: 'competitor_name',     // Adjust to match your Google Sheet column name
  competitorPrice: 'competitor_price',   // Adjust to match your Google Sheet column name
  lastUpdated: 'price_last_updated'      // Adjust to match your Google Sheet column name
};

// ===============================
// CAPRICE (PRICING COMPARISON) FUNCTIONS
// ===============================
function populatePricingComparison(data) {
  console.log('💰 CAPRICE: Populating pricing comparison...', data);

  const pricingSection = document.getElementById('pricingComparisonSection');

  // Check if we have pricing data
  const ourPrice = data[PRICING_FIELD_MAPPINGS.ourPrice];
  const competitorName = data[PRICING_FIELD_MAPPINGS.competitorName];
  const competitorPrice = data[PRICING_FIELD_MAPPINGS.competitorPrice];
  const lastUpdated = data[PRICING_FIELD_MAPPINGS.lastUpdated];

  if (!ourPrice && !competitorPrice) {
    console.log('💰 CAPRICE: No pricing data available, hiding section');
    pricingSection.style.display = 'none';
    return;
  }

  // Show pricing section
  pricingSection.style.display = 'block';

  // Populate our price
  const ourPriceEl = document.getElementById('ourCurrentPrice');
  const ourPriceStatusEl = document.getElementById('ourPriceStatus');
  if (ourPrice) {
    ourPriceEl.textContent = formatPrice(ourPrice);
    ourPriceStatusEl.textContent = 'Current pricing';
  } else {
    ourPriceEl.textContent = 'Not set';
    ourPriceStatusEl.textContent = 'Todays price';
  }

  // Populate competitor info
  const competitorNameEl = document.getElementById('competitorName');
  const competitorPriceEl = document.getElementById('competitorPrice');
  const competitorStatusEl = document.getElementById('competitorStatus');

  if (competitorName && competitorPrice) {
    competitorNameEl.textContent = competitorName;
    competitorPriceEl.textContent = formatPrice(competitorPrice);
    competitorStatusEl.textContent = 'Competitor pricing';
  } else {
    competitorNameEl.textContent = 'No competitor';
    competitorPriceEl.textContent = 'N/A';
    competitorStatusEl.textContent = 'No competitor data';
  }

  // Calculate and display price difference
  const priceDifferenceEl = document.getElementById('priceDifference');
  const differenceStatusEl = document.getElementById('differenceStatus');

  if (ourPrice && competitorPrice) {
    const ourPriceNum = parseFloat(ourPrice);
    const competitorPriceNum = parseFloat(competitorPrice);
    const difference = ourPriceNum - competitorPriceNum;
    const percentage = ((difference / competitorPriceNum) * 100).toFixed(1);

    if (difference > 0) {
      priceDifferenceEl.textContent = `+${formatPrice(Math.abs(difference))}`;
      priceDifferenceEl.className = 'pricing-difference price-disadvantage';
      differenceStatusEl.textContent = `${percentage}% higher`;
    } else if (difference < 0) {
      priceDifferenceEl.textContent = `-${formatPrice(Math.abs(difference))}`;
      priceDifferenceEl.className = 'pricing-difference price-advantage';
      differenceStatusEl.textContent = `${Math.abs(percentage)}% lower`;
    } else {
      priceDifferenceEl.textContent = formatPrice(0);
      priceDifferenceEl.className = 'pricing-difference price-neutral';
      differenceStatusEl.textContent = 'Same price';
    }
  } else {
    priceDifferenceEl.textContent = 'N/A';
    priceDifferenceEl.className = 'pricing-difference price-neutral';
    differenceStatusEl.textContent = 'Cannot compare';
  }

  // Update last updated timestamp
  const lastUpdatedEl = document.getElementById('pricingLastUpdated');
  if (lastUpdated) {
    lastUpdatedEl.textContent = `Updated ${formatDate(lastUpdated)}`;
  } else {
    lastUpdatedEl.textContent = 'Updated today';
  }

  console.log('💰 CAPRICE: Pricing comparison populated successfully');
}

function formatPrice(price) {
  if (!price) return '$0.00';
  const num = parseFloat(price);
  return isNaN(num) ? '$0.00' : `$${num.toFixed(2)}`;
}

function formatDate(dateString) {
  if (!dateString) return 'today';
  const date = new Date(dateString);
  return isNaN(date) ? 'recently' : date.toLocaleDateString();
}

    // ===============================
    // INITIALIZATION
    // ===============================
    $(document).ready(function() {
      console.log(`🚀 ${COLLECTION_CONFIG.name} Collection Loading...`);
      loadProductData();
      setupEventListeners();
    });

    // ===============================
    // ENHANCED EDITPRODUCT FUNCTION - COLLECTION AGNOSTIC
    // ===============================

    function editProduct(rowNum) {
        console.log(`✏️ editProduct called for row: ${rowNum} in collection: ${COLLECTION_NAME}`);

        // Input validation
        if (!rowNum || isNaN(rowNum)) {
            console.error('❌ Invalid rowNum:', rowNum);
            alert('Error: Invalid product row number');
            return;
        }

        // Check if modal element exists
        const modalElement = document.getElementById('editProductModal');
        if (!modalElement) {
            console.error('❌ Modal element not found!');
            alert('Error: Product edit modal not found. Please refresh the page.');
            return;
        }

        // Check if Bootstrap is available
        if (typeof bootstrap === 'undefined') {
            console.error('❌ Bootstrap not loaded!');
            alert('Error: Bootstrap not loaded. Please refresh the page.');
            return;
        }

        // Initialize productsData if it doesn't exist
        if (typeof productsData === 'undefined') {
            console.warn('⚠️ productsData not defined, initializing...');
            window.productsData = {};
        }

        // Check if we have data for this product
        let data = productsData[rowNum];
        if (!data) {
            console.warn(`⚠️ No cached data for row ${rowNum}, creating minimal data...`);
            data = createMinimalProductData(rowNum);
            productsData[rowNum] = data;
        }

        console.log(`✅ Product data found/created for row ${rowNum}:`, data);

        try {
            // Reset modal state
            resetModalForNewProduct();

            // Set the product title in modal header
            const titleElement = document.getElementById('editProductTitle');
            if (titleElement) {
                titleElement.textContent = data.title || `Product ${rowNum}`;
            }

            // Set collection and row info
            document.getElementById('editRowNum').value = rowNum;
            document.getElementById('editCollectionName').value = COLLECTION_NAME;

            // Populate basic fields (common across all collections)
            populateBasicFields(data);

            // Generate and populate collection-specific fields
            generateDynamicFields(COLLECTION_NAME);
            populateDynamicFields(data, COLLECTION_NAME);

            // Update product image preview
            updateProductImagePreview(data);

            // Enable/disable compare button
            setupCompareButton(data);

            // Show the modal
            console.log('🚀 Showing modal...');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true,
                focus: true
            });

            modal.show();
            console.log('✅ Modal displayed successfully!');

        } catch (error) {
            console.error('❌ Error in editProduct function:', error);
            alert('Error opening product editor: ' + error.message + '\n\nPlease check the browser console for more details.');
        }
    }

    // ===============================
    // DYNAMIC FIELD GENERATION - COLLECTION SPECIFIC
    // ===============================

    function createMinimalProductData(rowNum) {
        return {
            title: `Product ${rowNum}`,
            variant_sku: '',
            vendor: '',
            shopify_images: '',
            shopify_price: '',
            shopify_compare_price: '',
            shopify_weight: '',
            shopify_tags: '',
            seo_title: '',
            seo_description: '',
            body_html: '',
            features: '',

        // Product details fields
            installation_type: '',
            product_material: '',
            grade_of_material: '',
            brand_name: '',
            style: '',
            warranty_years: '',
            waste_outlet_dimensions: '',
            bowls_number: '',
            tap_holes_number: '',
            is_undermount: '',
            has_overflow: '',
            application_location: '',
            drain_position: '',
            shopify_status: '',

        // ✅ DIMENSION FIELDS - THESE WILL PULL FROM & PUSH TO GOOGLE SHEET
            length_mm: '',
            overall_width_mm: '',
            overall_depth_mm: '',
            min_cabinet_size_mm: '',
            cutout_size_mm: '',
            bowl_width_mm: '',
            bowl_depth_mm: '',
            bowl_height_mm: '',
            second_bowl_width_mm: '',
            second_bowl_depth_mm: '',
            second_bowl_height_mm: '',

        // Content fields
            care_instructions: '',
            shopify_spec_sheet: '',
            quality_score: 0
        };
    }

function cleanPriceValue(priceString) {
    if (!priceString || priceString === '') return '';

    // Remove dollar signs, commas, and other currency formatting
    const cleaned = priceString.toString().replace(/[\$,\s]/g, '');

    // Return the numeric value, or empty string if invalid
    const numeric = parseFloat(cleaned);
    return isNaN(numeric) ? '' : numeric.toString();
}

// ===============================
// TAG DISPLAY FUNCTIONS
// ===============================

// Add this function to format and display tags
function displayTagsAsBadges(tagsString, containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.warn(`Container ${containerId} not found`);
        return;
    }

    // Clear container first
    container.innerHTML = '';

    if (!tagsString || tagsString.trim() === '') {
        return; // Let CSS handle empty state
    }

    // Split tags by comma and clean them
    const tags = tagsString.split(',')
        .map(tag => tag.trim())
        .filter(tag => tag.length > 0);

    console.log(`🏷️ Displaying ${tags.length} tags as badges`);

    // Create badge for each tag
    tags.forEach(tag => {
        const badge = document.createElement('span');
        badge.className = 'tag-badge ' + getTagCategory(tag);
        badge.textContent = tag;
        badge.title = tag; // Full text on hover for long tags
        container.appendChild(badge);
    });
}

// Categorize tags for different colors
function getTagCategory(tag) {
    const tagLower = tag.toLowerCase();

    // Collection tags
    if (tagLower.includes('collection:')) return 'category-collection';

    // Type tags
    if (tagLower.includes('type:')) return 'category-type';

    // Material tags
    if (tagLower.includes('material:') ||
        tagLower.includes('sinkmaterial:') ||
        tagLower.includes('steel') ||
        tagLower.includes('ceramic') ||
        tagLower.includes('granite')) return 'category-material';

    // Dimension tags
    if (tagLower.includes('length:') ||
        tagLower.includes('width:') ||
        tagLower.includes('height:') ||
        tagLower.match(/\d+mm/)) return 'category-dimension';

    // Mount/Installation tags
    if (tagLower.includes('mount:') ||
        tagLower.includes('mount') ||
        tagLower.includes('undermount') ||
        tagLower.includes('topmount') ||
        tagLower.includes('inset')) return 'category-mount';

    // Brand tags (add more brands as needed)
    if (['abey', 'oliveri', 'blanco', 'franke', 'clark', 'nugleam'].some(brand =>
        tagLower.includes(brand))) return 'category-brand';

    return ''; // Default gradient color
}

function populateBasicFields(data) {
    const basicFields = [
        { id: 'editSku', value: data.variant_sku || '' },
        { id: 'editTitle', value: data.title || '' },
        { id: 'editVendor', value: data.vendor || '' },
        { id: 'editRrpPrice', value: cleanPriceValue(data.shopify_compare_price || '') },
        { id: 'editSalePrice', value: cleanPriceValue(data.shopify_price || '') },
        { id: 'editWeight', value: data.shopify_weight || '' },
        { id: 'editTags', value: data.shopify_tags || '' },
        { id: 'editSeoTitle', value: data.seo_title || '' },
        { id: 'editSeoDescription', value: data.seo_description || '' },
        { id: 'editBodyHtml', value: data.body_html || '' },
        { id: 'editFeatures', value: data.features || '' }
    ];

    basicFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            element.value = field.value;
            console.log(`✅ Set ${field.id}: ${field.value}`);
        } else {
            console.warn(`⚠️ Field ${field.id} not found`);
        }
    });

    // 🎯 CRITICAL: Initialize the image system with existing images from Google Sheet
    const existingImages = data.shopify_images || '';
    console.log('🔍 Initializing modal with existing images:', existingImages);

    // Add small delay to ensure DOM is ready
    setTimeout(() => {
        initializeModalImageSystem(existingImages);
    }, 100);

    // Use the correct field name for tags display
    displayTagsAsBadges(data.shopify_tags || '', 'tagsDisplay');
}

function generateDynamicFields(collectionName) {
    const productDetailsContainer = document.getElementById('dynamicProductFields');
    const dimensionsContainer = document.getElementById('dynamicDimensionFields');

    if (!productDetailsContainer || !dimensionsContainer) {
        console.warn('⚠️ Dynamic field containers not found');
        return;
    }

    // Clear existing dynamic fields
    productDetailsContainer.innerHTML = '';
    dimensionsContainer.innerHTML = '';

    // ✅ CRITICAL FIX: Clear any previously added dynamic content fields
    clearDynamicContentFields();

    // Get collection-specific field configuration
    const fieldConfig = getCollectionFieldConfig(collectionName);

    // Generate product detail fields
    if (fieldConfig.productFields) {
        const productFieldsHTML = generateFieldsHTML(fieldConfig.productFields, 'product');
        productDetailsContainer.innerHTML = productFieldsHTML;
    }

    // Generate dimension fields - SPECIAL HANDLING FOR SINKS
    if (fieldConfig.dimensionFields === 'CUSTOM_SINK_DIMENSIONS') {
        // Use custom sink dimensions layout
        dimensionsContainer.innerHTML = generateCustomSinkDimensions();
    } else if (fieldConfig.dimensionFields) {
        // Use standard dimension fields layout
        const dimensionFieldsHTML = generateFieldsHTML(fieldConfig.dimensionFields, 'dimension');
        dimensionsContainer.innerHTML = dimensionFieldsHTML;
    }

    // ✅ FIXED: Add content fields properly without duplication
    if (fieldConfig.contentFields) {
        addDynamicContentFields(fieldConfig.contentFields);
    }

    console.log(`✅ Generated dynamic fields for ${collectionName}`);
}

// ✅ NEW FUNCTION: Clear any previously added dynamic content fields
function clearDynamicContentFields() {
    const contentGroup = document.getElementById('contentGroup');
    if (!contentGroup) return;

    // Remove any previously added dynamic content fields
    const dynamicFields = contentGroup.querySelectorAll('.dynamic-content-field');
    dynamicFields.forEach(field => field.remove());

    console.log('🧹 Cleared dynamic content fields');
}

// ✅ NEW FUNCTION: Properly add dynamic content fields without duplication
function addDynamicContentFields(contentFields) {
    const contentGroup = document.getElementById('contentGroup');
    if (!contentGroup) {
        console.warn('⚠️ Content group not found');
        return;
    }

    // Find the existing row container
    const existingRow = contentGroup.querySelector('.row');
    if (!existingRow) {
        console.warn('⚠️ Existing row not found in content group');
        return;
    }

    console.log(`➕ Adding ${contentFields.length} dynamic content fields`);

    // Add each content field individually
    contentFields.forEach(field => {
        const fieldHTML = generateSingleFieldHTML(field);

        // Create a container div with a marker class
        const fieldContainer = document.createElement('div');
        fieldContainer.className = 'col-12 dynamic-content-field';
        fieldContainer.innerHTML = fieldHTML;

        // Append to the existing row
        existingRow.appendChild(fieldContainer);

        console.log(`✅ Added dynamic content field: ${field.label}`);
    });
}

// ✅ NEW FUNCTION: Generate HTML for a single field

function generateSingleFieldHTML(field) {
    let fieldHtml = '';

    fieldHtml += `<label class="form-label">${field.label}</label>`;
    fieldHtml += `<div class="position-relative">`;

    switch(field.type) {
        case 'textarea':
            fieldHtml += `<textarea class="form-control" id="${field.id}" rows="3" placeholder="${field.label}"></textarea>`;
            break;

        case 'url':
            if (field.id === 'editShopifySpecSheet') {
                fieldHtml += `
                    <div class="input-group">
                        <input type="url" class="form-control" id="${field.id}" placeholder="https://...">
                        <button type="button" class="btn btn-outline-primary" onclick="validateSpecSheet(parseInt(document.getElementById('editRowNum').value))">
                            <i class="fas fa-check"></i> Validate
                        </button>
                    </div>
                `;
            } else {
                fieldHtml += `<input type="url" class="form-control" id="${field.id}" placeholder="https://...">`;
            }
            break;

        case 'select':
            fieldHtml += `<select class="form-select" id="${field.id}">`;
            fieldHtml += `<option value="">Select ${field.label}</option>`;
            if (field.options) {
                field.options.forEach(option => {
                    fieldHtml += `<option value="${option}">${option}</option>`;
                });
            }
            fieldHtml += `</select>`;
            break;

        case 'number':
            fieldHtml += `<input type="number" class="form-control" id="${field.id}" placeholder="${field.label}">`;
            break;

        default: // text
            fieldHtml += `<input type="text" class="form-control" id="${field.id}" placeholder="${field.label}">`;
            break;
    }

    fieldHtml += `</div>`;

    return fieldHtml;
}

function getCollectionFieldConfig(collectionName) {
    switch(collectionName) {
        case 'sinks':
            return {
                productFields: [
                    { id: 'editColour', label: 'Colour', type: 'select', options: [
                        'Stainless Steel', 'White', 'Black', 'Granite', 'Brushed Steel'
                    ]},
                    { id: 'editInstallationType', label: 'Installation Type', type: 'select', options: [
                        'Topmount', 'Undermount', 'Flushmount', 'Wallmount', 'Apron Front',
                        'Tub & Cabinet', 'Topmount & Undermount', 'Topmount & Flushmount',
                        'Undermount & Flushmount', 'Undermount & Apron Front', 'Flushmount & Undermount',
                        'Apron front & Undermount'
                    ]},
                    { id: 'editProductMaterial', label: 'Product Material', type: 'select', options: [
                        'Stainless Steel', 'Granite', 'Ceramic', 'Fireclay', 'Composite', 'Granite Composite'
                    ]},
                    { id: 'editGradeOfMaterial', label: 'Grade of Material', type: 'select', options: [
                        '304 Stainless Steel', '316 Marine Grade Stainless Steel'
                    ]},
                    { id: 'editBrand', label: 'Brand', type: 'text' },
                    { id: 'editStyle', label: 'Style', type: 'select', options: [
                        'Modern', 'Minimalist', 'Traditional', 'Farmhouse', 'Outdoor Alfresco'
                    ]},
                    { id: 'editWarrantyYears', label: 'Warranty Years', type: 'text' },
                    { id: 'editWasteOutletDimensions', label: 'Waste Outlet Dimensions', type: 'text' },
                    { id: 'editNumberOfBowls', label: 'Number of Bowls', type: 'select', options: [
                        '1', '2'
                    ]},
                    { id: 'editFaucetHoles', label: 'Tap Holes', type: 'number' },
                    { id: 'editIsUndermountSink', label: 'Is Undermount', type: 'boolean' },
                    { id: 'editHasOverflow', label: 'Has Overflow', type: 'boolean' },
                    { id: 'editApplicationLocation', label: 'Application Location', type: 'multiselect', options: [
                        'Kitchen', 'Laundry', 'Bar'
                    ]},
                    { id: 'editDrainPosition', label: 'Drain Position', type: 'select', options: [
                        'Center', 'Rear', 'Left', 'Right', 'Front'
                    ]},
                    { id: 'editShopifyStatus', label: 'Shopify Status', type: 'select', options: [
                        'Draft', 'Active'
                    ]}
                ],
                dimensionFields: 'CUSTOM_SINK_DIMENSIONS',
                contentFields: [
                    { id: 'editCareInstructions', label: 'Care Instructions', type: 'textarea' },
                    { id: 'editShopifySpecSheet', label: 'Spec Sheet URL', type: 'url' }
                ]
            };

        case 'taps':
            return {
                productFields: [
                    { id: 'editTapType', label: 'Tap Type', type: 'select', options: [
                        'Kitchen Mixer', 'Basin Mixer', 'Bath Mixer', 'Shower Mixer'
                    ]},
                    { id: 'editTapMaterial', label: 'Material', type: 'select', options: [
                        'Brass', 'Stainless Steel', 'Chrome', 'Brushed Nickel'
                    ]},
                    { id: 'editFinish', label: 'Finish', type: 'select', options: [
                        'Chrome', 'Brushed Nickel', 'Matte Black', 'Brushed Gold'
                    ]},
                    { id: 'editMountingType', label: 'Mounting Type', type: 'select', options: [
                        'Deck Mounted', 'Wall Mounted', 'Bench Mounted'
                    ]},
                    { id: 'editWaterRating', label: 'Water Rating', type: 'text' },
                    { id: 'editCartridgeType', label: 'Cartridge Type', type: 'text' },
                    { id: 'editShopifyStatus', label: 'Shopify Status', type: 'select', options: [
                        'Draft', 'Active'
                    ]}
                ],
                dimensionFields: [
                    { id: 'editHeight', label: 'Height (mm)', type: 'number' },
                    { id: 'editSpoutReach', label: 'Spout Reach (mm)', type: 'number' },
                    { id: 'editBaseWidth', label: 'Base Width (mm)', type: 'number' }
                ]
            };

        case 'lighting':
            return {
                productFields: [
                    { id: 'editLightType', label: 'Light Type', type: 'select', options: [
                        'Pendant', 'Chandelier', 'Wall Light', 'Ceiling Light', 'Table Lamp'
                    ]},
                    { id: 'editBulbType', label: 'Bulb Type', type: 'select', options: [
                        'LED', 'Halogen', 'Incandescent', 'Fluorescent'
                    ]},
                    { id: 'editWattage', label: 'Wattage', type: 'number' },
                    { id: 'editLightMaterial', label: 'Material', type: 'text' },
                    { id: 'editColorTemperature', label: 'Color Temperature (K)', type: 'number' },
                    { id: 'editDimmable', label: 'Dimmable', type: 'boolean' },
                    { id: 'editShopifyStatus', label: 'Shopify Status', type: 'select', options: [
                        'Draft', 'Active'
                    ]}
                ],
                dimensionFields: [
                    { id: 'editHeight', label: 'Height (mm)', type: 'number' },
                    { id: 'editWidth', label: 'Width (mm)', type: 'number' },
                    { id: 'editDepth', label: 'Depth (mm)', type: 'number' }
                ]
            };

        default:
            return {
                productFields: [
                    { id: 'editProductType', label: 'Product Type', type: 'text' },
                    { id: 'editMaterial', label: 'Material', type: 'text' },
                    { id: 'editBrand', label: 'Brand', type: 'text' },
                    { id: 'editStyle', label: 'Style', type: 'text' },
                    { id: 'editShopifyStatus', label: 'Shopify Status', type: 'select', options: [
                        'Draft', 'Active'
                    ]}
                ],
                dimensionFields: [
                    { id: 'editLength', label: 'Length (mm)', type: 'number' },
                    { id: 'editWidth', label: 'Width (mm)', type: 'number' },
                    { id: 'editHeight', label: 'Height (mm)', type: 'number' }
                ],
                contentFields: [
                    { id: 'editCareInstructions', label: 'Care Instructions', type: 'textarea' },
                    { id: 'editShopifySpecSheet', label: 'Spec Sheet URL', type: 'url' }
                ]
            };
    }
}
// Global variables for modal image management
let modalImageUrls = [];
let modalCurrentImageIndex = 0;
let modalImageUrlCounter = 0;

// Initialize modal image system when modal opens
function initializeModalImageSystem(existingImageUrls = '') {
  console.log('🖼️ Initializing modal image system with:', existingImageUrls);

  // Reset state
  modalImageUrls = [];
  modalCurrentImageIndex = 0;
  modalImageUrlCounter = 0;

  // Parse existing URLs if provided
  if (existingImageUrls && existingImageUrls.trim()) {
    modalImageUrls = existingImageUrls.split(',')
      .map(url => url.trim())
      .filter(url => url && url !== '-' && url !== '');

    console.log(`📷 Parsed ${modalImageUrls.length} existing images:`, modalImageUrls);
  }

  // Clear the input container
  const container = document.getElementById('modalImageUrlContainer');
  if (!container) {
    console.error('❌ modalImageUrlContainer not found!');
    return;
  }

  container.innerHTML = '';

  // Create input fields for each existing URL + one extra empty field
  const totalFields = Math.max(1, modalImageUrls.length + (modalImageUrls.length > 0 ? 1 : 0));

  for (let i = 0; i < totalFields; i++) {
    const isFirstField = i === 0;
    const hasUrl = i < modalImageUrls.length;
    const urlValue = hasUrl ? modalImageUrls[i] : '';

    console.log(`📝 Creating input field ${i}: ${hasUrl ? 'with URL' : 'empty'}`);

    const urlItem = document.createElement('div');
    urlItem.className = 'image-url-item';
    urlItem.setAttribute('data-index', i);

    // Create the input field HTML
    urlItem.innerHTML = `
      <input type="url"
             class="form-control"
             placeholder="https://example.com/image.jpg"
             value="${urlValue}"
             onchange="handleModalImageUrlChange(${i})">
      <div class="image-url-actions">
        <button type="button" class="btn-test-image" onclick="testModalImageUrl(${i})">
          <i class="fas fa-eye"></i> Test
        </button>
        ${!isFirstField ? `
        <button type="button" class="btn-remove-image" onclick="removeModalImageUrl(${i})">
          <i class="fas fa-times"></i>
        </button>
        ` : ''}
      </div>
      <div class="image-error" id="modalImageError${i}"></div>
      <div class="image-success" id="modalImageSuccess${i}"></div>
    `;

    container.appendChild(urlItem);

    // Update the counter to track the highest index
    modalImageUrlCounter = Math.max(modalImageUrlCounter, i);
  }

  console.log(`✅ Created ${totalFields} input fields`);

  // Update displays
  updateModalImageDisplay();
  updateModalFinalUrls();

  // If we have images, show a success message
  if (modalImageUrls.length > 0) {
    console.log(`🎉 Successfully loaded ${modalImageUrls.length} images into modal`);
  }
}

// ALSO UPDATE your handleModalImageUrlChange function to be more robust:

function handleModalImageUrlChange(index) {
  const input = document.querySelector(`[data-index="${index}"] input`);
  if (!input) {
    console.warn(`⚠️ Input field ${index} not found`);
    return;
  }

  const url = input.value.trim();
  const previousUrl = input.dataset.previousUrl || '';

  clearModalMessages(index);

  // Remove previous URL from array if it existed
  if (previousUrl && modalImageUrls.includes(previousUrl)) {
    const prevIndex = modalImageUrls.indexOf(previousUrl);
    modalImageUrls.splice(prevIndex, 1);
    console.log(`🗑️ Removed previous URL: ${previousUrl}`);
  }

  if (url && url !== '-') {
    // Validate URL format
    try {
      new URL(url);
    } catch (e) {
      showModalError(index, 'Please enter a valid URL');
      return;
    }

    // Add to modalImageUrls array if not already present
    if (!modalImageUrls.includes(url)) {
      modalImageUrls.push(url);
      input.dataset.previousUrl = url; // Store for future reference
      showModalSuccess(index, 'URL added to gallery');
      console.log(`✅ Added URL to modal gallery: ${url}`);

      // Auto-add new empty field if this was the last field and we have URLs
      autoAddEmptyFieldIfNeeded();
    } else {
      showModalError(index, 'This URL is already in the gallery');
      input.value = previousUrl; // Restore previous value
      return;
    }
  } else {
    // Empty field - remove previous URL reference
    input.dataset.previousUrl = '';
  }

  updateModalImageDisplay();
  updateModalFinalUrls();
}

// NEW FUNCTION: Auto-add empty field when needed
function autoAddEmptyFieldIfNeeded() {
  const container = document.getElementById('modalImageUrlContainer');
  const allInputs = container.querySelectorAll('input');
  const lastInput = allInputs[allInputs.length - 1];

  // If the last input has a value, add a new empty field
  if (lastInput && lastInput.value.trim() !== '') {
    console.log('🔄 Auto-adding new empty field...');
    addNewModalImageUrl();
  }
}
// ===============================
// MISSING MODAL IMAGE FUNCTIONS - ADD THESE TO YOUR COLLECTION.HTML
// ===============================

function addNewModalImageUrl() {
    const container = document.getElementById('modalImageUrlContainer');
    if (!container) {
        console.warn('⚠️ modalImageUrlContainer not found!');
        return;
    }

    // Increment counter for unique IDs
    modalImageUrlCounter++;
    const newIndex = modalImageUrlCounter;

    console.log(`➕ Adding new modal image URL input field #${newIndex}`);

    // Create new URL input item
    const urlItem = document.createElement('div');
    urlItem.className = 'image-url-item';
    urlItem.setAttribute('data-index', newIndex);

    urlItem.innerHTML = `
        <input type="url"
               class="form-control"
               placeholder="https://example.com/image.jpg"
               onchange="handleModalImageUrlChange(${newIndex})">
        <div class="image-url-actions">
            <button type="button" class="btn-test-image" onclick="testModalImageUrl(${newIndex})">
                <i class="fas fa-eye"></i> Test
            </button>
            <button type="button" class="btn-remove-image" onclick="removeModalImageUrl(${newIndex})">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="image-error" id="modalImageError${newIndex}"></div>
        <div class="image-success" id="modalImageSuccess${newIndex}"></div>
    `;

    container.appendChild(urlItem);
    console.log(`✅ Added new modal image URL input field #${newIndex}`);
}

function removeModalImageUrl(index) {
    const urlItem = document.querySelector(`[data-index="${index}"]`);
    if (!urlItem) {
        console.warn(`⚠️ URL item ${index} not found`);
        return;
    }

    const input = urlItem.querySelector('input');
    const url = input ? input.value.trim() : '';

    // Remove from modalImageUrls array if it exists
    if (url && modalImageUrls.includes(url)) {
        const urlIndex = modalImageUrls.indexOf(url);
        modalImageUrls.splice(urlIndex, 1);

        // Adjust current image index if needed
        if (modalCurrentImageIndex >= modalImageUrls.length && modalImageUrls.length > 0) {
            modalCurrentImageIndex = modalImageUrls.length - 1;
        } else if (modalCurrentImageIndex > urlIndex) {
            modalCurrentImageIndex--;
        }

        console.log(`🗑️ Removed URL from gallery: ${url}`);
    }

    // Remove the input field
    urlItem.remove();

    // Update displays
    updateModalImageDisplay();
    updateModalFinalUrls();

    console.log(`🗑️ Removed modal image URL input field #${index}`);
}

function updateSelectedProductsWithBackend() {
    console.log('🔄 Individual checkbox clicked: updateSelectedProductsWithBackend called');

    // Update local array first
    selectedProducts = [];
    const checkedBoxes = [];

    $('.product-checkbox:checked').each(function() {
        const rowNum = $(this).data('row');
        selectedProducts.push(rowNum);
        checkedBoxes.push({
            row: rowNum,
            checked: true
        });
    });

    // Also track unchecked boxes for complete state sync
    const uncheckedBoxes = [];
    $('.product-checkbox:not(:checked)').each(function() {
        const rowNum = $(this).data('row');
        uncheckedBoxes.push({
            row: rowNum,
            checked: false
        });
    });

    // Combine all checkbox states
    const allCheckboxStates = [...checkedBoxes, ...uncheckedBoxes];

    console.log(`📡 Syncing ${allCheckboxStates.length} checkbox states to Google Sheets...`);
    console.log(`✅ Selected products: ${selectedProducts.length}`);
    console.log(`📊 Total checkbox states to sync: ${allCheckboxStates.length}`);

    // Trigger Google Sheets update via backend API
    if (allCheckboxStates.length > 0) {
        syncCheckboxStatesToBackend(allCheckboxStates);
    }

    // Update UI elements
    updateSelectionUI();
}

// Test function to verify checkbox system
function testCheckboxSystem() {
    console.log('🧪 Testing checkbox system...');

    const totalCheckboxes = $('.product-checkbox').length;
    console.log(`📊 Found ${totalCheckboxes} checkboxes`);

    if (totalCheckboxes === 0) {
        console.warn('⚠️ No checkboxes found! Make sure product cards are loaded.');
        alert('⚠️ No checkboxes found! Make sure product cards are loaded.');
        return;
    }

    // Test the first checkbox
    const firstCheckbox = $('.product-checkbox').first();
    if (firstCheckbox.length) {
        const rowNum = firstCheckbox.data('row');
        console.log(`🎯 Testing first checkbox (row ${rowNum})...`);

        alert(`🧪 Testing checkbox system!\n\nFound ${totalCheckboxes} checkboxes\nTesting checkbox for row ${rowNum}\n\nWatch the console for sync messages!`);

        // Check it
        firstCheckbox.prop('checked', true).trigger('change');

        setTimeout(() => {
            // Uncheck it
            firstCheckbox.prop('checked', false).trigger('change');
        }, 3000);

        return {
            totalCheckboxes: totalCheckboxes,
            firstCheckboxRow: rowNum,
            testCompleted: true
        };
    } else {
        console.warn('⚠️ No checkboxes available for testing');
        alert('⚠️ No checkboxes available for testing');
        return { error: 'No checkboxes available' };
    }
}

// Override setupEventListeners to ensure proper checkbox handling
function setupEventListeners() {
    console.log('🔧 Setting up ALL event listeners...');

    // Search functionality
    $('#searchInput').on('keyup', function() {
        filterProductsGrid();
    });

    // ⭐ CRITICAL: Select all products
    $('#selectAllProducts').on('change', function() {
        console.log('🔄 Select All clicked:', this.checked);
        $('.product-checkbox').prop('checked', this.checked);
        updateSelectedProductsWithBackend();
    });

    // ⭐ CRITICAL: Individual product selection with proper event delegation
    $(document).on('change', '.product-checkbox', function(e) {
        e.stopPropagation(); // Prevent card click
        console.log('🔄 Individual checkbox clicked:', $(this).data('row'), this.checked);
        updateSelectedProductsWithBackend();
    });

    // Prevent checkbox clicks from triggering card click
    $(document).on('click', '.product-checkbox', function(e) {
        e.stopPropagation();
        console.log('🔄 Checkbox click prevented from triggering card click');
    });

    // Tags input handling
    $(document).on('input', '#editTags', function() {
        displayTagsAsBadges(this.value, 'tagsDisplay');
    });

    // Bowl dimensions visibility
    $(document).on('change', '#editNumberOfBowls', function() {
        updateBowlDimensionsVisibility();
    });

    // SKU count for bulk upload
    $(document).on('input', '#bulkSkuInput', function() {
        const skus = this.value.trim().split('\n').filter(s => s.trim() !== '');
        $('#skuCount').text(skus.length);
    });

    console.log('✅ ALL event listeners set up successfully');
}


function handleModalImageUrlChange(index) {
    const input = document.querySelector(`[data-index="${index}"] input`);
    if (!input) {
        console.warn(`⚠️ Input field ${index} not found`);
        return;
    }

    const url = input.value.trim();
    const previousUrl = input.dataset.previousUrl || '';

    clearModalMessages(index);

    // Remove previous URL from array if it existed
    if (previousUrl && modalImageUrls.includes(previousUrl)) {
        const prevIndex = modalImageUrls.indexOf(previousUrl);
        modalImageUrls.splice(prevIndex, 1);
        console.log(`🗑️ Removed previous URL: ${previousUrl}`);
    }

    if (url && url !== '-') {
        // Validate URL format
        try {
            new URL(url);
        } catch (e) {
            showModalError(index, 'Please enter a valid URL');
            return;
        }

        // Add to modalImageUrls array if not already present
        if (!modalImageUrls.includes(url)) {
            modalImageUrls.push(url);
            input.dataset.previousUrl = url; // Store for future reference
            showModalSuccess(index, 'URL added to gallery');
            console.log(`✅ Added URL to modal gallery: ${url}`);

            // Auto-add new empty field if this was the last field and we have URLs
            autoAddEmptyFieldIfNeeded();
        } else {
            showModalError(index, 'This URL is already in the gallery');
            input.value = previousUrl; // Restore previous value
            return;
        }
    } else {
        // Empty field - remove previous URL reference
        input.dataset.previousUrl = '';
    }

    updateModalImageDisplay();
    updateModalFinalUrls();
}

function testModalImageUrl(index) {
    const input = document.querySelector(`[data-index="${index}"] input`);
    if (!input) {
        console.warn(`⚠️ Input field ${index} not found`);
        return;
    }

    const url = input.value.trim();

    clearModalMessages(index);

    if (!url) {
        showModalError(index, 'Please enter a URL to test');
        return;
    }

    // Validate URL format first
    try {
        new URL(url);
    } catch (e) {
        showModalError(index, 'Please enter a valid URL');
        return;
    }

    console.log(`🧪 Testing modal image URL: ${url}`);

    // Show loading state
    const testBtn = document.querySelector(`[data-index="${index}"] .btn-test-image`);
    if (!testBtn) return;

    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    testBtn.disabled = true;

    // Test the image with timeout
    const img = new Image();
    let isComplete = false;

    // Set timeout for slow loading images
    const timeout = setTimeout(() => {
        if (!isComplete) {
            isComplete = true;
            showModalError(index, '⏱️ Image loading timed out. Please check the URL.');
            testBtn.innerHTML = originalText;
            testBtn.disabled = false;
        }
    }, 10000); // 10 second timeout

    img.onload = function() {
        if (isComplete) return;
        isComplete = true;
        clearTimeout(timeout);

        showModalSuccess(index, `✅ Image loads successfully! (${this.naturalWidth} x ${this.naturalHeight}px)`);

        // Trigger change event to add to gallery
        input.dispatchEvent(new Event('change'));

        // Restore button
        testBtn.innerHTML = originalText;
        testBtn.disabled = false;
    };

    img.onerror = function() {
        if (isComplete) return;
        isComplete = true;
        clearTimeout(timeout);

        showModalError(index, '❌ Image failed to load. Please check the URL.');

        // Restore button
        testBtn.innerHTML = originalText;
        testBtn.disabled = false;
    };

    img.src = url;
}

function autoAddEmptyFieldIfNeeded() {
    const container = document.getElementById('modalImageUrlContainer');
    const allInputs = container.querySelectorAll('input');
    const lastInput = allInputs[allInputs.length - 1];

    // If the last input has a value, add a new empty field
    if (lastInput && lastInput.value.trim() !== '') {
        console.log('🔄 Auto-adding new empty field...');
        addNewModalImageUrl();
    }
}

function updateModalFinalUrls() {
    const finalUrlsTextarea = document.getElementById('editImageUrl');
    if (finalUrlsTextarea) {
        finalUrlsTextarea.value = modalImageUrls.join(', ');
        console.log(`📝 Updated modal final URLs: ${modalImageUrls.length} URLs`);
    }
}

function showModalError(index, message) {
    const errorDiv = document.getElementById(`modalImageError${index}`);
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
}

function showModalSuccess(index, message) {
    const successDiv = document.getElementById(`modalImageSuccess${index}`);
    if (successDiv) {
        successDiv.textContent = message;
        successDiv.style.display = 'block';

        // Auto-hide success message after 3 seconds
        setTimeout(() => {
            successDiv.style.display = 'none';
        }, 3000);
    }
}

function clearModalMessages(index) {
    const errorDiv = document.getElementById(`modalImageError${index}`);
    const successDiv = document.getElementById(`modalImageSuccess${index}`);

    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
    if (successDiv) {
        successDiv.style.display = 'none';
    }
}


// UPDATED: More robust URL removal
function removeModalImageUrl(index) {
  const urlItem = document.querySelector(`[data-index="${index}"]`);
  if (!urlItem) {
    console.warn(`⚠️ URL item ${index} not found`);
    return;
  }

  const input = urlItem.querySelector('input');
  const url = input ? input.value.trim() : '';

  // Remove from modalImageUrls array if it exists
  if (url && modalImageUrls.includes(url)) {
    const urlIndex = modalImageUrls.indexOf(url);
    modalImageUrls.splice(urlIndex, 1);

    // Adjust current image index if needed
    if (modalCurrentImageIndex >= modalImageUrls.length && modalImageUrls.length > 0) {
      modalCurrentImageIndex = modalImageUrls.length - 1;
    } else if (modalCurrentImageIndex > urlIndex) {
      modalCurrentImageIndex--;
    }

    console.log(`🗑️ Removed URL from gallery: ${url}`);
  }

  // Remove the input field
  urlItem.remove();

  // Update displays
  updateModalImageDisplay();
  updateModalFinalUrls();

  console.log(`🗑️ Removed modal image URL input field #${index}`);
}

// ENHANCED: Better error handling for image testing
function testModalImageUrl(index) {
  const input = document.querySelector(`[data-index="${index}"] input`);
  if (!input) {
    console.warn(`⚠️ Input field ${index} not found`);
    return;
  }

  const url = input.value.trim();

  clearModalMessages(index);

  if (!url) {
    showModalError(index, 'Please enter a URL to test');
    return;
  }

  // Validate URL format first
  try {
    new URL(url);
  } catch (e) {
    showModalError(index, 'Please enter a valid URL');
    return;
  }

  console.log(`🧪 Testing modal image URL: ${url}`);

  // Show loading state
  const testBtn = document.querySelector(`[data-index="${index}"] .btn-test-image`);
  if (!testBtn) return;

  const originalText = testBtn.innerHTML;
  testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  testBtn.disabled = true;

  // Test the image with timeout
  const img = new Image();
  let isComplete = false;

  // Set timeout for slow loading images
  const timeout = setTimeout(() => {
    if (!isComplete) {
      isComplete = true;
      showModalError(index, '⏱️ Image loading timed out. Please check the URL.');
      testBtn.innerHTML = originalText;
      testBtn.disabled = false;
    }
  }, 10000); // 10 second timeout

  img.onload = function() {
    if (isComplete) return;
    isComplete = true;
    clearTimeout(timeout);

    showModalSuccess(index, `✅ Image loads successfully! (${this.naturalWidth} x ${this.naturalHeight}px)`);

    // Trigger change event to add to gallery
    input.dispatchEvent(new Event('change'));

    // Restore button
    testBtn.innerHTML = originalText;
    testBtn.disabled = false;
  };

  img.onerror = function() {
    if (isComplete) return;
    isComplete = true;
    clearTimeout(timeout);

    showModalError(index, '❌ Image failed to load. Please check the URL.');

    // Restore button
    testBtn.innerHTML = originalText;
    testBtn.disabled = false;
  };

  img.src = url;
}

// Navigate between images in modal
function navigateModalImage(direction) {
  if (modalImageUrls.length === 0) return;

  modalCurrentImageIndex += direction;

  if (modalCurrentImageIndex < 0) {
    modalCurrentImageIndex = modalImageUrls.length - 1;
  } else if (modalCurrentImageIndex >= modalImageUrls.length) {
    modalCurrentImageIndex = 0;
  }

  updateModalImageDisplay();
}

// Update the modal image display and thumbnails
function updateModalImageDisplay() {
  const mainContainer = document.getElementById('modalMainImageContainer');
  const placeholder = document.getElementById('modalImagePlaceholder');
  const thumbnailGallery = document.getElementById('modalThumbnailGallery');
  const imageCountBadge = document.getElementById('modalImageCountBadge');
  const prevBtn = document.getElementById('modalPrevImageBtn');
  const nextBtn = document.getElementById('modalNextImageBtn');
  const imageCounter = document.getElementById('modalImageCounter');

  // Update image count badge
  if (imageCountBadge) {
    imageCountBadge.textContent = `${modalImageUrls.length} image${modalImageUrls.length !== 1 ? 's' : ''}`;
  }

  if (modalImageUrls.length === 0) {
    // Show placeholder
    if (placeholder) placeholder.style.display = 'flex';
    if (thumbnailGallery) thumbnailGallery.style.display = 'none';
    if (prevBtn) prevBtn.style.display = 'none';
    if (nextBtn) nextBtn.style.display = 'none';
    if (imageCounter) imageCounter.style.display = 'none';

    // Remove any existing main image
    const existingImage = mainContainer?.querySelector('.main-image');
    if (existingImage) {
      existingImage.remove();
    }

    return;
  }

  // Hide placeholder
  if (placeholder) placeholder.style.display = 'none';

  // Show/hide navigation elements
  if (modalImageUrls.length > 1) {
    if (thumbnailGallery) thumbnailGallery.style.display = 'flex';
    if (prevBtn) prevBtn.style.display = 'block';
    if (nextBtn) nextBtn.style.display = 'block';
    if (imageCounter) {
      imageCounter.style.display = 'block';
      imageCounter.textContent = `${modalCurrentImageIndex + 1} / ${modalImageUrls.length}`;
    }
  } else {
    if (thumbnailGallery) thumbnailGallery.style.display = 'none';
    if (prevBtn) prevBtn.style.display = 'none';
    if (nextBtn) nextBtn.style.display = 'none';
    if (imageCounter) imageCounter.style.display = 'none';
  }

  // Ensure modalCurrentImageIndex is valid
  if (modalCurrentImageIndex >= modalImageUrls.length) {
    modalCurrentImageIndex = modalImageUrls.length - 1;
  }
  if (modalCurrentImageIndex < 0) {
    modalCurrentImageIndex = 0;
  }

  // Update main image
  updateModalMainImage();

  // Update thumbnails
  updateModalThumbnails();
}

// Update the modal main image
function updateModalMainImage() {
  const mainContainer = document.getElementById('modalMainImageContainer');
  const currentUrl = modalImageUrls[modalCurrentImageIndex];

  if (!currentUrl || !mainContainer) return;

  // Remove existing main image
  const existingImage = mainContainer.querySelector('.main-image');
  if (existingImage) {
    existingImage.remove();
  }

  // Show loading state
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'image-loading';
  loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  mainContainer.appendChild(loadingDiv);

  // Create new image
  const img = document.createElement('img');
  img.className = 'main-image';
  img.alt = 'Product Image';

  img.onload = function() {
    loadingDiv.remove();
    mainContainer.appendChild(img);
  };

  img.onerror = function() {
    loadingDiv.remove();
    const errorDiv = document.createElement('div');
    errorDiv.className = 'image-placeholder';
    errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Failed to load image</span>';
    mainContainer.appendChild(errorDiv);
  };

  img.src = currentUrl;
}

// Update modal thumbnail gallery
function updateModalThumbnails() {
  const thumbnailGallery = document.getElementById('modalThumbnailGallery');
  if (!thumbnailGallery) return;

  thumbnailGallery.innerHTML = '';

  modalImageUrls.forEach((url, index) => {
    const thumbnailItem = document.createElement('div');
    thumbnailItem.className = `thumbnail-item ${index === modalCurrentImageIndex ? 'active' : ''}`;
    thumbnailItem.onclick = () => {
      modalCurrentImageIndex = index;
      updateModalImageDisplay();
    };

    // Create thumbnail image
    const thumbnailImg = document.createElement('img');
    thumbnailImg.className = 'thumbnail-image';
    thumbnailImg.src = url;
    thumbnailImg.alt = `Image ${index + 1}`;

    thumbnailImg.onerror = function() {
      this.parentElement.innerHTML = '<div class="thumbnail-placeholder"><i class="fas fa-exclamation-triangle"></i></div>';
    };

    // Create remove button
    const removeBtn = document.createElement('button');
    removeBtn.className = 'thumbnail-remove';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.onclick = (e) => {
      e.stopPropagation();
      removeModalImageFromGallery(index);
    };

    thumbnailItem.appendChild(thumbnailImg);
    thumbnailItem.appendChild(removeBtn);
    thumbnailGallery.appendChild(thumbnailItem);
  });
}

// Remove image from modal gallery
function removeModalImageFromGallery(index) {
  if (index >= 0 && index < modalImageUrls.length) {
    const removedUrl = modalImageUrls[index];
    modalImageUrls.splice(index, 1);

    // Adjust current index
    if (modalCurrentImageIndex >= modalImageUrls.length && modalImageUrls.length > 0) {
      modalCurrentImageIndex = modalImageUrls.length - 1;
    } else if (modalCurrentImageIndex > index) {
      modalCurrentImageIndex--;
    }

    // Remove URL from input fields
    const inputs = document.querySelectorAll('.image-url-item input');
    inputs.forEach(input => {
      if (input.value.trim() === removedUrl) {
        input.value = '';
        const index = input.closest('.image-url-item').getAttribute('data-index');
        clearModalMessages(index);
      }
    });

    updateModalImageDisplay();
    updateModalFinalUrls();

    console.log(`🗑️ Removed image from modal gallery: ${removedUrl}`);
  }
}

// Update the final URLs textarea in modal
function updateModalFinalUrls() {
  const finalUrlsTextarea = document.getElementById('editImageUrl');
  if (finalUrlsTextarea) {
    finalUrlsTextarea.value = modalImageUrls.join(', ');
    console.log(`📝 Updated modal final URLs: ${modalImageUrls.length} URLs`);
  }
}

// Show modal error message
function showModalError(index, message) {
  const errorDiv = document.getElementById(`modalImageError${index}`);
  if (errorDiv) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  }
}

// Show modal success message
function showModalSuccess(index, message) {
  const successDiv = document.getElementById(`modalImageSuccess${index}`);
  if (successDiv) {
    successDiv.textContent = message;
    successDiv.style.display = 'block';

    // Auto-hide success message after 3 seconds
    setTimeout(() => {
      successDiv.style.display = 'none';
    }, 3000);
  }
}

// Clear modal messages
function clearModalMessages(index) {
  const errorDiv = document.getElementById(`modalImageError${index}`);
  const successDiv = document.getElementById(`modalImageSuccess${index}`);

  if (errorDiv) {
    errorDiv.style.display = 'none';
  }
  if (successDiv) {
    successDiv.style.display = 'none';
  }
}


// ===============================
// FIXED: generateCustomSinkDimensions with icons
// ===============================

function generateCustomSinkDimensions() {
    return `
    <!-- Overall Sink Dimensions -->
    <div class="dimension-group mb-4">
        <div class="dimension-group-header">
            <i class="fas fa-expand-arrows-alt text-primary"></i>
            <span class="dimension-group-title">Overall Sink Dimensions</span>
        </div>
        <div class="dimension-grid">
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-arrows-alt-h me-1"></i>
                    Length
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editLengthMm" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-arrows-alt-h me-1"></i>
                    Width
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editOverallWidthMm" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-arrows-alt-v me-1"></i>
                    Depth
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editOverallDepthMm" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Installation Requirements -->
    <div class="dimension-group mb-4">
        <div class="dimension-group-header">
            <i class="fas fa-tools text-warning"></i>
            <span class="dimension-group-title">Installation Requirements</span>
        </div>
        <div class="dimension-grid">
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-cube me-1"></i>
                    Min Cabinet Size
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editMinCabinetSize" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-cut me-1"></i>
                    Cutout Size
                </label>
                <input type="text" class="form-control form-control-sm" id="editCutoutSize" placeholder="e.g. 850 x 480mm">
            </div>
        </div>
    </div>

    <!-- Bowl Dimensions -->
    <div class="dimension-group mb-4">
        <div class="dimension-group-header">
            <i class="fas fa-bath text-info"></i>
            <span class="dimension-group-title">Primary Bowl Dimensions</span>
        </div>
        <div class="dimension-grid">
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-arrows-alt-h me-1"></i>
                    Bowl Width
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editBowlWidthMm" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-arrows-alt-v me-1"></i>
                    Bowl Depth
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editBowlDepthMm" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-level-down-alt me-1"></i>
                    Bowl Height
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editBowlHeightMm" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Second Bowl Dimensions (Conditional) -->
    <div class="dimension-group mb-4 conditional-field conditional-bowls_number-2" style="display: none;">
        <div class="dimension-group-header">
            <i class="fas fa-bath text-success"></i>
            <span class="dimension-group-title">Second Bowl Dimensions</span>
        </div>
        <div class="dimension-grid">
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-arrows-alt-h me-1"></i>
                    2nd Bowl Width
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editSecondBowlWidth" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-arrows-alt-v me-1"></i>
                    2nd Bowl Depth
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editSecondBowlDepth" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
            <div class="dimension-item">
                <label class="dimension-label">
                    <i class="fas fa-level-down-alt me-1"></i>
                    2nd Bowl Height
                </label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="editSecondBowlHeight" placeholder="0">
                    <span class="input-group-text">mm</span>
                </div>
            </div>
        </div>
    </div>
    `;
}

function generateFieldsHTML(fields, fieldType) {
    let html = '<div class="row">';

    fields.forEach((field, index) => {
        const colClass = field.type === 'textarea' ? 'col-12' : 'col-md-6';

        // Add conditional class for fields that should be hidden initially
        let conditionalClass = '';
        if (field.conditional) {
            conditionalClass = ` conditional-field conditional-${field.conditional}-${field.value}`;
        }

        html += `<div class="${colClass}${conditionalClass}">`;
        html += `<label class="form-label">${field.label}</label>`;
        html += `<div class="position-relative">`;

        switch(field.type) {
            case 'select':
                html += `<select class="form-select" id="${field.id}">`;
                html += `<option value="">Select ${field.label}</option>`;
                if (field.options) {
                    field.options.forEach(option => {
                        html += `<option value="${option}">${option}</option>`;
                    });
                }
                html += `</select>`;
                break;

            case 'multiselect':
                html += `<select class="form-select" id="${field.id}" multiple>`;
                if (field.options) {
                    field.options.forEach(option => {
                        html += `<option value="${option}">${option}</option>`;
                    });
                }
                html += `</select>`;
                html += `<div class="form-text">Hold Ctrl/Cmd to select multiple options</div>`;
                break;

            case 'boolean':
                html += `<select class="form-select" id="${field.id}">`;
                html += `<option value="">Select...</option>`;
                html += `<option value="True">Yes</option>`;
                html += `<option value="False">No</option>`;
                html += `</select>`;
                break;

            case 'textarea':
                html += `<textarea class="form-control" id="${field.id}" rows="3" placeholder="${field.label}"></textarea>`;
                break;

            case 'number':
                html += `<input type="number" class="form-control" id="${field.id}" placeholder="${field.label}">`;
                break;

            case 'url':
                html += `<input type="url" class="form-control" id="${field.id}" placeholder="https://...">`;
                break;

            default: // text
                html += `<input type="text" class="form-control" id="${field.id}" placeholder="${field.label}">`;
                break;
        }

        html += `</div>`;
        html += `</div>`;
    });

    html += '</div>';
    return html;
}

function populateDynamicFields(data, collectionName) {
    console.log(`🔧 Populating dynamic fields for ${collectionName}...`);

    // Store current product data for pricing comparison access
    window.currentProductData = data;

    const fieldConfig = getCollectionFieldConfig(collectionName);

    // Handle custom sink dimensions separately
    if (collectionName === 'sinks' && fieldConfig.dimensionFields === 'CUSTOM_SINK_DIMENSIONS') {
        console.log('🔄 Populating custom sink dimensions with data:', data);

        // Define all sink dimension fields and their mappings
        const sinkDimensionFields = [
            { id: 'editLengthMm', dataField: 'length_mm' },
            { id: 'editOverallWidthMm', dataField: 'overall_width_mm' },
            { id: 'editOverallDepthMm', dataField: 'overall_depth_mm' },
            { id: 'editMinCabinetSize', dataField: 'min_cabinet_size_mm' },
            { id: 'editCutoutSize', dataField: 'cutout_size_mm' },
            { id: 'editBowlWidthMm', dataField: 'bowl_width_mm' },
            { id: 'editBowlDepthMm', dataField: 'bowl_depth_mm' },
            { id: 'editBowlHeightMm', dataField: 'bowl_height_mm' },
            { id: 'editSecondBowlWidth', dataField: 'second_bowl_width_mm' },
            { id: 'editSecondBowlDepth', dataField: 'second_bowl_depth_mm' },
            { id: 'editSecondBowlHeight', dataField: 'second_bowl_height_mm' }
        ];

        // Populate each dimension field
        sinkDimensionFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element) {
                const value = data[field.dataField] || '';
                element.value = value;
                console.log(`✅ Set dimension field ${field.id}: ${value} (from ${field.dataField})`);
            } else {
                console.warn(`⚠️ Dimension field ${field.id} not found in DOM`);
            }
        });
    }

    // Handle regular product fields (non-dimensions)
    const allFields = [...(fieldConfig.productFields || [])];

    // Handle standard dimension fields for non-sink collections
    if (fieldConfig.dimensionFields && fieldConfig.dimensionFields !== 'CUSTOM_SINK_DIMENSIONS') {
        allFields.push(...fieldConfig.dimensionFields);
    }

    // Handle content fields (care instructions, spec sheet, etc.)
    if (fieldConfig.contentFields) {
        allFields.push(...fieldConfig.contentFields);
    }

    // Populate standard fields INCLUDING MULTISELECT HANDLING
    allFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            const dataFieldName = mapFieldIdToDataField(field.id, collectionName);
            let value = data[dataFieldName] || '';

            // SPECIAL HANDLING FOR MULTISELECT FIELDS
            if (field.type === 'multiselect') {
                console.log(`🔧 Processing multiselect field: ${field.id} with value: "${value}"`);

                // Clear all existing selections first
                Array.from(element.options).forEach(option => {
                    option.selected = false;
                });

                // If we have a value, split by comma and select matching options
                if (value && value.trim() !== '') {
                    const selectedValues = value.split(',').map(v => v.trim()).filter(v => v !== '');
                    console.log(`📋 Selecting options: [${selectedValues.join(', ')}]`);

                    selectedValues.forEach(selectedValue => {
                        // Find and select the matching option
                        const matchingOption = Array.from(element.options).find(option =>
                            option.value.trim() === selectedValue
                        );

                        if (matchingOption) {
                            matchingOption.selected = true;
                            console.log(`✅ Selected option: "${selectedValue}"`);
                        } else {
                            console.warn(`⚠️ Option "${selectedValue}" not found in multiselect field ${field.id}`);
                        }
                    });
                }
            }
            // SPECIAL HANDLING FOR SHOPIFY STATUS - Pull from Column AM
            else if (field.id === 'editShopifyStatus') {
                // Use the exact value from Column AM (shopify_status field)
                value = data.shopify_status || '';
                console.log(`✅ Shopify Status from Column AM: "${value}"`);

                // Validate the value - only allow Draft/Active
                if (value && !['Draft', 'Active'].includes(value)) {
                    console.warn(`⚠️ Invalid Shopify Status value from sheet: "${value}", clearing it`);
                    value = '';
                }
                element.value = value;
            }
            // BOOLEAN FIELD HANDLING
            else if (field.type === 'boolean') {
                if (value === 'True' || value === 'TRUE' || value === true || value === '1') {
                    value = 'True';
                } else if (value === 'False' || value === 'FALSE' || value === false || value === '0') {
                    value = 'False';
                } else {
                    value = '';
                }
                element.value = value;
            }
            // STANDARD FIELD HANDLING
            else {
                element.value = value;
            }

            console.log(`✅ Set dynamic field ${field.id}: "${value}" (mapped from ${dataFieldName})`);
        } else {
            console.warn(`⚠️ Field ${field.id} not found in DOM`);
        }
    });

    // CRITICAL FIX: Handle bowl dimensions visibility for sinks
    if (collectionName === 'sinks') {
        console.log('🔧 Checking bowl dimensions after populating sink fields...');

        // Get the bowl count from the data
        const bowlCount = data.bowls_number || '';
        console.log(`📊 Bowl count from data: "${bowlCount}"`);

        // Ensure the bowl count field is properly set
        const bowlElement = document.getElementById('editNumberOfBowls');
        if (bowlElement) {
            bowlElement.value = bowlCount;
            console.log(`📝 Set bowl count field to: "${bowlCount}"`);
        }

        // KEY FIX: Call the visibility function after setting the value
        // Use setTimeout to ensure DOM is fully updated
        setTimeout(() => {
            console.log('🎯 Triggering bowl dimensions visibility check...');
            if (typeof updateBowlDimensionsVisibility === 'function') {
                updateBowlDimensionsVisibility();
            } else {
                console.warn('⚠️ updateBowlDimensionsVisibility function not found, using fallback...');
                // Fallback logic if the function doesn't exist yet
                const currentBowlCount = $('#editNumberOfBowls').val();
                if (currentBowlCount === '2' || currentBowlCount === 2) {
                    console.log('✅ Fallback: Showing second bowl dimensions');
                    $('.conditional-bowls_number-2').addClass('show').show();
                } else {
                    console.log('ℹ️ Fallback: Hiding second bowl dimensions');
                    $('.conditional-bowls_number-2').removeClass('show').hide();
                }
            }
        }, 150); // Slightly longer delay to ensure all DOM updates are complete

        // Additional check after a longer delay for safety
        setTimeout(() => {
            const finalBowlCount = $('#editNumberOfBowls').val();
            const isSecondBowlVisible = $('.conditional-bowls_number-2').is(':visible');
            console.log(`🔍 Final check - Bowl count: "${finalBowlCount}", Second bowl visible: ${isSecondBowlVisible}`);

            // If bowl count is 2 but second bowl fields aren't visible, force them to show
            if ((finalBowlCount === '2' || finalBowlCount === 2) && !isSecondBowlVisible) {
                console.log('🔧 Force showing second bowl dimensions...');
                $('.conditional-bowls_number-2').addClass('show').show();
            }
        }, 300);
    }

    // POPULATE PRICING COMPARISON (CAPRICE FEATURE)
    populatePricingComparison(data);

    console.log(`✅ Completed populating dynamic fields for ${collectionName}`);
}


function mapFieldIdToDataField(fieldId, collectionName) {
    const fieldMappings = {
        // ✅ Use the EXACT field names from your Python column_mapping
        'editSku': 'variant_sku',                   // ✅ Matches your backend
        'editTitle': 'title',                       // ✅ Matches your backend
        'editVendor': 'vendor',                     // ✅ Matches your backend
        'editColour': 'colour',                     // ✅ Matches your backend
        'editImageUrl': 'shopify_images',           // ✅ Matches your backend

        // Product details - using your exact column_mapping names
        'editInstallationType': 'installation_type',
        'editProductMaterial': 'product_material',
        'editGradeOfMaterial': 'grade_of_material',
        'editBrand': 'brand_name',
        'editStyle': 'style',
        'editWarrantyYears': 'warranty_years',
        'editWasteOutletDimensions': 'waste_outlet_dimensions',
        'editNumberOfBowls': 'bowls_number',
        'editFaucetHoles': 'tap_holes_number',
        'editIsUndermountSink': 'is_undermount',
        'editHasOverflow': 'has_overflow',
        'editApplicationLocation': 'application_location',
        'editDrainPosition': 'drain_position',
        'editShopifyStatus': 'shopify_status',

        // Dimensions - using your exact column_mapping names
        'editLengthMm': 'length_mm',
        'editOverallWidthMm': 'overall_width_mm',
        'editOverallDepthMm': 'overall_depth_mm',
        'editMinCabinetSize': 'min_cabinet_size_mm',
        'editCutoutSize': 'cutout_size_mm',
        'editBowlWidthMm': 'bowl_width_mm',
        'editBowlDepthMm': 'bowl_depth_mm',
        'editBowlHeightMm': 'bowl_height_mm',
        'editSecondBowlWidth': 'second_bowl_width_mm',
        'editSecondBowlDepth': 'second_bowl_depth_mm',
        'editSecondBowlHeight': 'second_bowl_height_mm',

        // E-commerce - using your exact column_mapping names
        'editRrpPrice': 'shopify_compare_price',    // ✅ Matches your backend
        'editSalePrice': 'shopify_price',           // ✅ Matches your backend
        'editWeight': 'shopify_weight',             // ✅ Matches your backend
        'editTags': 'shopify_tags',                 // ✅ Matches your backend
        'editSeoTitle': 'seo_title',
        'editSeoDescription': 'seo_description',

        // Content - using your exact column_mapping names
        'editBodyHtml': 'body_html',
        'editFeatures': 'features',
        'editCareInstructions': 'care_instructions',
        'editShopifySpecSheet': 'shopify_spec_sheet'
    };

    const mappedField = fieldMappings[fieldId] || fieldId.replace('edit', '').toLowerCase();
    console.log(`🗺️ Field mapping: ${fieldId} → ${mappedField}`);
    return mappedField;
}

// Debug function to test the save system
function testSaveSystem() {
    console.log('🧪 Testing Save System...');
    console.log('Collection:', COLLECTION_NAME);
    console.log('Row Number:', document.getElementById('editRowNum').value);

    const data = collectFormData(COLLECTION_NAME);
    console.log('Collected Data:', data);

    if (Object.keys(data).length === 0) {
        console.log('⚠️ No data collected - try filling in some fields first');
    } else {
        console.log('✅ Data collection working correctly');
    }
}

// ===============================
// MODAL SUPPORT FUNCTIONS
// ===============================

function resetModalForNewProduct() {
    console.log('🔄 Resetting modal for new product...');

    try {
        // Hide status badge
        const statusBadge = document.getElementById('modalStatusBadge');
        if (statusBadge) {
            statusBadge.style.display = 'none';
        }

        // Clear any field highlighting
        document.querySelectorAll('.form-control, .form-select').forEach(el => {
            el.classList.remove('field-extracted', 'field-cleaned', 'ai-field-processing');
        });

        // Remove processing animations
        document.querySelectorAll('.field-group').forEach(group => {
            group.classList.remove('ai-processing', 'extraction-success');
        });

        // Remove header animations
        document.querySelectorAll('h6').forEach(header => {
            header.classList.remove('ai-label-processing');
        });

        // Remove any success indicators
        document.querySelectorAll('.success-indicator, .cleaned-indicator').forEach(el => el.remove());

        // Remove shimmer effects
        document.querySelectorAll('.field-shimmer').forEach(shimmer => {
            shimmer.remove();
        });

        // Remove progress indicators
        document.querySelectorAll('.ai-progress-indicator').forEach(indicator => {
            indicator.remove();
        });

        // ✅ NEW: Clear dynamic content fields to prevent duplication
        clearDynamicContentFields();

        console.log('✅ Modal reset complete');

    } catch (error) {
        console.warn('⚠️ Error resetting modal:', error);
    }
}


function updateProductImagePreview(data) {
    try {
        const imageContainer = document.getElementById('editProductImagePreview');
        if (!imageContainer) return;

        // ✅ Use the correct field name from your backend
        const imageUrl = data.shopify_images ||
                      document.getElementById('editImageUrl')?.value ||
                      '';

        if (imageUrl && imageUrl.trim() !== '' && imageUrl !== '-') {
            // Show loading state
            imageContainer.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100"><i class="fas fa-spinner fa-spin"></i></div>';

            // Create image element and handle loading
            const img = new Image();
            img.onload = function() {
                imageContainer.innerHTML = `<img src="${imageUrl}" alt="Product Image" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">`;
            };
            img.onerror = function() {
                imageContainer.innerHTML = '<i class="fas fa-image text-muted"></i><br><small class="text-muted">Image not available</small>';
            };
            img.src = imageUrl;
        } else {
            imageContainer.innerHTML = '<i class="fas fa-image text-muted"></i><br><small class="text-muted">No image URL</small>';
        }
    } catch (error) {
        console.warn('⚠️ Error updating image preview:', error);
    }
}

function testImageUrl() {
    const imageUrl = document.getElementById('editImageUrl').value;
    if (!imageUrl || imageUrl.trim() === '') {
        alert('Please enter an image URL to test');
        return;
    }

    console.log('🧪 Testing image URL:', imageUrl);

    const testImg = new Image();
    testImg.onload = function() {
        alert(`✅ Image loads successfully!\nDimensions: ${this.naturalWidth} x ${this.naturalHeight}px`);
        updateProductImagePreview({ image_url: imageUrl });
    };
    testImg.onerror = function() {
        alert(`❌ Image failed to load. Please check the URL.`);
    };
    testImg.src = imageUrl;
}

function setupCompareButton(data) {
    try {
        const compareBtn = document.getElementById('compareBtn');
        if (!compareBtn) return;

        // Check if product has a URL for comparison
        const urlToOpen = data.url || data.supplier_url || data.product_url || data['Column A'];

        if (urlToOpen && urlToOpen.trim() !== '' && urlToOpen !== '-') {
            // Enable compare button
            compareBtn.disabled = false;
            compareBtn.title = 'Compare with supplier website';
            compareBtn.classList.remove('btn-outline-secondary');
            compareBtn.classList.add('btn-outline-info');
        } else {
            // Disable compare button
            compareBtn.disabled = true;
            compareBtn.title = 'No supplier URL available';
            compareBtn.classList.remove('btn-outline-info');
            compareBtn.classList.add('btn-outline-secondary');
        }
    } catch (error) {
        console.warn('⚠️ Error setting up compare button:', error);
    }
}

// ===============================
// AI EXTRACTION ANIMATION FUNCTIONS - COMPLETE
// ===============================

function startAIExtractionAnimation() {
    console.log('🎬 Starting AI extraction animation sequence...');

    // Reset any previous animations
    stopAIExtractionAnimation();

    // Get all the field groups that will be processed
    const fieldGroups = [
        { id: 'basicInfoGroup', name: 'Basic Information', delay: 0 },
        { id: 'productDetailsGroup', name: 'Product Details', delay: 1000 },
        { id: 'dimensionsGroup', name: 'Dimensions', delay: 2000 },
        { id: 'ecommerceGroup', name: 'E-commerce Information', delay: 3000 },
        { id: 'contentGroup', name: 'Product Content', delay: 4000 }
    ];

    // Update badge to show overall progress
    const statusBadge = document.getElementById('modalStatusBadge');
    if (statusBadge) {
        statusBadge.textContent = 'Processing Fields...';
        statusBadge.className = 'badge bg-warning ms-3';
    }

    // Animate each field group in sequence
    fieldGroups.forEach((group, index) => {
        setTimeout(() => {
            animateFieldGroup(group.id, group.name);
        }, group.delay);
    });
}

function animateFieldGroup(groupId, groupName) {
    const group = document.getElementById(groupId);
    if (!group) {
        console.warn(`⚠️ Group ${groupId} not found`);
        return;
    }

    console.log(`✨ Animating ${groupName} fields...`);

    // Add processing class to the entire group
    group.classList.add('ai-processing');

    // Add progress indicator
    const progressIndicator = document.createElement('div');
    progressIndicator.className = 'ai-progress-indicator';
    group.style.position = 'relative';
    group.appendChild(progressIndicator);

    // Find and animate the group header
    const groupHeader = group.querySelector('h6');
    if (groupHeader) {
        groupHeader.classList.add('ai-label-processing');
    }

    // Find all input fields in this group and animate them
    const inputFields = group.querySelectorAll('input, select, textarea');
    console.log(`Found ${inputFields.length} fields in ${groupName}`);

    inputFields.forEach((field, index) => {
        setTimeout(() => {
            animateIndividualField(field);
        }, index * 200); // Stagger the field animations
    });

    // Update status badge with current group
    const statusBadge = document.getElementById('modalStatusBadge');
    if (statusBadge) {
        statusBadge.textContent = `Processing ${groupName}...`;
    }
}

function animateIndividualField(field) {
    console.log(`🔄 Animating individual field:`, field.id || field.name);

    // Add processing animation to the field
    field.classList.add('ai-field-processing');

    // Create a wrapper with shimmer effect
    const wrapper = field.parentElement;
    if (wrapper) {
        wrapper.style.position = 'relative';

        // Add shimmer overlay
        const shimmer = document.createElement('div');
        shimmer.className = 'field-shimmer';
        shimmer.innerHTML = '<div class="shimmer-line"></div>';
        wrapper.appendChild(shimmer);

        // Remove shimmer after animation
        setTimeout(() => {
            if (shimmer.parentElement) {
                shimmer.remove();
            }
        }, 1500);
    }
}

function showExtractionSuccess() {
    console.log('🎉 Showing extraction success animation...');

    // Remove all processing animations
    stopAIExtractionAnimation();

    // Add success animations to all field groups
    const fieldGroups = document.querySelectorAll('.field-group');
    fieldGroups.forEach((group, index) => {
        setTimeout(() => {
            group.classList.add('extraction-success');

            // Add success checkmarks to fields with values
            const fields = group.querySelectorAll('input, select, textarea');
            fields.forEach(field => {
                if (field.value && field.value.trim() !== '') {
                    addSuccessIndicator(field);
                }
            });
        }, index * 300);
    });

    // Clear success animations after delay
    setTimeout(() => {
        document.querySelectorAll('.field-group').forEach(group => {
            group.classList.remove('extraction-success');
        });
        document.querySelectorAll('.success-indicator').forEach(indicator => {
            indicator.remove();
        });
    }, 3000);
}

function stopAIExtractionAnimation() {
    console.log('⏹️ Stopping AI extraction animations...');

    // Remove all animation classes
    document.querySelectorAll('.field-group').forEach(group => {
        group.classList.remove('ai-processing');
    });

    document.querySelectorAll('h6').forEach(header => {
        header.classList.remove('ai-label-processing');
    });

    document.querySelectorAll('input, select, textarea').forEach(field => {
        field.classList.remove('ai-field-processing');
    });

    // Remove any shimmer effects
    document.querySelectorAll('.field-shimmer').forEach(shimmer => {
        shimmer.remove();
    });

    // Remove progress indicators
    document.querySelectorAll('.ai-progress-indicator').forEach(indicator => {
        indicator.remove();
    });
}

function addSuccessIndicator(field) {
    // Add a success checkmark to extracted fields
    const wrapper = field.parentElement;
    if (wrapper && !wrapper.querySelector('.success-indicator')) {
        const indicator = document.createElement('div');
        indicator.className = 'success-indicator';
        indicator.innerHTML = '<i class="fas fa-check-circle"></i>';
        indicator.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            color: #28a745;
            font-size: 16px;
            z-index: 10;
            animation: successPop 0.8s ease-out;
        `;
        wrapper.style.position = 'relative';
        wrapper.appendChild(indicator);

        // Also add visual feedback to the field
        field.classList.add('field-extracted');
    }
}

function startCleaningAnimation() {
    console.log('🧹 Starting cleaning animation...');

    // Add cleaning animation to all fields with data
    document.querySelectorAll('input, select, textarea').forEach(field => {
        if (field.value && field.value.trim() !== '') {
            field.classList.add('field-cleaning');
            field.style.background = 'linear-gradient(45deg, #f8f9fa, rgba(255, 193, 7, 0.1), #f8f9fa)';
            field.style.backgroundSize = '200% 100%';
            field.style.animation = 'cleaningSweep 2s ease-in-out infinite';
        }
    });
}

function showCleaningSuccess() {
    console.log('✅ Showing cleaning success...');

    stopCleaningAnimation();

    // Add cleaned field styling
    document.querySelectorAll('input, select, textarea').forEach(field => {
        if (field.value && field.value.trim() !== '') {
            field.classList.add('field-cleaned');
            addCleanedIndicator(field);
        }
    });

    setTimeout(() => {
        document.querySelectorAll('.field-cleaned').forEach(field => {
            field.classList.remove('field-cleaned');
        });
        document.querySelectorAll('.cleaned-indicator').forEach(indicator => {
            indicator.remove();
        });
    }, 3000);
}

function stopCleaningAnimation() {
    document.querySelectorAll('.field-cleaning').forEach(field => {
        field.classList.remove('field-cleaning');
        field.style.background = '';
        field.style.backgroundSize = '';
        field.style.animation = '';
    });
}

function addCleanedIndicator(field) {
    const wrapper = field.parentElement;
    if (wrapper && !wrapper.querySelector('.cleaned-indicator')) {
        const indicator = document.createElement('div');
        indicator.className = 'cleaned-indicator';
        indicator.innerHTML = '<i class="fas fa-broom"></i>';
        indicator.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            color: #667eea;
            font-size: 14px;
            z-index: 10;
            animation: cleanedPop 0.8s ease-out;
        `;
        wrapper.style.position = 'relative';
        wrapper.appendChild(indicator);
    }
}

// Generic function that can animate any field generation
function animateFieldGeneration(fieldsToAnimate = ['editBodyHtml', 'editFeatures'], animationType = 'description') {
    const contentGroup = document.getElementById('contentGroup');
    if (!contentGroup) return;

    console.log(`✨ Animating ${animationType} generation...`);

    // Add processing animation to content group
    contentGroup.classList.add('ai-processing');
    const groupHeader = contentGroup.querySelector('h6');
    if (groupHeader) {
        groupHeader.classList.add('ai-label-processing');
    }

    // Animate the specified fields
    fieldsToAnimate.forEach((fieldId, index) => {
        const field = document.getElementById(fieldId);
        if (field) {
            setTimeout(() => {
                animateIndividualField(field);
            }, index * 500);
        }
    });
}

// Backwards compatible function for description generation
function animateDescriptionGeneration() {
    animateFieldGeneration(['editBodyHtml', 'editFeatures'], 'description');
}

// New function for care instructions generation
function animateCareInstructionsGeneration() {
    animateFieldGeneration(['editCareInstructions'], 'care instructions');
}

// Function for features-only generation
function animateFeaturesGeneration() {
    animateFieldGeneration(['editFeatures'], 'features');
}

// Function for multiple content fields (description + care instructions)
function animateContentGeneration() {
    animateFieldGeneration(['editBodyHtml', 'editFeatures', 'editCareInstructions'], 'content');
}

// Function to stop all field animations
function stopFieldAnimation() {
    const contentGroup = document.getElementById('contentGroup');
    if (contentGroup) {
        contentGroup.classList.remove('ai-processing');
        const groupHeader = contentGroup.querySelector('h6');
        if (groupHeader) {
            groupHeader.classList.remove('ai-label-processing');
        }
    }

    // Remove animation from all possible fields
    const allFields = ['editBodyHtml', 'editFeatures', 'editCareInstructions'];
    allFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.classList.remove('ai-field-processing'); // Assuming this is the class added by animateIndividualField
        }
    });
}

function showDescriptionSuccess() {
    const contentGroup = document.getElementById('contentGroup');
    if (!contentGroup) return;

    console.log('🎉 Showing description success animation...');

    contentGroup.classList.remove('ai-processing');
    contentGroup.classList.add('extraction-success');

    // Add success indicators to description fields
    const descriptionFields = ['editBodyHtml', 'editFeatures'];
    descriptionFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.value.trim() !== '') {
            addSuccessIndicator(field);
        }
    });

    setTimeout(() => {
        contentGroup.classList.remove('extraction-success');
    }, 2000);
}

// ===============================
// SAVE FUNCTIONALITY
// ===============================

function saveProductChanges() {
    const rowNum = document.getElementById('editRowNum').value;
    const collectionName = document.getElementById('editCollectionName').value;

    console.log(`💾 Saving changes for ${collectionName} product ${rowNum}...`);

    // Collect all form data
    const updatedData = collectFormData(collectionName);
    console.log('📝 Data to save:', updatedData);

    if (Object.keys(updatedData).length === 0) {
        showInfoMessage('No changes detected to save');
        return;
    }

    // Show saving indicator
    const saveBtn = document.querySelector('#editProductModal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
    saveBtn.disabled = true;

    // Send updates to server
    const promises = [];
    const apiCalls = [];

    Object.keys(updatedData).forEach(field => {
        if (updatedData[field] !== undefined && updatedData[field] !== '') {
            const apiUrl = `/api/${collectionName}/products/${rowNum}`;
            const payload = { field: field, value: updatedData[field] };

            console.log(`🌐 API Call: PUT ${apiUrl}`, payload);
            apiCalls.push({ url: apiUrl, payload: payload, field: field });

            promises.push(
                fetch(apiUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
            );
        }
    });

    console.log(`📡 Making ${promises.length} API calls...`);

    Promise.all(promises)
        .then(responses => {
            console.log('📨 Raw responses:', responses);

            // Check for HTTP errors first
            const httpErrors = responses.filter(r => !r.ok);
            if (httpErrors.length > 0) {
                console.error('❌ HTTP Errors:', httpErrors);
                httpErrors.forEach((response, index) => {
                    console.error(`❌ Call ${index}: ${response.status} ${response.statusText} for ${apiCalls[index].url}`);
                });
            }

            return Promise.all(responses.map((r, index) => {
                if (!r.ok) {
                    return { success: false, error: `HTTP ${r.status}: ${r.statusText}`, call: apiCalls[index] };
                }
                return r.json().catch(e => ({ success: false, error: 'Invalid JSON response', call: apiCalls[index] }));
            }));
        })
        .then(results => {
            console.log('📋 Parsed results:', results);

            const failed = results.filter(r => !r.success);
            const succeeded = results.filter(r => r.success);

            console.log(`✅ Succeeded: ${succeeded.length}, ❌ Failed: ${failed.length}`);

            // Restore button state
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;

            // NEW LOGIC: Show success if majority of fields saved
            const totalFields = results.length;
            const successRate = (succeeded.length / totalFields) * 100;

            if (succeeded.length === totalFields) {
                // 🎉 PERFECT SUCCESS
                console.log('🎉 Perfect save! All fields updated successfully');

                // ✅ CRITICAL FIX: Load complete fresh data instead of using partial updatedData
                loadSingleProductData(parseInt(rowNum));

                bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                showSuccessMessage(`🎉 Product updated successfully!\n\nAll ${totalFields} fields saved perfectly.`);

            } else if (successRate >= 80) {
                // ✅ MOSTLY SUCCESS (80%+ fields saved)
                console.log('✅ Mostly successful save');

                // ✅ CRITICAL FIX: Load complete fresh data instead of using partial updatedData
                loadSingleProductData(parseInt(rowNum));

                bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();

                const failedFieldNames = failed.map(f => f.call?.field || 'unknown').join(', ');
                showSuccessMessage(`✅ Product updated successfully!\n\n${succeeded.length}/${totalFields} fields saved.\n\nNote: ${failed.length} non-critical field(s) skipped: ${failedFieldNames}`);

            } else if (succeeded.length > 0) {
                // ⚠️ PARTIAL SUCCESS (some fields saved)
                console.log('⚠️ Partial save success');

                // ✅ CRITICAL FIX: Load complete fresh data instead of using partial updatedData
                loadSingleProductData(parseInt(rowNum));

                const failedFieldNames = failed.map(f => f.call?.field || 'unknown').join(', ');
                showWarningMessage(`⚠️ Product partially updated\n\n${succeeded.length}/${totalFields} fields saved successfully.\n\n${failed.length} fields had issues: ${failedFieldNames}\n\nYour main changes were saved!`);

            } else {
                // ❌ COMPLETE FAILURE (no fields saved)
                console.error('❌ Complete save failure');
                const errorDetails = failed.map(f => {
                    const call = f.call || {};
                    return `${call.field || 'unknown field'}: ${f.error || 'unknown error'}`;
                }).join('\n');

                showErrorMessage(`❌ Failed to save changes\n\nNo fields could be updated. There may be a server issue.\n\nErrors:\n${errorDetails}`);
            }
        })
        .catch(error => {
            console.error('❌ Network/Promise error:', error);

            // Restore button state
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;

            showErrorMessage('❌ Network error saving changes\n\nPlease check your internet connection and try again.\n\nError: ' + error.message);
        });
}


function collectFormData(collectionName) {
    console.log(`📋 Collecting form data for ${collectionName}...`);
    const data = {};

    // Collect basic fields
    const basicFields = [
        'editSku', 'editTitle', 'editVendor', 'editImageUrl','editRrpPrice','editSalePrice',
        'editWeight', 'editTags', 'editSeoTitle', 'editSeoDescription',
        'editBodyHtml', 'editFeatures'
    ];

    console.log('🔍 Checking basic fields...');
    basicFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element && element.value !== null && element.value !== undefined) {
            const value = String(element.value);
            if (value.trim() !== '') {
                const dataField = mapFieldIdToDataField(fieldId, collectionName);
                data[dataField] = value.trim();
            }
        }
    });

    // Collect dimension fields - SPECIAL HANDLING FOR SINKS
    if (collectionName === 'sinks') {
        console.log('🔍 Checking custom sink dimension fields...');

        const sinkDimensionFields = [
            'editLengthMm', 'editOverallWidthMm', 'editOverallDepthMm',
            'editMinCabinetSize', 'editCutoutSize', 'editBowlWidthMm',
            'editBowlDepthMm', 'editBowlHeightMm', 'editSecondBowlWidth',
            'editSecondBowlDepth', 'editSecondBowlHeight'
        ];

        sinkDimensionFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element && element.value && element.value.trim() !== '') {
                const dataField = mapFieldIdToDataField(fieldId, collectionName);
                data[dataField] = element.value.trim();
                console.log(`✅ Dimension field: ${fieldId} → ${dataField} = "${element.value}"`);
            }
        });
    }

    // Collect dynamic product fields INCLUDING MULTISELECT HANDLING
    const fieldConfig = getCollectionFieldConfig(collectionName);
    const productFields = fieldConfig.productFields || [];

    // For non-sink collections, also collect standard dimension fields
    let dimensionFields = [];
    if (fieldConfig.dimensionFields && fieldConfig.dimensionFields !== 'CUSTOM_SINK_DIMENSIONS') {
        dimensionFields = fieldConfig.dimensionFields;
    }

    const allDynamicFields = [...productFields, ...dimensionFields];

    console.log(`🔍 Checking ${allDynamicFields.length} dynamic product fields for ${collectionName}...`);
    allDynamicFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element && element.value !== null && element.value !== undefined) {

            // 🎯 SPECIAL HANDLING FOR MULTISELECT FIELDS
            if (field.type === 'multiselect') {
                // Get all selected options
                const selectedOptions = Array.from(element.selectedOptions).map(option => option.value);

                if (selectedOptions.length > 0) {
                    const dataField = mapFieldIdToDataField(field.id, collectionName);
                    // Join multiple selections with commas
                    data[dataField] = selectedOptions.join(', ');
                    console.log(`✅ Multiselect field: ${field.id} → ${dataField} = "${data[dataField]}" (${selectedOptions.length} options)`);
                } else {
                    console.log(`⏭️ Skipping multiselect field: ${field.id} (no selections)`);
                }
            }
            // 🎯 SPECIAL HANDLING FOR SHOPIFY STATUS - Always collect to save to Column AM
            else if (field.id === 'editShopifyStatus') {
                const value = String(element.value);
                const dataField = mapFieldIdToDataField(field.id, collectionName);
                // Always collect shopify_status, even if empty (to clear the field)
                data[dataField] = value.trim();
                console.log(`✅ Shopify Status field: ${field.id} → ${dataField} = "${data[dataField]}" (will save to Column AM)`);
            }
            // 🎯 STANDARD FIELD HANDLING
            else {
                const value = String(element.value);
                if (value.trim() !== '') {
                    const dataField = mapFieldIdToDataField(field.id, collectionName);
                    data[dataField] = value.trim();
                    console.log(`✅ Dynamic field: ${field.id} → ${dataField} = "${element.value}"`);
                }
            }
        } else {
            console.log(`⏭️ Skipping dynamic field: ${field.id} (empty or not found)`);
        }
    });

    // 🔍 COLLECT CONTENT FIELDS (e.g., spec sheet, care instructions)
    if (fieldConfig && fieldConfig.contentFields) {
        console.log(`🔍 Checking ${fieldConfig.contentFields.length} content fields for ${collectionName}...`);

        fieldConfig.contentFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element && element.value !== null && element.value !== undefined) {
                const value = String(element.value);
                if (value.trim() !== '') {
                    const dataField = mapFieldIdToDataField(field.id, collectionName);
                    data[dataField] = value.trim();
                    console.log(`✅ Content field: ${field.id} → ${dataField} = "${element.value}"`);
                }
            } else {
                console.log(`⏭️ Skipping content field: ${field.id} (empty or not found)`);
            }
        });
    }

    console.log(`📊 Total fields collected: ${Object.keys(data).length}`);
    console.log(`📋 Collected data:`, data);
    return data;
}

// ===============================
// WORKING IMPLEMENTATIONS - UPDATED FUNCTIONS
// ===============================

function extractSingleProductWithStatus(event) {
    event.preventDefault();
    const rowNum = document.getElementById('editRowNum').value;

    if (!rowNum) {
        showErrorMessage('No product row selected');
        return;
    }

    console.log(`🤖 Starting automated AI extraction + cleaning for product ${rowNum}`);

    // Show status in modal
    const statusBadge = document.getElementById('modalStatusBadge');
    if (statusBadge) {
        statusBadge.textContent = 'Extracting...';
        statusBadge.className = 'badge bg-warning ms-3';
        statusBadge.style.display = 'inline';
    }

    // STEP 1: Uncheck the cleaning checkbox first (new data incoming)
    uncheckCleaningCheckbox(rowNum)
        .then(() => {
            // STEP 2: Start AI extraction animation
            startAIExtractionAnimation();

            // STEP 3: Call the extraction API
            return fetch(`/api/${COLLECTION_NAME}/process/extract`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    selected_rows: [parseInt(rowNum)],
                    overwrite_mode: true
                })
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ AI extraction successful, starting auto-cleaning...');

                if (statusBadge) {
                    statusBadge.textContent = 'Extraction Complete - Auto Cleaning...';
                    statusBadge.className = 'badge bg-info ms-3';
                }

                // STEP 4: Check the checkbox to trigger Apps Script cleaning
                return checkCleaningCheckbox(rowNum);
            } else {
                throw new Error(data.message || 'AI extraction failed');
            }
        })
        .then(() => {
            // STEP 5: Monitor for cleaning completion and update modal
            return monitorCleaningAndUpdateModal(rowNum);
        })
        .catch(error => {
            console.error('❌ Error in extraction/cleaning pipeline:', error);

            if (statusBadge) {
                statusBadge.textContent = 'Pipeline Failed';
                statusBadge.className = 'badge bg-danger ms-3';
            }

            stopAIExtractionAnimation();
            showErrorMessage(`Pipeline failed: ${error.message}`);
        });
}
// Uncheck the cleaning checkbox in Google Sheets
function uncheckCleaningCheckbox(rowNum) {
    console.log(`📋 Unchecking cleaning checkbox for row ${rowNum}...`);

    return fetch(`/api/${COLLECTION_NAME}/update-checkbox`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            row: parseInt(rowNum),
            column: 57, // Column BE
            value: false,
            reason: 'AI extraction starting - new data incoming'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Cleaning checkbox unchecked');
        } else {
            console.warn('⚠️ Could not uncheck cleaning checkbox:', data.error);
        }
    })
    .catch(error => {
        console.warn('⚠️ Error unchecking checkbox:', error);
        // Don't fail the pipeline for this
    });
}

// Check the cleaning checkbox to trigger Apps Script
function checkCleaningCheckbox(rowNum) {
    console.log(`📋 Checking cleaning checkbox to trigger Apps Script for row ${rowNum}...`);

    return fetch(`/api/${COLLECTION_NAME}/update-checkbox`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            row: parseInt(rowNum),
            column: 57, // Column BE
            value: true,
            reason: 'AI extraction complete - triggering auto-clean'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Cleaning checkbox checked - Apps Script should trigger');
            return data;
        } else {
            throw new Error(data.error || 'Failed to check cleaning checkbox');
        }
    });
}


// Monitor for cleaning completion and update modal
function monitorCleaningAndUpdateModal(rowNum) {
    console.log(`👀 Monitoring cleaning completion for row ${rowNum}...`);

    const statusBadge = document.getElementById('modalStatusBadge');
    let attempts = 0;
    const maxAttempts = 20; // 10 seconds max

    return new Promise((resolve, reject) => {
        const checkCleaningStatus = () => {
            attempts++;

            // Check if cleaning is complete by monitoring checkbox status/notes
            fetch(`/api/${COLLECTION_NAME}/get-checkbox-status/${rowNum}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const checkboxData = data.checkbox;

                        // Check if Apps Script has completed (checkbox has completion note)
                        if (checkboxData.note && checkboxData.note.includes('Cleaning Complete')) {
                            console.log('✅ Apps Script cleaning completed!');

                            if (statusBadge) {
                                statusBadge.textContent = 'Pipeline Complete!';
                                statusBadge.className = 'badge bg-success ms-3';
                            }

                            // Show success animations
                            showExtractionSuccess();

                            // STEP 6: Reload fresh cleaned data into modal
                            setTimeout(() => {
                                loadProductIntoModal(rowNum);
                                showSuccessMessage('AI extraction and auto-cleaning completed successfully!');
                                resolve();
                            }, 1500);

                        } else if (checkboxData.note && checkboxData.note.includes('failed')) {
                            console.error('❌ Apps Script cleaning failed');
                            reject(new Error('Auto-cleaning failed'));

                        } else if (attempts >= maxAttempts) {
                            console.warn('⏱️ Cleaning monitoring timed out');

                            if (statusBadge) {
                                statusBadge.textContent = 'Cleaning Timeout';
                                statusBadge.className = 'badge bg-warning ms-3';
                            }

                            // Still load the data and show partial success
                            loadProductIntoModal(rowNum);
                            showWarningMessage('AI extraction completed, but auto-cleaning status unclear. Please check the Google Sheet.');
                            resolve();

                        } else {
                            // Continue monitoring
                            setTimeout(checkCleaningStatus, 500);
                        }
                    } else {
                        setTimeout(checkCleaningStatus, 500);
                    }
                })
                .catch(error => {
                    console.warn('⚠️ Error checking cleaning status:', error);
                    setTimeout(checkCleaningStatus, 500);
                });
        };

        // Start monitoring after a brief delay
        setTimeout(checkCleaningStatus, 1000);
    });
}


function generateSingleDescription(event) {
    event.preventDefault();
    const rowNum = document.getElementById('editRowNum').value;

    if (!rowNum) {
        showErrorMessage('No product row selected');
        return;
    }

    console.log(`📝 Generating description and care instructions for product ${rowNum} from modal`);

    // Show status in modal
    const statusBadge = document.getElementById('modalStatusBadge');
    if (statusBadge) {
        statusBadge.textContent = 'Generating Content...';
        statusBadge.className = 'badge bg-info ms-3';
        statusBadge.style.display = 'inline';
    }

    // Start description-specific animation
    animateDescriptionGeneration();

    // Use the existing endpoint that works
    fetch(`/api/${COLLECTION_NAME}/products/${rowNum}/generate-description`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            use_url_content: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Content generation successful:', data);

            if (statusBadge) {
                statusBadge.textContent = 'Content Generated!';
                statusBadge.className = 'badge bg-success ms-3';
            }

            showDescriptionSuccess();

            setTimeout(() => {
                loadProductIntoModal(rowNum);
            }, 1000);

            showSuccessMessage('Description and care instructions generated successfully!');
        } else {
            console.error('❌ Content generation failed:', data.error);

            if (statusBadge) {
                statusBadge.textContent = 'Generation Failed';
                statusBadge.className = 'badge bg-danger ms-3';
            }

            showErrorMessage(`Content generation failed: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('❌ Error during content generation:', error);

        if (statusBadge) {
            statusBadge.textContent = 'Error';
            statusBadge.className = 'badge bg-danger ms-3';
        }

        showErrorMessage(`Error during content generation: ${error.message}`);
    });
}
// Add these functions in collection.html <script> section
async function validateSpecSheet(rowNum) {
    const specSheetField = document.getElementById('editShopifySpecSheet');
    const fieldWrapper = specSheetField?.parentElement;

    try {
        const productData = productsData[rowNum];
        const specSheetUrl = productData.shopify_spec_sheet || specSheetField?.value;
        const productSku = productData.variant_sku;
        const productTitle = productData.title;

        if (!specSheetUrl || !productSku) {
            setSpecSheetStatus('error', 'Missing spec sheet URL or SKU');
            return { valid: false, reason: 'Missing spec sheet URL or SKU' };
        }

        // Show loading state
        setSpecSheetStatus('loading', 'Validating spec sheet...');

        // Call backend validation
        const response = await fetch(`/api/${COLLECTION_NAME}/validate-spec-sheet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                spec_sheet_url: specSheetUrl,
                expected_sku: productSku,
                expected_title: productTitle,
                row_num: rowNum
            })
        });

        const result = await response.json();

        // Set visual feedback based on result
        if (result.valid) {
            setSpecSheetStatus('valid', `✓ Spec sheet matches product (SKU: ${result.found_sku})`);
        } else {
            setSpecSheetStatus('invalid', `✗ ${result.reason}`);
        }

        return result;

    } catch (error) {
        setSpecSheetStatus('error', `Validation error: ${error.message}`);
        return { valid: false, reason: `Validation error: ${error.message}` };
    }
}

function setSpecSheetStatus(status, message) {
    const specSheetField = document.getElementById('editShopifySpecSheet');
    const fieldWrapper = specSheetField?.parentElement?.parentElement; // Account for input-group

    if (!fieldWrapper) return;

    // Remove existing status classes
    fieldWrapper.classList.remove('spec-valid', 'spec-invalid', 'spec-loading', 'spec-error');

    // Remove existing status message
    const existingStatus = fieldWrapper.querySelector('.spec-status-message');
    if (existingStatus) existingStatus.remove();

    // Add appropriate class and message
    switch(status) {
        case 'valid':
            fieldWrapper.classList.add('spec-valid');
            break;
        case 'invalid':
            fieldWrapper.classList.add('spec-invalid');
            break;
        case 'loading':
            fieldWrapper.classList.add('spec-loading');
            break;
        case 'error':
            fieldWrapper.classList.add('spec-error');
            break;
    }

    // Add status message
    if (message) {
        const statusDiv = document.createElement('div');
        statusDiv.className = 'spec-status-message';
        statusDiv.textContent = message;
        fieldWrapper.appendChild(statusDiv);
    }
}

function cleanCurrentProductDataWithStatus() {
    const rowNum = parseInt($('#editRowNum').val());
    const collectionName = $('#editCollectionName').val() || COLLECTION_NAME;

    if (!rowNum || isNaN(rowNum)) {
        showErrorMessage('No product row selected for cleaning');
        return;
    }

    console.log(`🧹 Starting data cleaning for ${collectionName} product ${rowNum}...`);

    // Show status in modal badge
    const statusBadge = document.getElementById('modalStatusBadge');
    if (statusBadge) {
        statusBadge.textContent = 'Cleaning Data...';
        statusBadge.className = 'badge bg-warning ms-3';
        statusBadge.style.display = 'inline';
    }

    // Update the clean button to show loading state
    const cleanBtn = document.getElementById('cleanCurrentDataBtn');
    const originalBtnText = cleanBtn ? cleanBtn.innerHTML : '';
    if (cleanBtn) {
        cleanBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Cleaning...';
        cleanBtn.disabled = true;
    }

    // Start cleaning animation
    startCleaningAnimation();

    // Call the collection-agnostic cleaning endpoint
    fetch(`/api/${collectionName}/process/clean`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            selected_rows: [rowNum]  // Single product cleaning
        })
    })
    .then(response => {
        console.log(`📡 Cleaning API response status: ${response.status}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('📨 Cleaning API response:', data);

        if (data.success) {
            console.log('✅ Data cleaning successful:', data);

            // Update status badge to success
            if (statusBadge) {
                statusBadge.textContent = 'Cleaning Complete!';
                statusBadge.className = 'badge bg-success ms-3';
            }

            // Show cleaning success animation
            showCleaningSuccess();

            // ⭐ NEW: UPDATE THE CHECKBOX IN GOOGLE SHEETS
            console.log('📋 Also updating checkbox for cleaned product...');
            updateCheckboxAfterCleaning(rowNum, collectionName);

            // Show success message with details
            const message = data.message || 'Data cleaning completed successfully!';
            const successCount = data.successCount || 1;
            const errorCount = data.errorCount || 0;

            let detailedMessage = `🧹 ${message}`;
            if (successCount > 0) {
                detailedMessage += `\n\n✅ Successfully cleaned: ${successCount} row(s)`;
            }
            if (errorCount > 0) {
                detailedMessage += `\n⚠️ Errors encountered: ${errorCount} row(s)`;
            }
            detailedMessage += `\n✅ Checkbox updated in Google Sheets`;

            showSuccessMessage(detailedMessage);

            // Refresh the modal with cleaned data after a short delay
            setTimeout(() => {
                fetchAndUpdateModalData(rowNum);
            }, 1500);

        } else {
            // Handle API failure
            console.error('❌ Data cleaning failed:', data.message || data.error);

            if (statusBadge) {
                statusBadge.textContent = 'Cleaning Failed';
                statusBadge.className = 'badge bg-danger ms-3';
            }

            // Stop cleaning animation on failure
            stopCleaningAnimation();

            const errorMessage = data.message || data.error || 'Unknown cleaning error';
            showErrorMessage(`Data cleaning failed: ${errorMessage}`);
        }
    })
    .catch(error => {
        // Handle network/request errors
        console.error('❌ Error during data cleaning request:', error);

        if (statusBadge) {
            statusBadge.textContent = 'Cleaning Error';
            statusBadge.className = 'badge bg-danger ms-3';
        }

        // Stop cleaning animation on error
        stopCleaningAnimation();

        showErrorMessage(`Error during data cleaning: ${error.message}`);
    })
    .finally(() => {
        // Always restore the clean button state
        if (cleanBtn) {
            cleanBtn.innerHTML = originalBtnText || '<i class="fas fa-broom me-1"></i> Clean Data';
            cleanBtn.disabled = false;
        }

        // Hide status badge after a delay
        setTimeout(() => {
            if (statusBadge) {
                statusBadge.style.display = 'none';
            }
        }, 3000);
    });
}

function updateCheckboxAfterCleaning(rowNum, collectionName) {
    console.log(`📋 Updating checkbox for row ${rowNum} after cleaning...`);

    // Create checkbox state for this single product (set to checked/TRUE)
    const checkboxState = [{
        row: rowNum,
        checked: true
    }];

    // Use the same sync function as the main checkboxes
    fetch(`/api/${collectionName}/sync-checkboxes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            collection: collectionName,
            checkbox_states: checkboxState,
            timestamp: new Date().toISOString(),
            source: 'modal_clean_data'  // Add identifier
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('✅ Checkbox updated in Google Sheets after cleaning:', data);

            // ⭐ ALSO UPDATE THE MAIN PAGE CHECKBOX VISUALLY
            const mainPageCheckbox = $(`.product-checkbox[data-row="${rowNum}"]`);
            if (mainPageCheckbox.length) {
                mainPageCheckbox.prop('checked', true);
                console.log(`✅ Also checked the main page checkbox for row ${rowNum}`);
            }

            // Show brief success indicator
            showSyncSuccess();
        } else {
            console.error('❌ Failed to update checkbox after cleaning:', data.error);
        }
    })
    .catch(error => {
        console.error('❌ Error updating checkbox after cleaning:', error);
    });
}

// Helper function to refresh modal data after cleaning
function fetchAndUpdateModalData(rowNum) {
    console.log(`🔄 Refreshing modal data for row ${rowNum} after cleaning...`);

    fetch(`/api/${COLLECTION_NAME}/products/${rowNum}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`✅ Successfully refreshed data for product ${rowNum}`);

                // Update the global products data
                productsData[rowNum] = data.product;

                // Repopulate the modal fields with cleaned data
                populateBasicFields(data.product);
                populateDynamicFields(data.product, COLLECTION_NAME);
                updateProductImagePreview(data.product);

                // Update the product card in the background
                updateProductCard(rowNum, data.product, false);

                // Highlight cleaned fields with success styling
                highlightCleanedFields();

                console.log(`🎯 Modal refreshed with cleaned data for product ${rowNum}`);
            } else {
                console.error(`❌ Failed to refresh data for product ${rowNum}:`, data.error);
                showWarningMessage(`Cleaning completed, but couldn't refresh the display. Please close and reopen the product.`);
            }
        })
        .catch(error => {
            console.error(`❌ Error refreshing data for product ${rowNum}:`, error);
            showWarningMessage(`Cleaning completed, but couldn't refresh the display. Please close and reopen the product.`);
        });
}

function highlightCleanedFields() {
    console.log('✨ Highlighting cleaned fields...');

    // Add temporary highlight to all form fields that have values
    $('input, select, textarea').each(function() {
        const $field = $(this);
        const value = $field.val();

        if (value && value.toString().trim() !== '') {
            $field.addClass('field-cleaned');

            // Add a temporary success indicator
            const $wrapper = $field.parent();
            if ($wrapper.length && !$wrapper.find('.cleaned-indicator').length) {
                const $indicator = $('<div class="cleaned-indicator">').html('<i class="fas fa-broom"></i>');
                $indicator.css({
                    'position': 'absolute',
                    'top': '5px',
                    'right': '5px',
                    'color': '#667eea',
                    'font-size': '14px',
                    'z-index': '10',
                    'animation': 'cleanedPop 0.8s ease-out'
                });

                $wrapper.css('position', 'relative');
                $wrapper.append($indicator);

                // Remove indicator after 3 seconds
                setTimeout(() => {
                    $indicator.remove();
                    $field.removeClass('field-cleaned');
                }, 3000);
            }
        }
    });
}


// ===============================
// DATA LOADING - COLLECTION AGNOSTIC
// ===============================
function loadProductData() {
    console.log(`📊 Loading product data for ${COLLECTION_NAME}...`);

    // Show loading spinner
    $('#loadingSpinner').show();
    $('#productsGrid').hide();
    $('#errorState').hide();

    // Load collection statistics
    fetch(`/api/${COLLECTION_NAME}/stats`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDashboardStats(data.stats);
            } else {
                console.error('Failed to load stats:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });

    // Load all products for this collection
    fetch(`/api/${COLLECTION_NAME}/products/all`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`✅ Loaded ${data.total_count} products for ${COLLECTION_NAME}`);

                // Store products data globally
                productsData = data.products;

                // Update each card with real data
                const productKeys = Object.keys(data.products);
                productKeys.forEach((rowNum, index) => {
                    setTimeout(() => {
                        const productData = data.products[rowNum];
                        updateProductCard(parseInt(rowNum), productData);
                    }, index * 10); // Small delay between each card
                });

                // Hide loading, show grid
                setTimeout(() => {
                    $('#loadingSpinner').hide();
                    $('#productsGrid').show();
                }, productKeys.length * 10 + 500);

            } else {
                console.error('Failed to load products:', data.error);
                showErrorState('Failed to load product data: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error loading products:', error);
            showErrorState('Error connecting to server: ' + error.message);
        });
}

// ===============================
// FIXED: updateProductCard function with correct SKU field
// ===============================

function updateProductCard(rowNum, newData, mergeWithExisting = false) {
    console.log(`🔄 Updating card ${rowNum} for ${COLLECTION_NAME}`);

    // ✅ FIX: Merge with existing data if requested to prevent data loss
    let data = newData;
    if (mergeWithExisting && productsData[rowNum]) {
        console.log('🔄 Merging with existing product data...');
        data = { ...productsData[rowNum], ...newData };
        console.log('📊 Merged data:', data);
    }

    // Update basic product information
    $(`#product-title-${rowNum}`).text(data.title || 'Untitled Product');
    $(`#product-sku-${rowNum}`).text(data.variant_sku || 'No SKU');
    $(`#product-vendor-${rowNum}`).text(data.vendor || '-');

    // Update product image
    updateProductCardImage(rowNum, data);

    // Update specifications dynamically based on collection type
    updateProductSpecs(rowNum, data);

    // Update quality bar
    const quality = data.quality_score || 0;
    updateQualityBar(rowNum, quality);

    // Update missing info badges
    updateMissingBadges(rowNum, data);

    // Update card class based on completeness
    updateCardClass(rowNum, quality);

    // Store complete data globally
    productsData[rowNum] = data;

    console.log(`✅ Updated product card ${rowNum} with quality: ${quality}%`);
}

function updateProductCardImage(rowNum, data) {
    const imageContainer = $(`#product-image-${rowNum}`);

    // ✅ Use the correct field name from your backend
    const imageUrl = data.shopify_images || '';

    if (imageUrl && imageUrl.trim() !== '' && imageUrl !== '-' && isValidImageUrl(imageUrl)) {
        // Show loading state
        imageContainer.html('<i class="fas fa-spinner fa-spin text-primary"></i>');

        // Load image
        const img = new Image();
        img.onload = function() {
            imageContainer.html(`<img src="${imageUrl}" alt="Product Image" style="width: 100%; height: 100%; object-fit: cover;">`);
        };
        img.onerror = function() {
            imageContainer.html('<i class="fas fa-image-slash text-muted"></i><br><small>Image unavailable</small>');
        };
        img.src = imageUrl;
    } else {
        imageContainer.html('<i class="fas fa-image text-muted"></i>');
    }
}

function updateProductSpecs(rowNum, data) {
    const specsContainer = $(`#product-specs-${rowNum}`);
    specsContainer.empty();

    // Get collection-specific specification fields
    const specFields = getCollectionSpecFields(COLLECTION_NAME);

    specFields.forEach(spec => {
        const value = data[spec.field] || '-';
        const hasValue = value && value.toString().trim() !== '' && value !== '-';

        // ✅ SPECIAL STYLING FOR SHOPIFY STATUS FROM COLUMN AM
        let statusClass = '';
        let statusIcon = '';
        if (spec.field === 'shopify_status') {
            if (value === 'Active') {
                statusClass = 'text-success fw-bold';
                statusIcon = '🟢 ';
            } else if (value === 'Draft') {
                statusClass = 'text-warning fw-bold';
                statusIcon = '🟡 ';
            } else {
                statusClass = 'text-muted';
                statusIcon = '⚪ ';
            }
        }

        specsContainer.append(`
            <div class="spec-row">
                <span class="spec-label">${spec.label}:</span>
                <span class="spec-value ${hasValue ? '' : 'missing-specs'} ${statusClass}">
                    ${statusIcon}${hasValue ? value : '-'}
                </span>
            </div>
        `);
    });
}

// ===============================
// FIXED: getCollectionSpecFields with proper commas
// ===============================

function getCollectionSpecFields(collectionName) {
    // Return different specification fields based on collection type
    switch(collectionName) {
        case 'sinks':
            return [
                { field: 'product_material', label: 'Material' },
                { field: 'installation_type', label: 'Installation' },
                { field: 'bowls_number', label: 'Bowls' },
                { field: 'shopify_status', label: 'Status' }         // ✅ FIXED
            ];
        case 'taps':
            return [
                { field: 'tap_type', label: 'Type' },
                { field: 'material', label: 'Material' },
                { field: 'finish', label: 'Finish' },                // ✅ ADDED MISSING COMMA
                { field: 'shopify_status', label: 'Status' }         // ✅ FIXED
            ];
        case 'lighting':
            return [
                { field: 'light_type', label: 'Type' },
                { field: 'bulb_type', label: 'Bulb' },
                { field: 'wattage', label: 'Wattage' },              // ✅ ADDED MISSING COMMA
                { field: 'shopify_status', label: 'Status' }         // ✅ FIXED
            ];
        default:
            return [
                { field: 'type', label: 'Type' },
                { field: 'material', label: 'Material' },
                { field: 'style', label: 'Style' },                  // ✅ ADDED MISSING COMMA
                { field: 'shopify_status', label: 'Status' }         // ✅ FIXED
            ];
    }
}

function updateBowlDimensionsVisibility() {
    const bowlCount = $('#editNumberOfBowls').val();
    console.log(`🔍 Checking bowl count: "${bowlCount}"`);

    // Hide all conditional fields first
    $('.conditional-bowls_number-2').removeClass('show').hide();

    // Show second bowl fields if 2 bowls selected
    if (bowlCount === '2' || bowlCount === 2) {
        console.log('✅ Showing second bowl dimensions (2 bowls detected)');
        $('.conditional-bowls_number-2').addClass('show').show();
    }
}


function updateQualityBar(rowNum, quality) {
    const bar = $(`#quality-bar-${rowNum}`);
    const text = $(`#quality-text-${rowNum}`);

    const qualityNum = Math.max(0, Math.min(100, parseInt(quality) || 0));

    bar.css('width', `${qualityNum}%`);
    text.text(`${qualityNum}% complete`);

    // Update color based on quality
    bar.removeClass('quality-poor quality-fair quality-good quality-excellent');
    if (qualityNum >= 90) {
        bar.addClass('quality-excellent');
    } else if (qualityNum >= 70) {
        bar.addClass('quality-good');
    } else if (qualityNum >= 40) {
        bar.addClass('quality-fair');
    } else {
        bar.addClass('quality-poor');
    }
}

function updateMissingBadges(rowNum, data) {
    const container = $(`#missing-badges-${rowNum}`);
    const missing = [];

    // Check critical fields that are common across collections
    const criticalFields = [
        { key: 'variant_sku', display: 'SKU' },  // ✅ FIXED: Use variant_sku
        { key: 'title', display: 'Title' },
        { key: 'vendor', display: 'Vendor' }
    ];

    criticalFields.forEach(field => {
        const value = data[field.key];
        if (!value || value.toString().trim() === '' || value === '-') {
            missing.push(field.display);
        }
    });

    // Check for image
    const imageFields = ['shopify_images'];  // ✅ FIXED: Use correct field name
    let hasImage = imageFields.some(field => {
        const value = data[field];
        return value && value.toString().trim() !== '' && value !== '-';
    });

    if (!hasImage) missing.push('image');

    // Clear and update container
    container.empty();
    if (missing.length === 0) {
        container.append('<span class="complete-badge">Complete</span>');
    } else {
        missing.forEach(field => {
            container.append(`<span class="missing-badge">${field}</span>`);
        });
    }
}

function updateCardClass(rowNum, quality) {
    const card = $(`#product-card-${rowNum}`);
    card.removeClass('missing-critical missing-some complete');

    const qualityNum = parseInt(quality) || 0;

    if (qualityNum >= 80) {
        card.addClass('complete');
    } else if (qualityNum >= 40) {
        card.addClass('missing-some');
    } else {
        card.addClass('missing-critical');
    }
}

function updateDashboardStats(stats) {
    if (stats) {
        $('#completeProducts').text(stats.complete_products || 0);
        $('#missingInfoProducts').text(stats.missing_info_products || 0);
        $('#dataQualityPercent').text(`${stats.data_quality_percent || 0}%`);
        $('#totalProducts').text(stats.total_products || 0);
    }
}

function showErrorState(errorMessage) {
    $('#loadingSpinner').hide();
    $('#productsGrid').hide();
    $('#errorMessage').text(errorMessage);
    $('#errorState').show();
}

// ===============================
// UTILITY FUNCTIONS
// ===============================

function isValidImageUrl(url) {
    if (!url || typeof url !== 'string') return false;

    try {
        new URL(url);
    } catch {
        return false;
    }

    const imagePatterns = [
        /\.(jpg|jpeg|png|gif|bmp|webp|svg)(\?.*)?$/i,
        /amazonaws\.com.*\.(jpg|jpeg|png|gif|bmp|webp)/i,
        /cloudfront\.net.*\.(jpg|jpeg|png|gif|bmp|webp)/i,
        /images\./i,
        /media\./i,
        /cdn\./i
    ];

    return imagePatterns.some(pattern => pattern.test(url));
}

function setupEventListeners() {
    console.log('🔧 Setting up event listeners...');

    // Search functionality
    $('#searchInput').on('keyup', function() {
        filterProductsGrid();
    });

    // Select all products
    $('#selectAllProducts').on('change', function() {
        console.log('🔄 Select All clicked:', this.checked);
        $('.product-checkbox').prop('checked', this.checked);
        updateSelectedProductsWithBackend();
    });

    // ⭐ CRITICAL: Individual product selection
    $(document).on('change', '.product-checkbox', function() {
        console.log('🔄 Individual checkbox clicked:', $(this).data('row'), this.checked);
        updateSelectedProductsWithBackend();
    });

    // Tags input handling
    $(document).on('input', '#editTags', function() {
        displayTagsAsBadges(this.value, 'tagsDisplay');
    });

    // Bowl dimensions visibility
    $(document).on('change', '#editNumberOfBowls', function() {
        updateBowlDimensionsVisibility();
    });

    console.log('✅ Event listeners set up successfully');
}

function updateSelectedProductsWithBackend() {
    // Update local array first
    selectedProducts = [];
    const checkedBoxes = [];

    $('.product-checkbox:checked').each(function() {
        const rowNum = $(this).data('row');
        selectedProducts.push(rowNum);
        checkedBoxes.push({
            row: rowNum,
            checked: true
        });
    });

    // Also track unchecked boxes for complete state sync
    const uncheckedBoxes = [];
    $('.product-checkbox:not(:checked)').each(function() {
        const rowNum = $(this).data('row');
        uncheckedBoxes.push({
            row: rowNum,
            checked: false
        });
    });

    // Combine all checkbox states
    const allCheckboxStates = [...checkedBoxes, ...uncheckedBoxes];

    console.log(`✅ Selected products: ${selectedProducts.length}`);
    console.log(`📊 Total checkbox states to sync: ${allCheckboxStates.length}`);

    // Trigger Google Sheets update via backend API
    syncCheckboxStatesToBackend(allCheckboxStates);

    // Update UI elements
    updateSelectionUI();
}

function syncCheckboxStatesToBackend(checkboxStates) {
    // Don't send if no checkboxes (initial load state)
    if (checkboxStates.length === 0) {
        console.log('⏭️ Skipping backend sync - no checkbox states to sync');
        return;
    }

    console.log(`📡 Syncing ${checkboxStates.length} checkbox states to Google Sheets...`);

    // Show subtle loading indicator
    showSyncIndicator(true);

    // Make API call to backend
    fetch(`/api/${COLLECTION_NAME}/sync-checkboxes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            collection: COLLECTION_NAME,
            checkbox_states: checkboxStates,
            timestamp: new Date().toISOString()
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log('✅ Google Sheets checkbox sync successful:', data);

            // Show success indicator briefly
            showSyncSuccess();

            // Optional: Show how many rows were updated
            if (data.updated_rows > 0) {
                console.log(`📝 Updated ${data.updated_rows} rows in Google Sheets`);
            }
        } else {
            console.error('❌ Google Sheets checkbox sync failed:', data.error);
            showSyncError(`Sync failed: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('❌ Error syncing checkbox states to Google Sheets:', error);
        showSyncError(`Sync error: ${error.message}`);
    })
    .finally(() => {
        // Hide loading indicator
        showSyncIndicator(false);
    });
}

function showSyncIndicator(show) {
    if (show) {
        if (!$('#syncIndicator').length) {
            $('body').append(`
                <div id="syncIndicator" style="
                    position: fixed; top: 20px; right: 20px;
                    background: rgba(102, 126, 234, 0.9); color: white;
                    padding: 8px 16px; border-radius: 20px; font-size: 14px;
                    z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                ">
                    <i class="fas fa-sync-alt fa-spin me-2"></i>Syncing to Google Sheets...
                </div>
            `);
        }
    } else {
        $('#syncIndicator').remove();
    }
}

function showSyncSuccess() {
    $('body').append(`
        <div id="syncSuccess" style="
            position: fixed; top: 20px; right: 20px;
            background: rgba(40, 167, 69, 0.9); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 14px;
            z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        ">
            <i class="fas fa-check me-2"></i>Synced to Google Sheets
        </div>
    `);

    setTimeout(() => {
        $('#syncSuccess').fadeOut(300, function() { $(this).remove(); });
    }, 2000);
}

function showSyncError(message) {
    console.error('📛 Sync Error:', message);
    $('body').append(`
        <div id="syncError" style="
            position: fixed; top: 20px; right: 20px;
            background: rgba(220, 53, 69, 0.9); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 14px;
            z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        ">
            <i class="fas fa-exclamation-triangle me-2"></i>Sync Error
        </div>
    `);

    setTimeout(() => {
        $('#syncError').fadeOut(300, function() { $(this).remove(); });
    }, 3000);
}

function updateSelectionUI() {
    const totalCheckboxes = $('.product-checkbox').length;
    const checkedCheckboxes = $('.product-checkbox:checked').length;

    if (checkedCheckboxes === 0) {
        $('#selectAllProducts').prop('indeterminate', false).prop('checked', false);
    } else if (checkedCheckboxes === totalCheckboxes) {
        $('#selectAllProducts').prop('indeterminate', false).prop('checked', true);
    } else {
        $('#selectAllProducts').prop('indeterminate', true);
    }
}

function updateSelectedProducts() {
    selectedProducts = [];
    $('.product-checkbox:checked').each(function() {
        selectedProducts.push($(this).data('row'));
    });

    console.log(`✅ Selected products: ${selectedProducts.length}`);
}

// ===============================
// WORKING IMPLEMENTATIONS - UPDATED FUNCTIONS
// ===============================

function extractFromURL(rowNum) {
    console.log(`🤖 Starting AI extraction for row ${rowNum} in ${COLLECTION_NAME}`);

    // Show loading state on button
    const actionBtn = event && event.target ? event.target.closest('.action-btn') : null;
    let originalHTML = '';
    if (actionBtn) {
        originalHTML = actionBtn.innerHTML;
        actionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        actionBtn.disabled = true;
    }

    // Call the backend API for single product extraction
    fetch(`/api/${COLLECTION_NAME}/process/extract`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            selected_rows: [parseInt(rowNum)],
            overwrite_mode: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ AI extraction successful:', data);
            showSuccessMessage(`AI extraction completed for product ${rowNum}!`);

            // Refresh the product data
            loadSingleProductData(rowNum);
        } else {
            console.error('❌ AI extraction failed:', data.message);
            showErrorMessage(`AI extraction failed: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('❌ Error during AI extraction:', error);
        showErrorMessage(`Error during AI extraction: ${error.message}`);
    })
    .finally(() => {
        // Restore button
        if (actionBtn) {
            actionBtn.innerHTML = originalHTML;
            actionBtn.disabled = false;
        }
    });
}

function cleanProductData(rowNum) {
    console.log(`🧹 Cleaning data for row ${rowNum} in ${COLLECTION_NAME}`);

    // Show loading state on button
    const actionBtn = event && event.target ? event.target.closest('.action-btn') : null;
    let originalHTML = '';
    if (actionBtn) {
        originalHTML = actionBtn.innerHTML;
        actionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        actionBtn.disabled = true;
    }

    // Call the backend API for data cleaning
    fetch(`/api/${COLLECTION_NAME}/process/clean`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            selected_rows: [parseInt(rowNum)]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Data cleaning successful:', data);
            showSuccessMessage(`Data cleaning completed for product ${rowNum}!`);

            // Refresh the product data
            loadSingleProductData(rowNum);
        } else {
            console.error('❌ Data cleaning failed:', data.message);
            showErrorMessage(`Data cleaning failed: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('❌ Error during data cleaning:', error);
        showErrorMessage(`Error during data cleaning: ${error.message}`);
    })
    .finally(() => {
        // Restore button
        if (actionBtn) {
            actionBtn.innerHTML = originalHTML;
            actionBtn.disabled = false;
        }
    });
}

function generateDescription(rowNum) {
    console.log(`📝 Generating description for row ${rowNum} in ${COLLECTION_NAME}`);

    // Show loading state on button
    const actionBtn = event && event.target ? event.target.closest('.action-btn') : null;
    let originalHTML = '';
    if (actionBtn) {
        originalHTML = actionBtn.innerHTML;
        actionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        actionBtn.disabled = true;
    }

    // Call the backend API for single description generation
    fetch(`/api/${COLLECTION_NAME}/products/${rowNum}/generate-description`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            use_url_content: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Description generation successful:', data);
            showSuccessMessage(`Description generated for product ${rowNum}!`);

            // Refresh the product data
            loadSingleProductData(rowNum);
        } else {
            console.error('❌ Description generation failed:', data.error);
            showErrorMessage(`Description generation failed: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('❌ Error during description generation:', error);
        showErrorMessage(`Error during description generation: ${error.message}`);
    })
    .finally(() => {
        // Restore button
        if (actionBtn) {
            actionBtn.innerHTML = originalHTML;
            actionBtn.disabled = false;
        }
    });
}

function openCompareWindow() {
    const rowNum = document.getElementById('editRowNum').value;
    if (!rowNum || !productsData[rowNum]) {
        showErrorMessage('No product data available for comparison');
        return;
    }

    const productData = productsData[rowNum];
    const urlToOpen = productData.url || productData.supplier_url || productData.product_url || productData['Column A'];

    if (!urlToOpen || urlToOpen.trim() === '' || urlToOpen === '-') {
        showErrorMessage('No supplier URL available for this product');
        return;
    }

    console.log('🔗 Opening compare window:', urlToOpen);
    window.open(urlToOpen, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
}

function addProductManually() {
    console.log('➕ Add product manually');
    showInfoMessage('Manual product addition feature coming soon!');
    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
}

function addProductWithAI() {
    console.log('🤖 Add product with AI');
    showInfoMessage('AI-powered product addition feature coming soon!');
    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
}

function startBulkUpload() {
    const skuInput = document.getElementById('bulkSkuInput');
    if (!skuInput || !skuInput.value.trim()) {
        showErrorMessage('Please enter SKUs to upload');
        return;
    }

    const skus = skuInput.value.trim().split('\n').filter(sku => sku.trim() !== '');
    if (skus.length === 0) {
        showErrorMessage('No valid SKUs found');
        return;
    }

    console.log('📤 Starting bulk upload for', skus.length, 'SKUs');
    showInfoMessage(`Bulk upload of ${skus.length} SKUs will be implemented soon!`);
    bootstrap.Modal.getInstance(document.getElementById('bulkUploadModal')).hide();
}

function refreshData() {
    console.log('🔄 Refreshing data...');
    location.reload();
}

function filterProducts(type) {
    currentFilter = type;
    $('.filter-btn').removeClass('active');
    $(`#filter-${type}`).addClass('active');
    filterProductsGrid();
}

function filterProductsGrid() {
    const searchTerm = $('#searchInput').val().toLowerCase();
    let visibleCount = 0;

    $('.product-card').each(function() {
        const card = $(this);
        const rowNum = card.data('row');
        const productData = productsData[rowNum];

        let showCard = true;

        // Apply filter
        if (currentFilter !== 'all') {
            switch(currentFilter) {
                case 'missing-critical':
                    showCard = card.hasClass('missing-critical');
                    break;
                case 'no-sku':
                    showCard = !productData || !productData.variant_sku || productData.variant_sku.trim() === '';  // ✅ FIXED
                    break;
                case 'complete':
                    showCard = card.hasClass('complete');
                    break;
            }
        }

        // Apply search
        if (showCard && searchTerm) {
            const title = productData ? (productData.title || '').toLowerCase() : '';
            const sku = productData ? (productData.variant_sku || '').toLowerCase() : '';  // ✅ FIXED
            const vendor = productData ? (productData.vendor || '').toLowerCase() : '';

            showCard = title.includes(searchTerm) || sku.includes(searchTerm) || vendor.includes(searchTerm);
        }

        if (showCard) {
            card.show();
            visibleCount++;
        } else {
            card.hide();
        }
    });

    $('#filteredCount').text(`${visibleCount} products`);
}

function showAIExtractionModal() {
    if (selectedProducts.length === 0) {
        showErrorMessage('Please select products first by checking the boxes on product cards');
        return;
    }

    const confirmed = confirm(`Start AI extraction for ${selectedProducts.length} selected products?\n\nThis will extract product information from supplier URLs.`);
    if (confirmed) {
        startBulkAIExtraction();
    }
}

function startBulkAIExtraction() {
    console.log(`🤖 Starting bulk AI extraction for ${selectedProducts.length} products`);

    showInfoMessage(`Starting AI extraction for ${selectedProducts.length} products...`);

    fetch(`/api/${COLLECTION_NAME}/process/extract`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            selected_rows: selectedProducts,
            overwrite_mode: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Bulk AI extraction successful:', data);
            showSuccessMessage(data.message);
            loadProductData();
        } else {
            console.error('❌ Bulk AI extraction failed:', data.message);
            showErrorMessage(`Bulk AI extraction failed: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('❌ Error during bulk AI extraction:', error);
        showErrorMessage(`Error during bulk AI extraction: ${error.message}`);
    });
}

function startDataCleaning() {
    if (selectedProducts.length === 0) {
        showErrorMessage('Please select products first by checking the boxes on product cards');
        return;
    }

    const confirmed = confirm(`Clean data for ${selectedProducts.length} selected products?\n\nThis will standardize and clean product information.`);
    if (!confirmed) return;

    console.log(`🧹 Starting bulk data cleaning for ${selectedProducts.length} products`);

    showInfoMessage(`Starting data cleaning for ${selectedProducts.length} products...`);

    fetch(`/api/${COLLECTION_NAME}/process/clean`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            selected_rows: selectedProducts
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Bulk data cleaning successful:', data);
            showSuccessMessage(data.message);
            loadProductData();
        } else {
            console.error('❌ Bulk data cleaning failed:', data.message);
            showErrorMessage(`Bulk data cleaning failed: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('❌ Error during bulk data cleaning:', error);
        showErrorMessage(`Error during bulk data cleaning: ${error.message}`);
    });
}

function generateBulkDescriptions() {
    if (selectedProducts.length === 0) {
        showErrorMessage('Please select products first by checking the boxes on product cards');
        return;
    }

    const confirmed = confirm(`Generate descriptions for ${selectedProducts.length} selected products?\n\nThis will create AI-generated product descriptions.`);
    if (!confirmed) return;

    console.log(`📝 Starting bulk description generation for ${selectedProducts.length} products`);

    showInfoMessage(`Starting description generation for ${selectedProducts.length} products...`);

    fetch(`/api/${COLLECTION_NAME}/process/descriptions`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            selected_rows: selectedProducts,
            use_url_content: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Bulk description generation successful:', data);
            showSuccessMessage(data.message);
            loadProductData();
        } else {
            console.error('❌ Bulk description generation failed:', data.message);
            showErrorMessage(`Bulk description generation failed: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('❌ Error during bulk description generation:', error);
        showErrorMessage(`Error during bulk description generation: ${error.message}`);
    });
}

function exportToCSV() {
    console.log('📁 Exporting to CSV...');

    const headers = ['Row', 'SKU', 'Title', 'Vendor', 'Quality Score'];
    const rows = [headers.join(',')];

    Object.keys(productsData).forEach(rowNum => {
        const product = productsData[rowNum];
        const row = [
            rowNum,
            `"${(product.variant_sku || '').replace(/"/g, '""')}"`,  // ✅ FIXED
            `"${(product.title || '').replace(/"/g, '""')}"`,
            `"${(product.vendor || '').replace(/"/g, '""')}"`,
            product.quality_score || 0
        ];
        rows.push(row.join(','));
    });

    const csvContent = rows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${COLLECTION_NAME}_export_${new Date().getISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    showSuccessMessage('CSV export completed!');
}

function showBulkEditModal() {
    if (selectedProducts.length === 0) {
        showErrorMessage('Please select products first by checking the boxes on product cards');
        return;
    }

    console.log('✏️ Show bulk edit modal');
    showInfoMessage(`Bulk edit modal for ${selectedProducts.length} products will be implemented soon!`);
}

function generateMissingReport() {
    console.log('📊 Generating quality report...');

    const totalProducts = Object.keys(productsData).length;
    let completeProducts = 0;
    let missingFields = {};

    Object.keys(productsData).forEach(rowNum => {
        const product = productsData[rowNum];
        const quality = product.quality_score || 0;

        if (quality >= 80) {
            completeProducts++;
        }

        const criticalFields = ['variant_sku', 'title', 'vendor'];  // ✅ FIXED
        criticalFields.forEach(field => {
            if (!product[field] || product[field].toString().trim() === '' || product[field] === '-') {
                missingFields[field] = (missingFields[field] || 0) + 1;
            }
        });
    });

    const report = [
        `📊 Data Quality Report for ${COLLECTION_NAME}`,
        ``,
        `Total Products: ${totalProducts}`,
        `Complete Products: ${completeProducts} (${Math.round(completeProducts/totalProducts*100)}%)`,
        `Incomplete Products: ${totalProducts - completeProducts}`,
        ``,
        `Missing Fields:`,
        ...Object.keys(missingFields).map(field => `  - ${field}: ${missingFields[field]} products missing`)
    ].join('\n');

    alert(report);
}

// ===============================
// HELPER FUNCTIONS
// ===============================

function loadSingleProductData(rowNum) {
    console.log(`🔄 Loading fresh product data for row ${rowNum}...`);

    fetch(`/api/${COLLECTION_NAME}/products/${rowNum}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`✅ Successfully loaded fresh data for product ${rowNum}:`, data.product);

                // Update card with complete fresh data
                updateProductCard(rowNum, data.product, false); // Don't merge, use fresh data

                console.log(`🎯 Product ${rowNum} card updated with:`, {
                    title: data.product.title,
                    image: data.product.shopify_images,
                    quality: data.product.quality_score,
                    sku: data.product.variant_sku
                });
            } else {
                console.error(`❌ Failed to load fresh data for product ${rowNum}:`, data.error);
                showErrorMessage(`Failed to refresh product data: ${data.error}`);
            }
        })
        .catch(error => {
            console.error(`❌ Error loading fresh data for product ${rowNum}:`, error);
            showErrorMessage(`Error refreshing product data: ${error.message}`);
        });
}


function loadProductIntoModal(rowNum) {
    console.log(`🔄 Reloading product ${rowNum} data into modal`);

    fetch(`/api/${COLLECTION_NAME}/products/${rowNum}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                productsData[rowNum] = data.product;
                populateBasicFields(data.product);
                populateDynamicFields(data.product, COLLECTION_NAME);
                updateProductImagePreview(data.product);
                console.log(`✅ Reloaded product ${rowNum} data into modal`);
            } else {
                console.error(`❌ Failed to reload product ${rowNum} data:`, data.error);
            }
        })
        .catch(error => {
            console.error(`❌ Error reloading product ${rowNum} data:`, error);
        });
}

// ===============================
// MESSAGE FUNCTIONS
// ===============================

function showSuccessMessage(message) {
    console.log('✅ ' + message);
    alert('✅ ' + message);
}

function showErrorMessage(message) {
    console.error('❌ ' + message);
    alert('❌ ' + message);
}

function showWarningMessage(message) {
    console.warn('⚠️ ' + message);
    alert('⚠️ ' + message);
}

function showInfoMessage(message) {
    console.info('ℹ️ ' + message);
    alert('ℹ️ ' + message);
}

// ===============================
// MAKE FUNCTIONS GLOBALLY AVAILABLE
// ===============================

// Override the existing placeholder functions
window.editProduct = editProduct;
window.extractFromURL = extractFromURL;
window.cleanProductData = cleanProductData;
window.generateDescription = generateDescription;
window.saveProductChanges = saveProductChanges;
window.testImageUrl = testImageUrl;
window.addProductManually = addProductManually;
window.addProductWithAI = addProductWithAI;
window.startBulkUpload = startBulkUpload;
window.extractSingleProductWithStatus = extractSingleProductWithStatus;
window.generateSingleDescription = generateSingleDescription;
window.cleanCurrentProductDataWithStatus = cleanCurrentProductDataWithStatus;
window.openCompareWindow = openCompareWindow;
window.refreshData = refreshData;
window.filterProducts = filterProducts;
window.showAIExtractionModal = showAIExtractionModal;
window.startDataCleaning = startDataCleaning;
window.generateBulkDescriptions = generateBulkDescriptions;
window.exportToCSV = exportToCSV;
window.showBulkEditModal = showBulkEditModal;
window.generateMissingReport = generateMissingReport;
window.addNewModalImageUrl = addNewModalImageUrl;
window.removeModalImageUrl = removeModalImageUrl;
window.handleModalImageUrlChange = handleModalImageUrlChange;
window.testModalImageUrl = testModalImageUrl;
window.navigateModalImage = navigateModalImage;
window.removeModalImageFromGallery = removeModalImageFromGallery;
window.initializeModalImageSystem = initializeModalImageSystem;
window.updateModalImageDisplay = updateModalImageDisplay;
window.updateModalFinalUrls = updateModalFinalUrls;

// Internal functions
window.resetModalForNewProduct = resetModalForNewProduct;
window.updateProductImagePreview = updateProductImagePreview;
window.generateDynamicFields = generateDynamicFields;
window.populateDynamicFields = populateDynamicFields;
window.getCollectionFieldConfig = getCollectionFieldConfig;

// Animation functions
window.startAIExtractionAnimation = startAIExtractionAnimation;
window.stopAIExtractionAnimation = stopAIExtractionAnimation;
window.showExtractionSuccess = showExtractionSuccess;
window.animateDescriptionGeneration = animateDescriptionGeneration;
window.showDescriptionSuccess = showDescriptionSuccess;
window.startCleaningAnimation = startCleaningAnimation;
window.showCleaningSuccess = showCleaningSuccess;

// Debug functions
window.testSaveSystem = testSaveSystem;
window.collectFormData = collectFormData;
window.showSyncIndicator = showSyncIndicator;
window.showSyncSuccess = showSyncSuccess;
window.showSyncError = showSyncError;
window.updateSelectionUI = updateSelectionUI;
window.addNewModalImageUrl = addNewModalImageUrl;
window.removeModalImageUrl = removeModalImageUrl;
window.handleModalImageUrlChange = handleModalImageUrlChange;
window.testModalImageUrl = testModalImageUrl;
window.autoAddEmptyFieldIfNeeded = autoAddEmptyFieldIfNeeded;
window.updateModalFinalUrls = updateModalFinalUrls;
window.showModalError = showModalError;
window.showModalSuccess = showModalSuccess;
window.clearModalMessages = clearModalMessages;
window.updateSelectedProductsWithBackend = updateSelectedProductsWithBackend;
window.testCheckboxSystem = testCheckboxSystem;
window.setupEventListeners = setupEventListeners;
window.cleanCurrentProductDataWithStatus = cleanCurrentProductDataWithStatus;
window.updateCheckboxAfterCleaning = updateCheckboxAfterCleaning;
window.validateSpecSheet = validateSpecSheet;
window.setSpecSheetStatus = setSpecSheetStatus;
window.currentProductData = productData;

console.log('✅ Complete checkbox functionality loaded!');


console.log('✅ Collection-agnostic edit functions with animations loaded successfully!');
console.log('✅ Complete checkbox functionality loaded!');
console.log('✅ Collection-agnostic edit functions with animations loaded successfully!');
  </script>
</body>
</html>
