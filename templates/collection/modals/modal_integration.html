<!-- Modal Integration Instructions -->
<!--
To integrate the new award-winning PIM modal design:

1. Update your main collection template to include the new CSS and JS files
2. Replace the old modal include with the new one
3. Update any JavaScript that populates the modal

Integration Steps:
-->

<!-- 1. Add to your main template <head> section -->
<link rel="stylesheet" href="/static/css/pim-modal-redesign.css">

<!-- 2. Add to your main template before closing </body> tag -->
<script src="/static/js/pim-modal-redesign.js"></script>

<!-- 3. Replace the old modal include in your sinks.html template -->
<!-- OLD: {% include "collection/modals/sinks_modal.html" %} -->
<!-- NEW: -->
{% include "collection/modals/sinks_modal_redesigned.html" %}

<!-- 4. Enhanced Modal Population Function -->
<script>
// Enhanced populateModalFields function that works with the new design
function populateModalFieldsEnhanced(data) {
    // Update product identity section
    const productTitle = document.getElementById('editProductTitle');
    const skuBadge = document.getElementById('modalSkuBadge');
    const productAvatar = document.getElementById('modalProductAvatar');

    if (productTitle) {
        productTitle.textContent = data.title || 'Unknown Product';
    }

    if (skuBadge) {
        skuBadge.textContent = `SKU: ${data.variant_sku || 'â€”'}`;
    }

    if (productAvatar && data.shopify_images) {
        const images = data.shopify_images.split(',');
        if (images[0]) {
            productAvatar.src = images[0].trim();
            productAvatar.style.display = 'block';
        }
    }

    // Populate all form fields (including the fixed FAQ field)
    const basicFields = [
        { id: 'editSku', value: data.variant_sku || '' },
        { id: 'editTitle', value: data.title || '' },
        { id: 'editVendor', value: data.vendor || '' },
        { id: 'editInstallationType', value: data.installation_type || '' },
        { id: 'editProductMaterial', value: data.product_material || '' },
        { id: 'editGradeOfMaterial', value: data.grade_of_material || '' },
        { id: 'editBrandName', value: data.brand_name || '' },
        { id: 'editStyle', value: data.style || '' },
        { id: 'editBowlsNumber', value: data.bowls_number || '' },
        { id: 'editFaucetHoles', value: data.tap_holes_number || '' },
        { id: 'editHasOverflow', value: data.has_overflow || '' },
        { id: 'editWarrantyYears', value: data.warranty_years || '' },
        { id: 'editWasteOutletDimensions', value: data.waste_outlet_dimensions || '' },
        { id: 'editDrainPosition', value: data.drain_position || '' },
        { id: 'editCutoutSizeMm', value: data.cutout_size_mm || '' },
        { id: 'editLengthMm', value: data.length_mm || '' },
        { id: 'editOverallWidthMm', value: data.overall_width_mm || '' },
        { id: 'editOverallDepthMm', value: data.overall_depth_mm || '' },
        { id: 'editMinCabinetSizeMm', value: data.min_cabinet_size_mm || '' },
        { id: 'editBowlWidthMm', value: data.bowl_width_mm || '' },
        { id: 'editBowlDepthMm', value: data.bowl_depth_mm || '' },
        { id: 'editBowlHeightMm', value: data.bowl_height_mm || '' },
        { id: 'editSecondBowlWidthMm', value: data.second_bowl_width_mm || '' },
        { id: 'editSecondBowlDepthMm', value: data.second_bowl_depth_mm || '' },
        { id: 'editSecondBowlHeightMm', value: data.second_bowl_height_mm || '' },
        { id: 'editApplicationLocation', value: data.application_location || '' },
        { id: 'editRrpPrice', value: data.shopify_compare_price || '' },
        { id: 'editSalePrice', value: data.shopify_price || '' },
        { id: 'editWeight', value: data.shopify_weight || '' },
        { id: 'editTags', value: data.shopify_tags || '' },
        { id: 'editSeoTitle', value: data.seo_title || '' },
        { id: 'editSeoDescription', value: data.seo_description || '' },
        { id: 'editBodyHtml', value: data.body_html || '' },
        { id: 'editFeatures', value: data.features || '' },
        { id: 'editCareInstructions', value: data.care_instructions || '' },
        { id: 'editFaqs', value: data.faqs || '' }, // FAQ field is now included!
        { id: 'editShopifySpecSheet', value: data.shopify_spec_sheet || '' }
    ];

    // Populate fields with enhanced feedback
    basicFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            element.value = field.value;

            // Trigger validation and progress tracking
            if (window.pimModal && typeof window.pimModal.handleFieldChange === 'function') {
                window.pimModal.handleFieldChange(element);
            }
        }
    });

    // Update quick stats
    updateQuickStats(data);
}

function updateQuickStats(data) {
    // Calculate data completion
    const totalFields = 25; // Approximate total important fields
    let completedFields = 0;

    ['variant_sku', 'title', 'vendor', 'installation_type', 'product_material',
     'length_mm', 'overall_width_mm', 'overall_depth_mm', 'body_html', 'features'].forEach(field => {
        if (data[field] && data[field].toString().trim()) {
            completedFields++;
        }
    });

    const completion = Math.round((completedFields / 10) * 100);

    const dataCompletionEl = document.getElementById('dataCompletion');
    if (dataCompletionEl) {
        dataCompletionEl.textContent = `${completion}%`;
    }

    // Update media count
    const mediaCountEl = document.getElementById('mediaCount');
    if (mediaCountEl && data.shopify_images) {
        const imageCount = data.shopify_images.split(',').filter(img => img.trim()).length;
        mediaCountEl.textContent = imageCount.toString();
    }

    // Update last updated
    const lastUpdatedEl = document.getElementById('lastUpdated');
    if (lastUpdatedEl) {
        lastUpdatedEl.textContent = '2h ago'; // This would come from actual data
    }
}

// Override the original populateModalFields function
if (typeof populateModalFields !== 'undefined') {
    window.originalPopulateModalFields = populateModalFields;
}

window.populateModalFields = populateModalFieldsEnhanced;

// Add keyboard shortcuts info
function showShortcutsHelp() {
    const helpContent = `
        <div class="shortcuts-help">
            <h4>Keyboard Shortcuts</h4>
            <div class="shortcut-list">
                <div class="shortcut-item">
                    <kbd>Ctrl + S</kbd>
                    <span>Save Product</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Ctrl + Shift + A</kbd>
                    <span>Quick AI Enhancement</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Ctrl + 1-6</kbd>
                    <span>Switch Sections</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Esc</kbd>
                    <span>Close Modal</span>
                </div>
            </div>
        </div>
    `;

    // You could integrate this with your existing help system
    console.log('Keyboard shortcuts available:', helpContent);
}

// Enhanced functions for better UX
function optimizeSEO() {
    const title = document.getElementById('editTitle').value;
    const description = document.getElementById('editBodyHtml').value;

    if (!title) {
        alert('Please enter a product title first');
        return;
    }

    // Generate SEO suggestions
    const seoTitleField = document.getElementById('editSeoTitle');
    const seoDescField = document.getElementById('editSeoDescription');

    if (!seoTitleField.value) {
        seoTitleField.value = `${title} | Premium Quality | Cass Brothers`.substring(0, 60);
    }

    if (!seoDescField.value && description) {
        const plainText = description.replace(/<[^>]*>/g, '').substring(0, 150);
        seoDescField.value = plainText + '...';
    }

    // Update character counters
    if (window.pimModal && typeof window.pimModal.updateCharCounter === 'function') {
        window.pimModal.updateCharCounter('seoTitleCount', seoTitleField.value, 60);
        window.pimModal.updateCharCounter('seoDescCount', seoDescField.value, 160);
    }

    if (window.pimModal && typeof window.pimModal.showSuccessMessage === 'function') {
        window.pimModal.showSuccessMessage('SEO fields optimized!');
    }
}

function validateProductData() {
    if (window.pimModal && typeof window.pimModal.validateAllFields === 'function') {
        const isValid = window.pimModal.validateAllFields();
        if (isValid) {
            if (typeof window.pimModal.showSuccessMessage === 'function') {
                window.pimModal.showSuccessMessage('All product data is valid!');
            }
        } else {
            if (typeof window.pimModal.showErrorMessage === 'function') {
                window.pimModal.showErrorMessage('Please fix validation errors');
            }
        }
    }
}

function duplicateProduct() {
    if (confirm('Create a duplicate of this product?')) {
        // This would integrate with your existing product duplication logic
        if (window.pimModal && typeof window.pimModal.showSuccessMessage === 'function') {
            window.pimModal.showSuccessMessage('Product duplicated successfully!');
        }
    }
}

function exportProductData() {
    // Export current product data as JSON
    const formData = new FormData(document.getElementById('editProductForm'));
    const productData = Object.fromEntries(formData.entries());

    const dataStr = JSON.stringify(productData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `product-${productData.editSku || 'unknown'}.json`;
    link.click();

    if (window.pimModal && typeof window.pimModal.showSuccessMessage === 'function') {
        window.pimModal.showSuccessMessage('Product data exported!');
    }
}

function deleteProduct() {
    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        // This would integrate with your existing product deletion logic
        alert('Product deletion would be handled by your existing backend logic');
    }
}

// Insert HTML tags for rich text editing
function insertHtmlTag(tag) {
    const textarea = document.getElementById('editBodyHtml');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const before = text.substring(0, start);
    const selected = text.substring(start, end);
    const after = text.substring(end);

    let newText;
    if (tag === 'ul') {
        newText = before + `<ul>\n  <li>${selected || 'List item'}</li>\n</ul>` + after;
    } else if (tag === 'p') {
        newText = before + `<p>${selected || 'Paragraph text'}</p>` + after;
    } else {
        newText = before + `<${tag}>${selected || 'Text'}</${tag}>` + after;
    }

    textarea.value = newText;
    textarea.focus();

    if (window.pimModal && typeof window.pimModal.handleFieldChange === 'function') {
        window.pimModal.handleFieldChange(textarea);
    }
}

function previewDescription() {
    const description = document.getElementById('editBodyHtml').value;
    if (!description) {
        alert('No description to preview');
        return;
    }

    const previewWindow = window.open('', '_blank', 'width=600,height=400');
    previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Description Preview</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                h1, h2, h3 { color: #333; }
                ul, ol { padding-left: 20px; }
            </style>
        </head>
        <body>
            <h1>Product Description Preview</h1>
            <div>${description}</div>
        </body>
        </html>
    `);
    previewWindow.document.close();
}

// Calculate dimensions helper
function calculateDimensions() {
    const length = parseFloat(document.getElementById('editLengthMm').value) || 0;
    const width = parseFloat(document.getElementById('editOverallWidthMm').value) || 0;
    const depth = parseFloat(document.getElementById('editOverallDepthMm').value) || 0;

    if (length && width && depth) {
        const volume = (length * width * depth) / 1000000; // Convert mmÂ³ to liters

        if (window.pimModal && typeof window.pimModal.showSuccessMessage === 'function') {
            window.pimModal.showSuccessMessage(`Calculated volume: ${volume.toFixed(2)} liters`);
        }

        // Auto-suggest minimum cabinet size (add 50mm on each side)
        const minCabinetField = document.getElementById('editMinCabinetSizeMm');
        if (minCabinetField && !minCabinetField.value) {
            minCabinetField.value = Math.round(width + 100); // Add 50mm on each side
        }
    } else {
        alert('Please enter length, width, and depth to calculate dimensions');
    }
}

// Auto-populate care instructions based on material
function generateBasicInfo() {
    const title = document.getElementById('editTitle').value;
    const material = document.getElementById('editProductMaterial').value;

    if (!title) {
        alert('Please enter a product title first');
        return;
    }

    // Auto-generate SKU if empty
    const skuField = document.getElementById('editSku');
    if (!skuField.value) {
        const sku = title.replace(/[^a-zA-Z0-9]/g, '').substring(0, 10).toUpperCase();
        skuField.value = sku;
    }

    if (window.pimModal && typeof window.pimModal.showSuccessMessage === 'function') {
        window.pimModal.showSuccessMessage('Basic information enhanced!');
    }
}

console.log('ðŸŽ‰ Award-winning PIM Modal integration ready!');
console.log('ðŸ“– Use Ctrl+? to see keyboard shortcuts');
</script>

<!-- 5. CSS Enhancements for better integration -->
<style>
/* Additional integration styles */
.shortcuts-help {
    background: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    max-width: 400px;
}

.shortcuts-help h4 {
    margin: 0 0 1rem 0;
    color: #1e293b;
}

.shortcut-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.shortcut-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: #f8fafc;
    border-radius: 0.375rem;
}

.shortcut-item kbd {
    background: #374151;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-family: monospace;
}

/* Smooth transition for modal replacement */
.edit-modal {
    transition: all 0.3s ease;
}

/* Enhanced focus states for accessibility */
.pim-modal .form-control:focus {
    outline: 2px solid #2563eb;
    outline-offset: 2px;
}

/* Print-friendly styles */
@media print {
    .pim-modal-header,
    .pim-modal-footer,
    .header-actions,
    .card-action,
    .action-btn {
        display: none !important;
    }

    .pim-modal-content {
        height: auto !important;
        overflow: visible !important;
    }

    .content-section {
        display: block !important;
        page-break-inside: avoid;
    }
}
</style>