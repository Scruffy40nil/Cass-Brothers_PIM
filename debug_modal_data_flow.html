<!DOCTYPE html>
<html>
<head>
    <title>Debug Modal Data Flow</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Debug Modal Data Flow</h1>

    <button onclick="testDataFlow()">Test Data Flow</button>
    <button onclick="testAPICall()">Test API Call</button>
    <button onclick="testProductsData()">Test ProductsData</button>

    <div id="results" style="background: #f0f0f0; padding: 20px; margin: 20px 0; white-space: pre-wrap; font-family: monospace;"></div>

    <script>
        function log(message) {
            document.getElementById('results').textContent += message + '\n';
            console.log(message);
        }

        function clearLog() {
            document.getElementById('results').textContent = '';
        }

        async function testAPICall() {
            clearLog();
            log('üîÑ Testing API call to /api/sinks/products/all...');

            try {
                const response = await fetch('/api/sinks/products/all');
                const data = await response.json();

                log(`‚úÖ API Response Status: ${response.status}`);
                log(`üìä Products Count: ${Object.keys(data).length}`);

                if (Object.keys(data).length > 0) {
                    const firstProduct = Object.values(data)[0];
                    log('\nüìã First Product Sample:');
                    log(`  Title: ${firstProduct.title || 'N/A'}`);
                    log(`  SKU: ${firstProduct.variant_sku || 'N/A'}`);
                    log(`  Installation Type: ${firstProduct.installation_type || 'N/A'}`);
                    log(`  Material: ${firstProduct.product_material || 'N/A'}`);
                    log(`  Has Overflow: ${firstProduct.has_overflow || 'N/A'}`);
                    log(`  Cutout Size: ${firstProduct.cutout_size_mm || 'N/A'}`);
                } else {
                    log('‚ùå No products returned from API');
                }

            } catch (error) {
                log(`‚ùå API Error: ${error.message}`);
            }
        }

        async function testProductsData() {
            clearLog();
            log('üîÑ Testing window.productsData...');

            if (typeof window.productsData === 'undefined') {
                log('‚ùå window.productsData is undefined');
                log('üîÑ Attempting to load via loadProductsData()...');

                if (typeof window.loadProductsData === 'function') {
                    try {
                        await window.loadProductsData();
                        log('‚úÖ loadProductsData() completed');

                        if (window.productsData) {
                            log(`üìä Products loaded: ${Object.keys(window.productsData).length}`);

                            if (Object.keys(window.productsData).length > 0) {
                                const firstRow = Object.keys(window.productsData)[0];
                                const firstProduct = window.productsData[firstRow];
                                log(`\nüìã First Product (Row ${firstRow}):`);
                                log(`  Title: ${firstProduct.title || 'N/A'}`);
                                log(`  Installation Type: ${firstProduct.installation_type || 'N/A'}`);
                                log(`  Material: ${firstProduct.product_material || 'N/A'}`);
                                log(`  Has Overflow: ${firstProduct.has_overflow || 'N/A'}`);
                                log(`  Cutout Size: ${firstProduct.cutout_size_mm || 'N/A'}`);
                            }
                        } else {
                            log('‚ùå productsData still undefined after loadProductsData()');
                        }
                    } catch (error) {
                        log(`‚ùå Error calling loadProductsData(): ${error.message}`);
                    }
                } else {
                    log('‚ùå loadProductsData function not found');
                }
            } else {
                log(`‚úÖ window.productsData exists with ${Object.keys(window.productsData).length} products`);

                if (Object.keys(window.productsData).length > 0) {
                    const firstRow = Object.keys(window.productsData)[0];
                    const firstProduct = window.productsData[firstRow];
                    log(`\nüìã First Product (Row ${firstRow}):`);
                    log(`  Title: ${firstProduct.title || 'N/A'}`);
                    log(`  Installation Type: ${firstProduct.installation_type || 'N/A'}`);
                    log(`  Material: ${firstProduct.product_material || 'N/A'}`);
                    log(`  Has Overflow: ${firstProduct.has_overflow || 'N/A'}`);
                    log(`  Cutout Size: ${firstProduct.cutout_size_mm || 'N/A'}`);
                }
            }
        }

        async function testDataFlow() {
            clearLog();
            log('üîÑ Testing complete data flow...');

            // Test 1: API Call
            log('\n=== TEST 1: API Call ===');
            await testAPICall();

            // Test 2: ProductsData
            log('\n=== TEST 2: ProductsData ===');
            await testProductsData();

            // Test 3: Modal Function
            log('\n=== TEST 3: Modal Function ===');
            if (typeof window.editProduct === 'function') {
                log('‚úÖ editProduct function exists');

                // Test if modal element exists
                const modal = document.getElementById('editProductModal');
                if (modal) {
                    log('‚úÖ editProductModal element found');
                } else {
                    log('‚ùå editProductModal element NOT found');
                }

                // Test populateCollectionSpecificFields
                if (typeof window.populateCollectionSpecificFields === 'function') {
                    log('‚úÖ populateCollectionSpecificFields function exists');
                } else {
                    log('‚ùå populateCollectionSpecificFields function NOT found');
                }

            } else {
                log('‚ùå editProduct function not found');
            }

            log('\n=== SUMMARY ===');
            log('Check the results above to identify where the data flow breaks.');
        }
    </script>
</body>
</html>